6bfa63fe0bb47d9cd70cc3a0e248967b
'use strict';require('ts-jest').install("/c/Users/Sandro/repo/amplify-cli/packages/amplify-graphql-types-generator/src/angular/index.ts", "\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst graphql_1 = require(\"graphql\");\nconst prettier = require(\"prettier\");\nconst CodeGenerator_1 = require(\"../utilities/CodeGenerator\");\nconst codeGeneration_1 = require(\"../typescript/codeGeneration\");\nconst types_1 = require(\"../typescript/types\");\nfunction generateSource(context) {\n    const generator = new CodeGenerator_1.default(context);\n    generator.printOnNewline('/* tslint:disable */');\n    generator.printOnNewline('//  This file was automatically generated and should not be edited.');\n    generator.printOnNewline(`import { Injectable } from '@angular/core';`);\n    generator.printOnNewline(`import API, { graphqlOperation } from '@aws-amplify/api';`);\n    generator.printOnNewline(`import { GraphQLResult } from \"@aws-amplify/api/lib/types\";`);\n    generator.printOnNewline(`import * as Observable from 'zen-observable';`);\n    generator.printNewline();\n    generateTypes(generator, context);\n    generator.printNewline();\n    generateAngularService(generator, context);\n    return prettier.format(generator.output, { parser: 'typescript' });\n}\nexports.generateSource = generateSource;\nfunction generateTypes(generator, context) {\n    context.typesUsed.forEach(type => codeGeneration_1.typeDeclarationForGraphQLType(generator, type));\n    Object.values(context.operations).forEach(operation => {\n        const resultField = getOperationResultField(operation);\n        codeGeneration_1.interfaceDeclarationForOperation(generator, Object.assign({}, operation, { fields: resultField ? resultField.fields || [] : operation.fields }));\n    });\n    Object.values(context.fragments).forEach(operation => codeGeneration_1.interfaceDeclarationForFragment(generator, operation));\n}\nfunction getOperationResultField(operation) {\n    if (operation.fields.length && operation.fields[0].fields) {\n        return operation.fields[0];\n    }\n}\nfunction generateAngularService(generator, context) {\n    const operations = context.operations;\n    generator.printOnNewline(`@Injectable({\n    providedIn: 'root'\n  })`);\n    generator.printOnNewline(`export class APIService {`);\n    generator.withIndent(() => {\n        Object.values(operations).forEach((op) => {\n            if (op.operationType === 'subscription') {\n                return generateSubscriptionOperation(generator, op);\n            }\n            if (op.operationType === 'query' || op.operationType === 'mutation') {\n                return generateQueryOrMutationOperation(generator, op);\n            }\n        });\n        generator.printOnNewline('}');\n    });\n}\nfunction generateSubscriptionOperation(generator, op) {\n    const statement = formatTemplateString(generator, op.source);\n    const { operationName, operationType } = op;\n    const returnType = codeGeneration_1.interfaceNameFromOperation({ operationName, operationType });\n    generator.printNewline();\n    const subscriptionName = `${operationName}Listener`;\n    generator.print(`${subscriptionName}: Observable<${returnType}> = API.graphql(graphqlOperation(\\n\\`${statement}\\`)) as Observable<${returnType}>`);\n    generator.printNewline();\n}\nfunction generateQueryOrMutationOperation(generator, op) {\n    const statement = formatTemplateString(generator, op.source);\n    const { operationName, operationType } = op;\n    const vars = variablesFromField(generator.context, op.variables);\n    const returnType = codeGeneration_1.interfaceNameFromOperation({ operationName, operationType });\n    const resultField = getOperationResultField(op);\n    const resultProp = resultField ? `.${resultField.responseName}` : '';\n    generator.printNewline();\n    generator.print(`async ${op.operationName}(`);\n    variableDeclaration(generator, vars);\n    generator.print(`) : Promise<${returnType}> {`);\n    generator.withIndent(() => {\n        generator.printNewlineIfNeeded();\n        generator.print(`const statement = \\`${statement}\\``);\n        const params = ['statement'];\n        if (op.variables.length) {\n            variableAssignmentToInput(generator, vars);\n            params.push('gqlAPIServiceArguments');\n        }\n        generator.printOnNewline(`const response = await API.graphql(graphqlOperation(${params.join(', ')})) as any;`);\n        generator.printOnNewline(`return (<${returnType}>response.data${resultProp})`);\n    });\n    generator.printOnNewline('}');\n}\nfunction variablesFromField(context, fields) {\n    return fields.map(field => propertyFromVar(context, field));\n}\nexports.variablesFromField = variablesFromField;\nfunction propertyFromVar(context, field) {\n    let { name: fieldName, type: fieldType } = field;\n    fieldName = fieldName || field.responseName;\n    const propertyName = fieldName;\n    let property = { fieldName, fieldType, propertyName };\n    let isNullable = true;\n    if (fieldType instanceof graphql_1.GraphQLNonNull) {\n        isNullable = false;\n    }\n    const typeName = types_1.typeNameFromGraphQLType(context, fieldType, null, false);\n    return Object.assign({}, property, { typeName, isComposite: false, fieldType, isNullable });\n}\nexports.propertyFromVar = propertyFromVar;\nfunction variableDeclaration(generator, properties) {\n    properties\n        .sort((a, b) => {\n        if (!a.isNullable && b.isNullable) {\n            return -1;\n        }\n        if (!b.isNullable && a.isNullable) {\n            return 1;\n        }\n        return 0;\n    })\n        .forEach(property => {\n        const { fieldName, typeName, isArray, isNullable } = property;\n        generator.print(fieldName);\n        if (isNullable) {\n            generator.print('?');\n        }\n        generator.print(':');\n        if (isArray) {\n            generator.print(' Array<');\n        }\n        generator.print(`${typeName}`);\n        if (isArray) {\n            generator.print('>');\n        }\n        generator.print(', ');\n    });\n}\nfunction variableAssignmentToInput(generator, vars) {\n    if (vars.length > 0) {\n        generator.printOnNewline('const gqlAPIServiceArguments : any = ');\n        generator.withinBlock(() => {\n            vars.filter(v => !v.isNullable).forEach(v => {\n                generator.printOnNewline(`${v.fieldName},`);\n            });\n        }, '{', '}');\n        vars.filter(v => v.isNullable).forEach(v => {\n            generator.printOnNewline(`if (${v.fieldName}) `);\n            generator.withinBlock(() => {\n                generator.printOnNewline(`gqlAPIServiceArguments.${v.fieldName} = ${v.fieldName}`);\n            }, '{', '}');\n        });\n    }\n}\nfunction formatTemplateString(generator, str) {\n    const indentation = ' '.repeat(generator.currentFile.indentWidth * (generator.currentFile.indentLevel + 2));\n    return str\n        .split('\\n')\n        .map((line, idx) => (idx > 0 ? indentation + line : line))\n        .join('\\n');\n}\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzRDtBQUN0RCxxQ0FBcUM7QUFRckMsOERBQXVEO0FBQ3ZELGlFQUtzQztBQUN0QywrQ0FBOEQ7QUFHOUQsd0JBQStCLE9BQThCO0lBQzNELE1BQU0sU0FBUyxHQUFHLElBQUksdUJBQWEsQ0FBd0IsT0FBTyxDQUFDLENBQUM7SUFFcEUsU0FBUyxDQUFDLGNBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ2pELFNBQVMsQ0FBQyxjQUFjLENBQUMscUVBQXFFLENBQUMsQ0FBQztJQUVoRyxTQUFTLENBQUMsY0FBYyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7SUFDeEUsU0FBUyxDQUFDLGNBQWMsQ0FBQywyREFBMkQsQ0FBQyxDQUFDO0lBQ3RGLFNBQVMsQ0FBQyxjQUFjLENBQUMsNkRBQTZELENBQUMsQ0FBQztJQUV4RixTQUFTLENBQUMsY0FBYyxDQUFDLCtDQUErQyxDQUFDLENBQUM7SUFDMUUsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBRXpCLGFBQWEsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbEMsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBRXpCLHNCQUFzQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMzQyxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQ3JFLENBQUM7QUFsQkQsd0NBa0JDO0FBRUQsdUJBQXVCLFNBQXdCLEVBQUUsT0FBOEI7SUFDN0UsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyw4Q0FBNkIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUVsRixNQUFNLENBQUMsTUFBTSxDQUFDLE9B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QUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3pDLFNBQVMsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQztZQUNqRCxTQUFTLENBQUMsV0FBVyxDQUNuQixHQUFHLEVBQUU7Z0JBQ0gsU0FBUyxDQUFDLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLFNBQVMsTUFBTSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztZQUNyRixDQUFDLEVBQ0QsR0FBRyxFQUNILEdBQUcsQ0FDSixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7S0FDSjtBQUNILENBQUM7QUFFRCw4QkFBOEIsU0FBd0IsRUFBRSxHQUFXO0lBQ2pFLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQzVCLFNBQVMsQ0FBQyxXQUFXLENBQUMsV0FBVyxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQzVFLENBQUM7SUFDRixPQUFPLEdBQUc7U0FDUCxLQUFLLENBQUMsSUFBSSxDQUFDO1NBQ1gsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdyYXBoUUxOb25OdWxsLCBHcmFwaFFMVHlwZSB9IGZyb20gJ2dyYXBocWwnO1xuaW1wb3J0ICogYXMgcHJldHRpZXIgZnJvbSAncHJldHRpZXInO1xuaW1wb3J0IHtcbiAgTGVnYWN5Q29tcGlsZXJDb250ZXh0LFxuICBMZWdhY3lPcGVyYXRpb24sXG4gIExlZ2FjeUlubGluZUZyYWdtZW50LFxuICBMZWdhY3lGaWVsZFxufSBmcm9tICcuLi9jb21waWxlci9sZWdhY3lJUic7XG5cbmltcG9ydCBDb2RlR2VuZXJhdG9yIGZyb20gJy4uL3V0aWxpdGllcy9Db2RlR2VuZXJhdG9yJztcbmltcG9ydCB7XG4gIHR5cGVEZWNsYXJhdGlvbkZvckdyYXBoUUxUeXBlLFxuICBpbnRlcmZhY2VEZWNsYXJhdGlvbkZvck9wZXJhdGlvbixcbiAgaW50ZXJmYWNlRGVjbGFyYXRpb25Gb3JGcmFnbWVudCxcbiAgaW50ZXJmYWNlTmFtZUZyb21PcGVyYXRpb25cbn0gZnJvbSAnLi4vdHlwZXNjcmlwdC9jb2RlR2VuZXJhdGlvbic7XG5pbXBvcnQgeyB0eXBlTmFtZUZyb21HcmFwaFFMVHlwZSB9IGZyb20gJy4uL3R5cGVzY3JpcHQvdHlwZXMnO1xuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tICcuLi90eXBlc2NyaXB0L2xhbmd1YWdlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlU291cmNlKGNvbnRleHQ6IExlZ2FjeUNvbXBpbGVyQ29udGV4dCkge1xuICBjb25zdCBnZW5lcmF0b3IgPSBuZXcgQ29kZUdlbmVyYXRvcjxMZWdhY3lDb21waWxlckNvbnRleHQ+KGNvbnRleHQpO1xuXG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgnLyogdHNsaW50OmRpc2FibGUgKi8nKTtcbiAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCcvLyAgVGhpcyBmaWxlIHdhcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBlZGl0ZWQuJyk7XG5cbiAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7YCk7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaW1wb3J0IEFQSSwgeyBncmFwaHFsT3BlcmF0aW9uIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2FwaSc7YCk7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaW1wb3J0IHsgR3JhcGhRTFJlc3VsdCB9IGZyb20gXCJAYXdzLWFtcGxpZnkvYXBpL2xpYi90eXBlc1wiO2ApO1xuXG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaW1wb3J0ICogYXMgT2JzZXJ2YWJsZSBmcm9tICd6ZW4tb2JzZXJ2YWJsZSc7YCk7XG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcblxuICBnZW5lcmF0ZVR5cGVzKGdlbmVyYXRvciwgY29udGV4dCk7XG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcblxuICBnZW5lcmF0ZUFuZ3VsYXJTZXJ2aWNlKGdlbmVyYXRvciwgY29udGV4dCk7XG4gIHJldHVybiBwcmV0dGllci5mb3JtYXQoZ2VuZXJhdG9yLm91dHB1dCwgeyBwYXJzZXI6ICd0eXBlc2NyaXB0JyB9KTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVUeXBlcyhnZW5lcmF0b3I6IENvZGVHZW5lcmF0b3IsIGNvbnRleHQ6IExlZ2FjeUNvbXBpbGVyQ29udGV4dCkge1xuICBjb250ZXh0LnR5cGVzVXNlZC5mb3JFYWNoKHR5cGUgPT4gdHlwZURlY2xhcmF0aW9uRm9yR3JhcGhRTFR5cGUoZ2VuZXJhdG9yLCB0eXBlKSk7XG5cbiAgT2JqZWN0LnZhbHVlcyhjb250ZXh0Lm9wZXJhdGlvbnMpLmZvckVhY2gob3BlcmF0aW9uID0+IHtcbiAgICBjb25zdCByZXN1bHRGaWVsZCA9IGdldE9wZXJhdGlvblJlc3VsdEZpZWxkKG9wZXJhdGlvbik7XG4gICAgaW50ZXJmYWNlRGVjbGFyYXRpb25Gb3JPcGVyYXRpb24oZ2VuZXJhdG9yLCB7XG4gICAgICAuLi5vcGVyYXRpb24sXG4gICAgICBmaWVsZHM6IHJlc3VsdEZpZWxkID8gcmVzdWx0RmllbGQuZmllbGRzIHx8IFtdIDogb3BlcmF0aW9uLmZpZWxkc1xuICAgIH0pO1xuICB9KTtcblxuICBPYmplY3QudmFsdWVzKGNvbnRleHQuZnJhZ21lbnRzKS5mb3JFYWNoKG9wZXJhdGlvbiA9PlxuICAgIGludGVyZmFjZURlY2xhcmF0aW9uRm9yRnJhZ21lbnQoZ2VuZXJhdG9yLCBvcGVyYXRpb24pXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldE9wZXJhdGlvblJlc3VsdEZpZWxkKG9wZXJhdGlvbjogTGVnYWN5T3BlcmF0aW9uKTogTGVnYWN5RmllbGQgfCB2b2lkIHtcbiAgaWYgKG9wZXJhdGlvbi5maWVsZHMubGVuZ3RoICYmIG9wZXJhdGlvbi5maWVsZHNbMF0uZmllbGRzKSB7XG4gICAgcmV0dXJuIG9wZXJhdGlvbi5maWVsZHNbMF07XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVBbmd1bGFyU2VydmljZShnZW5lcmF0b3I6IENvZGVHZW5lcmF0b3IsIGNvbnRleHQ6IExlZ2FjeUNvbXBpbGVyQ29udGV4dCkge1xuICBjb25zdCBvcGVyYXRpb25zID0gY29udGV4dC5vcGVyYXRpb25zO1xuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYEBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbiAgfSlgKTtcbiAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBleHBvcnQgY2xhc3MgQVBJU2VydmljZSB7YCk7XG5cbiAgZ2VuZXJhdG9yLndpdGhJbmRlbnQoKCkgPT4ge1xuICAgIE9iamVjdC52YWx1ZXMob3BlcmF0aW9ucykuZm9yRWFjaCgob3A6IExlZ2FjeU9wZXJhdGlvbikgPT4ge1xuICAgICAgaWYgKG9wLm9wZXJhdGlvblR5cGUgPT09ICdzdWJzY3JpcHRpb24nKSB7XG4gICAgICAgIHJldHVybiBnZW5lcmF0ZVN1YnNjcmlwdGlvbk9wZXJhdGlvbihnZW5lcmF0b3IsIG9wKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcC5vcGVyYXRpb25UeXBlID09PSAncXVlcnknIHx8IG9wLm9wZXJhdGlvblR5cGUgPT09ICdtdXRhdGlvbicpIHtcbiAgICAgICAgcmV0dXJuIGdlbmVyYXRlUXVlcnlPck11dGF0aW9uT3BlcmF0aW9uKGdlbmVyYXRvciwgb3ApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgnfScpO1xuICB9KTtcbn1cbmZ1bmN0aW9uIGdlbmVyYXRlU3Vic2NyaXB0aW9uT3BlcmF0aW9uKGdlbmVyYXRvcjogQ29kZUdlbmVyYXRvciwgb3A6IExlZ2FjeU9wZXJhdGlvbikge1xuICBjb25zdCBzdGF0ZW1lbnQgPSBmb3JtYXRUZW1wbGF0ZVN0cmluZyhnZW5lcmF0b3IsIG9wLnNvdXJjZSk7XG4gIGNvbnN0IHsgb3BlcmF0aW9uTmFtZSwgb3BlcmF0aW9uVHlwZSB9ID0gb3A7XG4gIGNvbnN0IHJldHVyblR5cGUgPSBpbnRlcmZhY2VOYW1lRnJvbU9wZXJhdGlvbih7IG9wZXJhdGlvbk5hbWUsIG9wZXJhdGlvblR5cGUgfSk7XG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcbiAgY29uc3Qgc3Vic2NyaXB0aW9uTmFtZSA9IGAke29wZXJhdGlvbk5hbWV9TGlzdGVuZXJgO1xuICBnZW5lcmF0b3IucHJpbnQoXG4gICAgYCR7c3Vic2NyaXB0aW9uTmFtZX06IE9ic2VydmFibGU8JHtyZXR1cm5UeXBlfT4gPSBBUEkuZ3JhcGhxbChncmFwaHFsT3BlcmF0aW9uKFxcblxcYCR7c3RhdGVtZW50fVxcYCkpIGFzIE9ic2VydmFibGU8JHtyZXR1cm5UeXBlfT5gXG4gICk7XG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVRdWVyeU9yTXV0YXRpb25PcGVyYXRpb24oZ2VuZXJhdG9yOiBDb2RlR2VuZXJhdG9yLCBvcDogTGVnYWN5T3BlcmF0aW9uKSB7XG4gIGNvbnN0IHN0YXRlbWVudCA9IGZvcm1hdFRlbXBsYXRlU3RyaW5nKGdlbmVyYXRvciwgb3Auc291cmNlKTtcbiAgY29uc3QgeyBvcGVyYXRpb25OYW1lLCBvcGVyYXRpb25UeXBlIH0gPSBvcDtcbiAgY29uc3QgdmFycyA9IHZhcmlhYmxlc0Zyb21GaWVsZChnZW5lcmF0b3IuY29udGV4dCwgb3AudmFyaWFibGVzKTtcbiAgY29uc3QgcmV0dXJuVHlwZSA9IGludGVyZmFjZU5hbWVGcm9tT3BlcmF0aW9uKHsgb3BlcmF0aW9uTmFtZSwgb3BlcmF0aW9uVHlwZSB9KTtcbiAgY29uc3QgcmVzdWx0RmllbGQgPSBnZXRPcGVyYXRpb25SZXN1bHRGaWVsZChvcCk7XG4gIGNvbnN0IHJlc3VsdFByb3AgPSByZXN1bHRGaWVsZCA/IGAuJHtyZXN1bHRGaWVsZC5yZXNwb25zZU5hbWV9YCA6ICcnO1xuXG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcbiAgZ2VuZXJhdG9yLnByaW50KGBhc3luYyAke29wLm9wZXJhdGlvbk5hbWV9KGApO1xuICB2YXJpYWJsZURlY2xhcmF0aW9uKGdlbmVyYXRvciwgdmFycyk7XG4gIGdlbmVyYXRvci5wcmludChgKSA6IFByb21pc2U8JHtyZXR1cm5UeXBlfT4ge2ApO1xuICBnZW5lcmF0b3Iud2l0aEluZGVudCgoKSA9PiB7XG4gICAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG4gICAgZ2VuZXJhdG9yLnByaW50KGBjb25zdCBzdGF0ZW1lbnQgPSBcXGAke3N0YXRlbWVudH1cXGBgKTtcbiAgICBjb25zdCBwYXJhbXMgPSBbJ3N0YXRlbWVudCddO1xuICAgIGlmIChvcC52YXJpYWJsZXMubGVuZ3RoKSB7XG4gICAgICB2YXJpYWJsZUFzc2lnbm1lbnRUb0lucHV0KGdlbmVyYXRvciwgdmFycyk7XG4gICAgICBwYXJhbXMucHVzaCgnZ3FsQVBJU2VydmljZUFyZ3VtZW50cycpO1xuICAgIH1cbiAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoXG4gICAgICBgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBBUEkuZ3JhcGhxbChncmFwaHFsT3BlcmF0aW9uKCR7cGFyYW1zLmpvaW4oJywgJyl9KSkgYXMgYW55O2BcbiAgICApO1xuICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgcmV0dXJuICg8JHtyZXR1cm5UeXBlfT5yZXNwb25zZS5kYXRhJHtyZXN1bHRQcm9wfSlgKTtcbiAgfSk7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgnfScpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFyaWFibGVzRnJvbUZpZWxkKFxuICBjb250ZXh0OiBMZWdhY3lDb21waWxlckNvbnRleHQsXG4gIGZpZWxkczoge1xuICAgIG5hbWU/OiBzdHJpbmc7XG4gICAgdHlwZTogR3JhcGhRTFR5cGU7XG4gICAgcmVzcG9uc2VOYW1lPzogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIGZyYWdtZW50U3ByZWFkcz86IGFueTtcbiAgICBpbmxpbmVGcmFnbWVudHM/OiBMZWdhY3lJbmxpbmVGcmFnbWVudFtdO1xuICAgIGZpZWxkTmFtZT86IHN0cmluZztcbiAgfVtdXG4pIHtcbiAgcmV0dXJuIGZpZWxkcy5tYXAoZmllbGQgPT4gcHJvcGVydHlGcm9tVmFyKGNvbnRleHQsIGZpZWxkKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9wZXJ0eUZyb21WYXIoXG4gIGNvbnRleHQ6IExlZ2FjeUNvbXBpbGVyQ29udGV4dCxcbiAgZmllbGQ6IHtcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHR5cGU6IEdyYXBoUUxUeXBlO1xuICAgIGZpZWxkcz86IGFueVtdO1xuICAgIHJlc3BvbnNlTmFtZT86IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgICBmcmFnbWVudFNwcmVhZHM/OiBhbnk7XG4gICAgaW5saW5lRnJhZ21lbnRzPzogTGVnYWN5SW5saW5lRnJhZ21lbnRbXTtcbiAgICBmaWVsZE5hbWU/OiBzdHJpbmc7XG4gIH1cbik6IFByb3BlcnR5IHtcbiAgbGV0IHsgbmFtZTogZmllbGROYW1lLCB0eXBlOiBmaWVsZFR5cGUgfSA9IGZpZWxkO1xuICBmaWVsZE5hbWUgPSBmaWVsZE5hbWUgfHwgZmllbGQucmVzcG9uc2VOYW1lO1xuXG4gIGNvbnN0IHByb3BlcnR5TmFtZSA9IGZpZWxkTmFtZTtcblxuICBsZXQgcHJvcGVydHkgPSB7IGZpZWxkTmFtZSwgZmllbGRUeXBlLCBwcm9wZXJ0eU5hbWUgfTtcblxuICBsZXQgaXNOdWxsYWJsZSA9IHRydWU7XG4gIGlmIChmaWVsZFR5cGUgaW5zdGFuY2VvZiBHcmFwaFFMTm9uTnVsbCkge1xuICAgIGlzTnVsbGFibGUgPSBmYWxzZTtcbiAgfVxuICBjb25zdCB0eXBlTmFtZSA9IHR5cGVOYW1lRnJvbUdyYXBoUUxUeXBlKGNvbnRleHQsIGZpZWxkVHlwZSwgbnVsbCwgZmFsc2UpO1xuICByZXR1cm4geyAuLi5wcm9wZXJ0eSwgdHlwZU5hbWUsIGlzQ29tcG9zaXRlOiBmYWxzZSwgZmllbGRUeXBlLCBpc051bGxhYmxlIH07XG59XG5cbmZ1bmN0aW9uIHZhcmlhYmxlRGVjbGFyYXRpb24oZ2VuZXJhdG9yOiBDb2RlR2VuZXJhdG9yLCBwcm9wZXJ0aWVzOiBQcm9wZXJ0eVtdKSB7XG4gIHByb3BlcnRpZXNcbiAgICAuc29ydCgoYSwgYikgPT4ge1xuICAgICAgaWYgKCFhLmlzTnVsbGFibGUgJiYgYi5pc051bGxhYmxlKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICAgIH1cbiAgICAgIGlmICghYi5pc051bGxhYmxlICYmIGEuaXNOdWxsYWJsZSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAwO1xuICAgIH0pXG4gICAgLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgY29uc3QgeyBmaWVsZE5hbWUsIHR5cGVOYW1lLCBpc0FycmF5LCBpc051bGxhYmxlIH0gPSBwcm9wZXJ0eTtcbiAgICAgIGdlbmVyYXRvci5wcmludChmaWVsZE5hbWUpO1xuICAgICAgaWYgKGlzTnVsbGFibGUpIHtcbiAgICAgICAgZ2VuZXJhdG9yLnByaW50KCc/Jyk7XG4gICAgICB9XG4gICAgICBnZW5lcmF0b3IucHJpbnQoJzonKTtcbiAgICAgIGlmIChpc0FycmF5KSB7XG4gICAgICAgIGdlbmVyYXRvci5wcmludCgnIEFycmF5PCcpO1xuICAgICAgfVxuICAgICAgZ2VuZXJhdG9yLnByaW50KGAke3R5cGVOYW1lfWApO1xuICAgICAgaWYgKGlzQXJyYXkpIHtcbiAgICAgICAgZ2VuZXJhdG9yLnByaW50KCc+Jyk7XG4gICAgICB9XG4gICAgICBnZW5lcmF0b3IucHJpbnQoJywgJyk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHZhcmlhYmxlQXNzaWdubWVudFRvSW5wdXQoZ2VuZXJhdG9yOiBDb2RlR2VuZXJhdG9yLCB2YXJzOiBQcm9wZXJ0eVtdKSB7XG4gIGlmICh2YXJzLmxlbmd0aCA+IDApIHtcbiAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ2NvbnN0IGdxbEFQSVNlcnZpY2VBcmd1bWVudHMgOiBhbnkgPSAnKTtcbiAgICBnZW5lcmF0b3Iud2l0aGluQmxvY2soXG4gICAgICAoKSA9PiB7XG4gICAgICAgIC8vIG5vbiBudWxsYWJsZSBhcmd1bWVudHNcbiAgICAgICAgdmFycy5maWx0ZXIodiA9PiAhdi5pc051bGxhYmxlKS5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgJHt2LmZpZWxkTmFtZX0sYCk7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgICd7JyxcbiAgICAgICd9J1xuICAgICk7XG4gICAgLy8gbnVsbCBhYmxlIGFyZ3VtZW50c1xuICAgIHZhcnMuZmlsdGVyKHYgPT4gdi5pc051bGxhYmxlKS5mb3JFYWNoKHYgPT4ge1xuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBpZiAoJHt2LmZpZWxkTmFtZX0pIGApO1xuICAgICAgZ2VuZXJhdG9yLndpdGhpbkJsb2NrKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBncWxBUElTZXJ2aWNlQXJndW1lbnRzLiR7di5maWVsZE5hbWV9ID0gJHt2LmZpZWxkTmFtZX1gKTtcbiAgICAgICAgfSxcbiAgICAgICAgJ3snLFxuICAgICAgICAnfSdcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZm9ybWF0VGVtcGxhdGVTdHJpbmcoZ2VuZXJhdG9yOiBDb2RlR2VuZXJhdG9yLCBzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IGluZGVudGF0aW9uID0gJyAnLnJlcGVhdChcbiAgICBnZW5lcmF0b3IuY3VycmVudEZpbGUuaW5kZW50V2lkdGggKiAoZ2VuZXJhdG9yLmN1cnJlbnRGaWxlLmluZGVudExldmVsICsgMilcbiAgKTtcbiAgcmV0dXJuIHN0clxuICAgIC5zcGxpdCgnXFxuJylcbiAgICAubWFwKChsaW5lLCBpZHgpID0+IChpZHggPiAwID8gaW5kZW50YXRpb24gKyBsaW5lIDogbGluZSkpXG4gICAgLmpvaW4oJ1xcbicpO1xufVxuIl19");"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const graphql_1 = require("graphql");
const prettier = require("prettier");
const CodeGenerator_1 = require("../utilities/CodeGenerator");
const codeGeneration_1 = require("../typescript/codeGeneration");
const types_1 = require("../typescript/types");
function generateSource(context) {
    const generator = new CodeGenerator_1.default(context);
    generator.printOnNewline('/* tslint:disable */');
    generator.printOnNewline('//  This file was automatically generated and should not be edited.');
    generator.printOnNewline(`import { Injectable } from '@angular/core';`);
    generator.printOnNewline(`import API, { graphqlOperation } from '@aws-amplify/api';`);
    generator.printOnNewline(`import { GraphQLResult } from "@aws-amplify/api/lib/types";`);
    generator.printOnNewline(`import * as Observable from 'zen-observable';`);
    generator.printNewline();
    generateTypes(generator, context);
    generator.printNewline();
    generateAngularService(generator, context);
    return prettier.format(generator.output, { parser: 'typescript' });
}
exports.generateSource = generateSource;
function generateTypes(generator, context) {
    context.typesUsed.forEach(type => codeGeneration_1.typeDeclarationForGraphQLType(generator, type));
    Object.values(context.operations).forEach(operation => {
        const resultField = getOperationResultField(operation);
        codeGeneration_1.interfaceDeclarationForOperation(generator, Object.assign({}, operation, { fields: resultField ? resultField.fields || [] : operation.fields }));
    });
    Object.values(context.fragments).forEach(operation => codeGeneration_1.interfaceDeclarationForFragment(generator, operation));
}
function getOperationResultField(operation) {
    if (operation.fields.length && operation.fields[0].fields) {
        return operation.fields[0];
    }
}
function generateAngularService(generator, context) {
    const operations = context.operations;
    generator.printOnNewline(`@Injectable({
    providedIn: 'root'
  })`);
    generator.printOnNewline(`export class APIService {`);
    generator.withIndent(() => {
        Object.values(operations).forEach(op => {
            if (op.operationType === 'subscription') {
                return generateSubscriptionOperation(generator, op);
            }
            if (op.operationType === 'query' || op.operationType === 'mutation') {
                return generateQueryOrMutationOperation(generator, op);
            }
        });
        generator.printOnNewline('}');
    });
}
function generateSubscriptionOperation(generator, op) {
    const statement = formatTemplateString(generator, op.source);
    const { operationName, operationType } = op;
    const returnType = codeGeneration_1.interfaceNameFromOperation({ operationName, operationType });
    generator.printNewline();
    const subscriptionName = `${operationName}Listener`;
    generator.print(`${subscriptionName}: Observable<${returnType}> = API.graphql(graphqlOperation(\n\`${statement}\`)) as Observable<${returnType}>`);
    generator.printNewline();
}
function generateQueryOrMutationOperation(generator, op) {
    const statement = formatTemplateString(generator, op.source);
    const { operationName, operationType } = op;
    const vars = variablesFromField(generator.context, op.variables);
    const returnType = codeGeneration_1.interfaceNameFromOperation({ operationName, operationType });
    const resultField = getOperationResultField(op);
    const resultProp = resultField ? `.${resultField.responseName}` : '';
    generator.printNewline();
    generator.print(`async ${op.operationName}(`);
    variableDeclaration(generator, vars);
    generator.print(`) : Promise<${returnType}> {`);
    generator.withIndent(() => {
        generator.printNewlineIfNeeded();
        generator.print(`const statement = \`${statement}\``);
        const params = ['statement'];
        if (op.variables.length) {
            variableAssignmentToInput(generator, vars);
            params.push('gqlAPIServiceArguments');
        }
        generator.printOnNewline(`const response = await API.graphql(graphqlOperation(${params.join(', ')})) as any;`);
        generator.printOnNewline(`return (<${returnType}>response.data${resultProp})`);
    });
    generator.printOnNewline('}');
}
function variablesFromField(context, fields) {
    return fields.map(field => propertyFromVar(context, field));
}
exports.variablesFromField = variablesFromField;
function propertyFromVar(context, field) {
    let { name: fieldName, type: fieldType } = field;
    fieldName = fieldName || field.responseName;
    const propertyName = fieldName;
    let property = { fieldName, fieldType, propertyName };
    let isNullable = true;
    if (fieldType instanceof graphql_1.GraphQLNonNull) {
        isNullable = false;
    }
    const typeName = types_1.typeNameFromGraphQLType(context, fieldType, null, false);
    return Object.assign({}, property, { typeName, isComposite: false, fieldType, isNullable });
}
exports.propertyFromVar = propertyFromVar;
function variableDeclaration(generator, properties) {
    properties.
    sort((a, b) => {
        if (!a.isNullable && b.isNullable) {
            return -1;
        }
        if (!b.isNullable && a.isNullable) {
            return 1;
        }
        return 0;
    }).
    forEach(property => {
        const { fieldName, typeName, isArray, isNullable } = property;
        generator.print(fieldName);
        if (isNullable) {
            generator.print('?');
        }
        generator.print(':');
        if (isArray) {
            generator.print(' Array<');
        }
        generator.print(`${typeName}`);
        if (isArray) {
            generator.print('>');
        }
        generator.print(', ');
    });
}
function variableAssignmentToInput(generator, vars) {
    if (vars.length > 0) {
        generator.printOnNewline('const gqlAPIServiceArguments : any = ');
        generator.withinBlock(() => {
            vars.filter(v => !v.isNullable).forEach(v => {
                generator.printOnNewline(`${v.fieldName},`);
            });
        }, '{', '}');
        vars.filter(v => v.isNullable).forEach(v => {
            generator.printOnNewline(`if (${v.fieldName}) `);
            generator.withinBlock(() => {
                generator.printOnNewline(`gqlAPIServiceArguments.${v.fieldName} = ${v.fieldName}`);
            }, '{', '}');
        });
    }
}
function formatTemplateString(generator, str) {
    const indentation = ' '.repeat(generator.currentFile.indentWidth * (generator.currentFile.indentLevel + 2));
    return str.
    split('\n').
    map((line, idx) => idx > 0 ? indentation + line : line).
    join('\n');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QVJGO0FBV0EsYUFBSyxNQUFMLENBQVksS0FBSyxFQUFFLFVBQW5CLEVBQStCLE9BQS9CLENBQXVDLEtBQUk7QUFDekMsc0JBQVUsY0FBVixDQUF5QixPQUFPLEVBQUUsU0FBUyxJQUEzQztBQUNBLHNCQUFVLFdBQVYsQ0FDRSxNQUFLO0FBQ0gsMEJBQVUsY0FBVixDQUF5QiwwQkFBMEIsRUFBRSxTQUFTLE1BQU0sRUFBRSxTQUFTLEVBQS9FO0FBQ0QsYUFISCxFQUlFLEdBSkYsRUFLRSxHQUxGO0FBT0QsU0FURDtBQVVEO0FBQ0Y7QUFFRCxTQUFBLG9CQUFBLENBQThCLFNBQTlCLEVBQXdELEdBQXhELEVBQW1FO0FBQ2pFLFVBQU0sY0FBYyxJQUFJLE1BQUosQ0FDbEIsVUFBVSxXQUFWLENBQXNCLFdBQXRCLElBQXFDLFVBQVUsV0FBVixDQUFzQixXQUF0QixHQUFvQyxDQUF6RSxDQURrQixDQUFwQjtBQUdBLFdBQU87QUFDSixTQURJLENBQ0UsSUFERjtBQUVKLE9BRkksQ0FFQSxDQUFDLElBQUQsRUFBTyxHQUFQLEtBQWdCLE1BQU0sQ0FBTixHQUFVLGNBQWMsSUFBeEIsR0FBK0IsSUFGL0M7QUFHSixRQUhJLENBR0MsSUFIRCxDQUFQO0FBSUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHcmFwaFFMTm9uTnVsbCwgR3JhcGhRTFR5cGUgfSBmcm9tICdncmFwaHFsJztcbmltcG9ydCAqIGFzIHByZXR0aWVyIGZyb20gJ3ByZXR0aWVyJztcbmltcG9ydCB7XG4gIExlZ2FjeUNvbXBpbGVyQ29udGV4dCxcbiAgTGVnYWN5T3BlcmF0aW9uLFxuICBMZWdhY3lJbmxpbmVGcmFnbWVudCxcbiAgTGVnYWN5RmllbGRcbn0gZnJvbSAnLi4vY29tcGlsZXIvbGVnYWN5SVInO1xuXG5pbXBvcnQgQ29kZUdlbmVyYXRvciBmcm9tICcuLi91dGlsaXRpZXMvQ29kZUdlbmVyYXRvcic7XG5pbXBvcnQge1xuICB0eXBlRGVjbGFyYXRpb25Gb3JHcmFwaFFMVHlwZSxcbiAgaW50ZXJmYWNlRGVjbGFyYXRpb25Gb3JPcGVyYXRpb24sXG4gIGludGVyZmFjZURlY2xhcmF0aW9uRm9yRnJhZ21lbnQsXG4gIGludGVyZmFjZU5hbWVGcm9tT3BlcmF0aW9uXG59IGZyb20gJy4uL3R5cGVzY3JpcHQvY29kZUdlbmVyYXRpb24nO1xuaW1wb3J0IHsgdHlwZU5hbWVGcm9tR3JhcGhRTFR5cGUgfSBmcm9tICcuLi90eXBlc2NyaXB0L3R5cGVzJztcbmltcG9ydCB7IFByb3BlcnR5IH0gZnJvbSAnLi4vdHlwZXNjcmlwdC9sYW5ndWFnZSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVNvdXJjZShjb250ZXh0OiBMZWdhY3lDb21waWxlckNvbnRleHQpIHtcbiAgY29uc3QgZ2VuZXJhdG9yID0gbmV3IENvZGVHZW5lcmF0b3I8TGVnYWN5Q29tcGlsZXJDb250ZXh0Pihjb250ZXh0KTtcblxuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJy8qIHRzbGludDpkaXNhYmxlICovJyk7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgnLy8gIFRoaXMgZmlsZSB3YXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIHNob3VsZCBub3QgYmUgZWRpdGVkLicpO1xuXG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO2ApO1xuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYGltcG9ydCBBUEksIHsgZ3JhcGhxbE9wZXJhdGlvbiB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9hcGknO2ApO1xuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYGltcG9ydCB7IEdyYXBoUUxSZXN1bHQgfSBmcm9tIFwiQGF3cy1hbXBsaWZ5L2FwaS9saWIvdHlwZXNcIjtgKTtcblxuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYGltcG9ydCAqIGFzIE9ic2VydmFibGUgZnJvbSAnemVuLW9ic2VydmFibGUnO2ApO1xuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG5cbiAgZ2VuZXJhdGVUeXBlcyhnZW5lcmF0b3IsIGNvbnRleHQpO1xuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG5cbiAgZ2VuZXJhdGVBbmd1bGFyU2VydmljZShnZW5lcmF0b3IsIGNvbnRleHQpO1xuICByZXR1cm4gcHJldHRpZXIuZm9ybWF0KGdlbmVyYXRvci5vdXRwdXQsIHsgcGFyc2VyOiAndHlwZXNjcmlwdCcgfSk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlVHlwZXMoZ2VuZXJhdG9yOiBDb2RlR2VuZXJhdG9yLCBjb250ZXh0OiBMZWdhY3lDb21waWxlckNvbnRleHQpIHtcbiAgY29udGV4dC50eXBlc1VzZWQuZm9yRWFjaCh0eXBlID0+IHR5cGVEZWNsYXJhdGlvbkZvckdyYXBoUUxUeXBlKGdlbmVyYXRvciwgdHlwZSkpO1xuXG4gIE9iamVjdC52YWx1ZXMoY29udGV4dC5vcGVyYXRpb25zKS5mb3JFYWNoKG9wZXJhdGlvbiA9PiB7XG4gICAgY29uc3QgcmVzdWx0RmllbGQgPSBnZXRPcGVyYXRpb25SZXN1bHRGaWVsZChvcGVyYXRpb24pO1xuICAgIGludGVyZmFjZURlY2xhcmF0aW9uRm9yT3BlcmF0aW9uKGdlbmVyYXRvciwge1xuICAgICAgLi4ub3BlcmF0aW9uLFxuICAgICAgZmllbGRzOiByZXN1bHRGaWVsZCA/IHJlc3VsdEZpZWxkLmZpZWxkcyB8fCBbXSA6IG9wZXJhdGlvbi5maWVsZHNcbiAgICB9KTtcbiAgfSk7XG5cbiAgT2JqZWN0LnZhbHVlcyhjb250ZXh0LmZyYWdtZW50cykuZm9yRWFjaChvcGVyYXRpb24gPT5cbiAgICBpbnRlcmZhY2VEZWNsYXJhdGlvbkZvckZyYWdtZW50KGdlbmVyYXRvciwgb3BlcmF0aW9uKVxuICApO1xufVxuXG5mdW5jdGlvbiBnZXRPcGVyYXRpb25SZXN1bHRGaWVsZChvcGVyYXRpb246IExlZ2FjeU9wZXJhdGlvbik6IExlZ2FjeUZpZWxkIHwgdm9pZCB7XG4gIGlmIChvcGVyYXRpb24uZmllbGRzLmxlbmd0aCAmJiBvcGVyYXRpb24uZmllbGRzWzBdLmZpZWxkcykge1xuICAgIHJldHVybiBvcGVyYXRpb24uZmllbGRzWzBdO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlQW5ndWxhclNlcnZpY2UoZ2VuZXJhdG9yOiBDb2RlR2VuZXJhdG9yLCBjb250ZXh0OiBMZWdhY3lDb21waWxlckNvbnRleHQpIHtcbiAgY29uc3Qgb3BlcmF0aW9ucyA9IGNvbnRleHQub3BlcmF0aW9ucztcbiAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG4gIH0pYCk7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgZXhwb3J0IGNsYXNzIEFQSVNlcnZpY2Uge2ApO1xuXG4gIGdlbmVyYXRvci53aXRoSW5kZW50KCgpID0+IHtcbiAgICBPYmplY3QudmFsdWVzKG9wZXJhdGlvbnMpLmZvckVhY2goKG9wOiBMZWdhY3lPcGVyYXRpb24pID0+IHtcbiAgICAgIGlmIChvcC5vcGVyYXRpb25UeXBlID09PSAnc3Vic2NyaXB0aW9uJykge1xuICAgICAgICByZXR1cm4gZ2VuZXJhdGVTdWJzY3JpcHRpb25PcGVyYXRpb24oZ2VuZXJhdG9yLCBvcCk7XG4gICAgICB9XG4gICAgICBpZiAob3Aub3BlcmF0aW9uVHlwZSA9PT0gJ3F1ZXJ5JyB8fCBvcC5vcGVyYXRpb25UeXBlID09PSAnbXV0YXRpb24nKSB7XG4gICAgICAgIHJldHVybiBnZW5lcmF0ZVF1ZXJ5T3JNdXRhdGlvbk9wZXJhdGlvbihnZW5lcmF0b3IsIG9wKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ30nKTtcbiAgfSk7XG59XG5mdW5jdGlvbiBnZW5lcmF0ZVN1YnNjcmlwdGlvbk9wZXJhdGlvbihnZW5lcmF0b3I6IENvZGVHZW5lcmF0b3IsIG9wOiBMZWdhY3lPcGVyYXRpb24pIHtcbiAgY29uc3Qgc3RhdGVtZW50ID0gZm9ybWF0VGVtcGxhdGVTdHJpbmcoZ2VuZXJhdG9yLCBvcC5zb3VyY2UpO1xuICBjb25zdCB7IG9wZXJhdGlvbk5hbWUsIG9wZXJhdGlvblR5cGUgfSA9IG9wO1xuICBjb25zdCByZXR1cm5UeXBlID0gaW50ZXJmYWNlTmFtZUZyb21PcGVyYXRpb24oeyBvcGVyYXRpb25OYW1lLCBvcGVyYXRpb25UeXBlIH0pO1xuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG4gIGNvbnN0IHN1YnNjcmlwdGlvbk5hbWUgPSBgJHtvcGVyYXRpb25OYW1lfUxpc3RlbmVyYDtcbiAgZ2VuZXJhdG9yLnByaW50KFxuICAgIGAke3N1YnNjcmlwdGlvbk5hbWV9OiBPYnNlcnZhYmxlPCR7cmV0dXJuVHlwZX0+ID0gQVBJLmdyYXBocWwoZ3JhcGhxbE9wZXJhdGlvbihcXG5cXGAke3N0YXRlbWVudH1cXGApKSBhcyBPYnNlcnZhYmxlPCR7cmV0dXJuVHlwZX0+YFxuICApO1xuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlUXVlcnlPck11dGF0aW9uT3BlcmF0aW9uKGdlbmVyYXRvcjogQ29kZUdlbmVyYXRvciwgb3A6IExlZ2FjeU9wZXJhdGlvbikge1xuICBjb25zdCBzdGF0ZW1lbnQgPSBmb3JtYXRUZW1wbGF0ZVN0cmluZyhnZW5lcmF0b3IsIG9wLnNvdXJjZSk7XG4gIGNvbnN0IHsgb3BlcmF0aW9uTmFtZSwgb3BlcmF0aW9uVHlwZSB9ID0gb3A7XG4gIGNvbnN0IHZhcnMgPSB2YXJpYWJsZXNGcm9tRmllbGQoZ2VuZXJhdG9yLmNvbnRleHQsIG9wLnZhcmlhYmxlcyk7XG4gIGNvbnN0IHJldHVyblR5cGUgPSBpbnRlcmZhY2VOYW1lRnJvbU9wZXJhdGlvbih7IG9wZXJhdGlvbk5hbWUsIG9wZXJhdGlvblR5cGUgfSk7XG4gIGNvbnN0IHJlc3VsdEZpZWxkID0gZ2V0T3BlcmF0aW9uUmVzdWx0RmllbGQob3ApO1xuICBjb25zdCByZXN1bHRQcm9wID0gcmVzdWx0RmllbGQgPyBgLiR7cmVzdWx0RmllbGQucmVzcG9uc2VOYW1lfWAgOiAnJztcblxuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG4gIGdlbmVyYXRvci5wcmludChgYXN5bmMgJHtvcC5vcGVyYXRpb25OYW1lfShgKTtcbiAgdmFyaWFibGVEZWNsYXJhdGlvbihnZW5lcmF0b3IsIHZhcnMpO1xuICBnZW5lcmF0b3IucHJpbnQoYCkgOiBQcm9taXNlPCR7cmV0dXJuVHlwZX0+IHtgKTtcbiAgZ2VuZXJhdG9yLndpdGhJbmRlbnQoKCkgPT4ge1xuICAgIGdlbmVyYXRvci5wcmludE5ld2xpbmVJZk5lZWRlZCgpO1xuICAgIGdlbmVyYXRvci5wcmludChgY29uc3Qgc3RhdGVtZW50ID0gXFxgJHtzdGF0ZW1lbnR9XFxgYCk7XG4gICAgY29uc3QgcGFyYW1zID0gWydzdGF0ZW1lbnQnXTtcbiAgICBpZiAob3AudmFyaWFibGVzLmxlbmd0aCkge1xuICAgICAgdmFyaWFibGVBc3NpZ25tZW50VG9JbnB1dChnZW5lcmF0b3IsIHZhcnMpO1xuICAgICAgcGFyYW1zLnB1c2goJ2dxbEFQSVNlcnZpY2VBcmd1bWVudHMnKTtcbiAgICB9XG4gICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKFxuICAgICAgYGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgQVBJLmdyYXBocWwoZ3JhcGhxbE9wZXJhdGlvbigke3BhcmFtcy5qb2luKCcsICcpfSkpIGFzIGFueTtgXG4gICAgKTtcbiAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYHJldHVybiAoPCR7cmV0dXJuVHlwZX0+cmVzcG9uc2UuZGF0YSR7cmVzdWx0UHJvcH0pYCk7XG4gIH0pO1xuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ30nKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhcmlhYmxlc0Zyb21GaWVsZChcbiAgY29udGV4dDogTGVnYWN5Q29tcGlsZXJDb250ZXh0LFxuICBmaWVsZHM6IHtcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHR5cGU6IEdyYXBoUUxUeXBlO1xuICAgIHJlc3BvbnNlTmFtZT86IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgICBmcmFnbWVudFNwcmVhZHM/OiBhbnk7XG4gICAgaW5saW5lRnJhZ21lbnRzPzogTGVnYWN5SW5saW5lRnJhZ21lbnRbXTtcbiAgICBmaWVsZE5hbWU/OiBzdHJpbmc7XG4gIH1bXVxuKSB7XG4gIHJldHVybiBmaWVsZHMubWFwKGZpZWxkID0+IHByb3BlcnR5RnJvbVZhcihjb250ZXh0LCBmaWVsZCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvcGVydHlGcm9tVmFyKFxuICBjb250ZXh0OiBMZWdhY3lDb21waWxlckNvbnRleHQsXG4gIGZpZWxkOiB7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0eXBlOiBHcmFwaFFMVHlwZTtcbiAgICBmaWVsZHM/OiBhbnlbXTtcbiAgICByZXNwb25zZU5hbWU/OiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgZnJhZ21lbnRTcHJlYWRzPzogYW55O1xuICAgIGlubGluZUZyYWdtZW50cz86IExlZ2FjeUlubGluZUZyYWdtZW50W107XG4gICAgZmllbGROYW1lPzogc3RyaW5nO1xuICB9XG4pOiBQcm9wZXJ0eSB7XG4gIGxldCB7IG5hbWU6IGZpZWxkTmFtZSwgdHlwZTogZmllbGRUeXBlIH0gPSBmaWVsZDtcbiAgZmllbGROYW1lID0gZmllbGROYW1lIHx8IGZpZWxkLnJlc3BvbnNlTmFtZTtcblxuICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBmaWVsZE5hbWU7XG5cbiAgbGV0IHByb3BlcnR5ID0geyBmaWVsZE5hbWUsIGZpZWxkVHlwZSwgcHJvcGVydHlOYW1lIH07XG5cbiAgbGV0IGlzTnVsbGFibGUgPSB0cnVlO1xuICBpZiAoZmllbGRUeXBlIGluc3RhbmNlb2YgR3JhcGhRTE5vbk51bGwpIHtcbiAgICBpc051bGxhYmxlID0gZmFsc2U7XG4gIH1cbiAgY29uc3QgdHlwZU5hbWUgPSB0eXBlTmFtZUZyb21HcmFwaFFMVHlwZShjb250ZXh0LCBmaWVsZFR5cGUsIG51bGwsIGZhbHNlKTtcbiAgcmV0dXJuIHsgLi4ucHJvcGVydHksIHR5cGVOYW1lLCBpc0NvbXBvc2l0ZTogZmFsc2UsIGZpZWxkVHlwZSwgaXNOdWxsYWJsZSB9O1xufVxuXG5mdW5jdGlvbiB2YXJpYWJsZURlY2xhcmF0aW9uKGdlbmVyYXRvcjogQ29kZUdlbmVyYXRvciwgcHJvcGVydGllczogUHJvcGVydHlbXSkge1xuICBwcm9wZXJ0aWVzXG4gICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmICghYS5pc051bGxhYmxlICYmIGIuaXNOdWxsYWJsZSkge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgICB9XG4gICAgICBpZiAoIWIuaXNOdWxsYWJsZSAmJiBhLmlzTnVsbGFibGUpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICB9XG4gICAgICByZXR1cm4gMDtcbiAgICB9KVxuICAgIC5mb3JFYWNoKHByb3BlcnR5ID0+IHtcbiAgICAgIGNvbnN0IHsgZmllbGROYW1lLCB0eXBlTmFtZSwgaXNBcnJheSwgaXNOdWxsYWJsZSB9ID0gcHJvcGVydHk7XG4gICAgICBnZW5lcmF0b3IucHJpbnQoZmllbGROYW1lKTtcbiAgICAgIGlmIChpc051bGxhYmxlKSB7XG4gICAgICAgIGdlbmVyYXRvci5wcmludCgnPycpO1xuICAgICAgfVxuICAgICAgZ2VuZXJhdG9yLnByaW50KCc6Jyk7XG4gICAgICBpZiAoaXNBcnJheSkge1xuICAgICAgICBnZW5lcmF0b3IucHJpbnQoJyBBcnJheTwnKTtcbiAgICAgIH1cbiAgICAgIGdlbmVyYXRvci5wcmludChgJHt0eXBlTmFtZX1gKTtcbiAgICAgIGlmIChpc0FycmF5KSB7XG4gICAgICAgIGdlbmVyYXRvci5wcmludCgnPicpO1xuICAgICAgfVxuICAgICAgZ2VuZXJhdG9yLnByaW50KCcsICcpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiB2YXJpYWJsZUFzc2lnbm1lbnRUb0lucHV0KGdlbmVyYXRvcjogQ29kZUdlbmVyYXRvciwgdmFyczogUHJvcGVydHlbXSkge1xuICBpZiAodmFycy5sZW5ndGggPiAwKSB7XG4gICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCdjb25zdCBncWxBUElTZXJ2aWNlQXJndW1lbnRzIDogYW55ID0gJyk7XG4gICAgZ2VuZXJhdG9yLndpdGhpbkJsb2NrKFxuICAgICAgKCkgPT4ge1xuICAgICAgICAvLyBub24gbnVsbGFibGUgYXJndW1lbnRzXG4gICAgICAgIHZhcnMuZmlsdGVyKHYgPT4gIXYuaXNOdWxsYWJsZSkuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYCR7di5maWVsZE5hbWV9LGApO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICAneycsXG4gICAgICAnfSdcbiAgICApO1xuICAgIC8vIG51bGwgYWJsZSBhcmd1bWVudHNcbiAgICB2YXJzLmZpbHRlcih2ID0+IHYuaXNOdWxsYWJsZSkuZm9yRWFjaCh2ID0+IHtcbiAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaWYgKCR7di5maWVsZE5hbWV9KSBgKTtcbiAgICAgIGdlbmVyYXRvci53aXRoaW5CbG9jayhcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgZ3FsQVBJU2VydmljZUFyZ3VtZW50cy4ke3YuZmllbGROYW1lfSA9ICR7di5maWVsZE5hbWV9YCk7XG4gICAgICAgIH0sXG4gICAgICAgICd7JyxcbiAgICAgICAgJ30nXG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGZvcm1hdFRlbXBsYXRlU3RyaW5nKGdlbmVyYXRvcjogQ29kZUdlbmVyYXRvciwgc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBpbmRlbnRhdGlvbiA9ICcgJy5yZXBlYXQoXG4gICAgZ2VuZXJhdG9yLmN1cnJlbnRGaWxlLmluZGVudFdpZHRoICogKGdlbmVyYXRvci5jdXJyZW50RmlsZS5pbmRlbnRMZXZlbCArIDIpXG4gICk7XG4gIHJldHVybiBzdHJcbiAgICAuc3BsaXQoJ1xcbicpXG4gICAgLm1hcCgobGluZSwgaWR4KSA9PiAoaWR4ID4gMCA/IGluZGVudGF0aW9uICsgbGluZSA6IGxpbmUpKVxuICAgIC5qb2luKCdcXG4nKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=