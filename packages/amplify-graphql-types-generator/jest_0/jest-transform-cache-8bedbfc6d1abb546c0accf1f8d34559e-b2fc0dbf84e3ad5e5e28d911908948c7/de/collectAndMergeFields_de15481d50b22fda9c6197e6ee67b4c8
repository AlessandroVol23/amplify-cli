01e1f8c942a862829e1eba7e27388f99
'use strict';require('ts-jest').install("/c/Users/Sandro/repo/amplify-cli/packages/amplify-graphql-types-generator/src/compiler/visitors/collectAndMergeFields.ts", "\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nfunction collectAndMergeFields(selectionSet, mergeInFragmentSpreads = true) {\n    const groupedFields = new Map();\n    function visitSelectionSet(selections, possibleTypes, conditions = []) {\n        if (possibleTypes.length < 1)\n            return;\n        for (const selection of selections) {\n            switch (selection.kind) {\n                case 'Field':\n                    let groupForResponseKey = groupedFields.get(selection.responseKey);\n                    if (!groupForResponseKey) {\n                        groupForResponseKey = [];\n                        groupedFields.set(selection.responseKey, groupForResponseKey);\n                    }\n                    groupForResponseKey.push(Object.assign({}, selection, { isConditional: conditions.length > 0, conditions, selectionSet: selection.selectionSet\n                            ? {\n                                possibleTypes: selection.selectionSet.possibleTypes,\n                                selections: [...selection.selectionSet.selections]\n                            }\n                            : undefined }));\n                    break;\n                case 'FragmentSpread':\n                case 'TypeCondition':\n                    if (selection.kind === 'FragmentSpread' && !mergeInFragmentSpreads)\n                        continue;\n                    if (!possibleTypes.every(type => selection.selectionSet.possibleTypes.includes(type)))\n                        continue;\n                    visitSelectionSet(selection.selectionSet.selections, possibleTypes, conditions);\n                    break;\n                case 'BooleanCondition':\n                    visitSelectionSet(selection.selectionSet.selections, possibleTypes, [...conditions, selection]);\n                    break;\n            }\n        }\n    }\n    visitSelectionSet(selectionSet.selections, selectionSet.possibleTypes);\n    const fields = Array.from(groupedFields.values()).map(fields => {\n        const isFieldIncludedUnconditionally = fields.some(field => !field.isConditional);\n        return fields\n            .map(field => {\n            if (isFieldIncludedUnconditionally && field.isConditional && field.selectionSet) {\n                field.selectionSet.selections = wrapInBooleanConditionsIfNeeded(field.selectionSet.selections, field.conditions);\n            }\n            return field;\n        })\n            .reduce((field, otherField) => {\n            field.isConditional = field.isConditional && otherField.isConditional;\n            if (field.conditions && otherField.conditions) {\n                field.conditions = [...field.conditions, ...otherField.conditions];\n            }\n            else {\n                field.conditions = undefined;\n            }\n            if (field.selectionSet && otherField.selectionSet) {\n                field.selectionSet.selections.push(...otherField.selectionSet.selections);\n            }\n            return field;\n        });\n    });\n    if (selectionSet.possibleTypes.length == 1) {\n        const type = selectionSet.possibleTypes[0];\n        const fieldDefMap = type.getFields();\n        for (const field of fields) {\n            const fieldDef = fieldDefMap[field.name];\n            if (fieldDef && fieldDef.description) {\n                field.description = fieldDef.description;\n            }\n        }\n    }\n    return fields;\n}\nexports.collectAndMergeFields = collectAndMergeFields;\nfunction wrapInBooleanConditionsIfNeeded(selections, conditions) {\n    if (!conditions || conditions.length == 0)\n        return selections;\n    const [condition, ...rest] = conditions;\n    return [\n        Object.assign({}, condition, { selectionSet: {\n                possibleTypes: condition.selectionSet.possibleTypes,\n                selections: wrapInBooleanConditionsIfNeeded(selections, rest)\n            } })\n    ];\n}\nexports.wrapInBooleanConditionsIfNeeded = wrapInBooleanConditionsIfNeeded;\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdEFuZE1lcmdlRmllbGRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29sbGVjdEFuZE1lcmdlRmllbGRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBV0EsK0JBQ0UsWUFBMEIsRUFDMUIseUJBQWtDLElBQUk7SUFFdEMsTUFBTSxhQUFhLEdBQXlCLElBQUksR0FBRyxFQUFFLENBQUM7SUFFdEQsMkJBQ0UsVUFBdUIsRUFDdkIsYUFBa0MsRUFDbEMsYUFBaUMsRUFBRTtRQUVuQyxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUFFLE9BQU87UUFFckMsS0FBSyxNQUFNLFNBQVMsSUFBSSxVQUFVLEVBQUU7WUFDbEMsUUFBUSxTQUFTLENBQUMsSUFBSSxFQUFFO2dCQUN0QixLQUFLLE9BQU87b0JBQ1YsSUFBSSxtQkFBbUIsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztvQkFDbkUsSUFBSSxDQUFDLG1CQUFtQixFQUFFO3dCQUN4QixtQkFBbUIsR0FBRyxFQUFFLENBQUM7d0JBQ3pCLGFBQWEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO3FCQUMvRDtvQkFHRCxtQkFBbUIsQ0FBQyxJQUFJLG1CQUNuQixTQUFTLElBQ1osYUFBYSxFQUFFLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUNwQyxVQUFVLEVBQ1YsWUFBWSxFQUFFLFNBQVMsQ0FBQyxZQUFZOzRCQUNsQyxDQUFDLENBQUM7Z0NBQ0UsYUFBYSxFQUFFLFNBQVMsQ0FBQyxZQUFZLENBQUMsYUFBYTtnQ0FDbkQsVUFBVSxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQzs2QkFDbkQ7NEJBQ0gsQ0FBQyxDQUFDLFNBQVMsSUFDYixDQUFDO29CQUNILE1BQU07Z0JBQ1IsS0FBSyxnQkFBZ0IsQ0FBQztnQkFDdEIsS0FBSyxlQUFlO29C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QUM7QUFDaEIsQ0FBQztBQXZHRCxzREF1R0M7QUFFRCx5Q0FDRSxVQUF1QixFQUN2QixVQUErQjtJQUUvQixJQUFJLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxNQUFNLElBQUksQ0FBQztRQUFFLE9BQU8sVUFBVSxDQUFDO0lBRTdELE1BQU0sQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUM7SUFDeEMsT0FBTzswQkFFQSxTQUFTLElBQ1osWUFBWSxFQUFFO2dCQUNaLGFBQWEsRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLGFBQWE7Z0JBQ25ELFVBQVUsRUFBRSwrQkFBK0IsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDO2FBQzlEO0tBRUosQ0FBQztBQUNKLENBQUM7QUFoQkQsMEVBZ0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VsZWN0aW9uU2V0LCBTZWxlY3Rpb24sIEZpZWxkLCBCb29sZWFuQ29uZGl0aW9uIH0gZnJvbSAnLi4vJztcbmltcG9ydCB7IEdyYXBoUUxPYmplY3RUeXBlIH0gZnJvbSAnZ3JhcGhxbCc7XG5cbi8vIFRoaXMgaXMgYSB0ZW1wb3Jhcnkgd29ya2Fyb3VuZCB0byBrZWVwIHRyYWNrIG9mIGNvbmRpdGlvbnMgb24gZmllbGRzIGluIHRoZSBmaWVsZHMgdGhlbXNlbHZlcy5cbi8vIEl0IGlzIG9ubHkgYWRkZWQgaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gZXhwb3NlIGl0IHRvIHRoZSBBbmRyb2lkIHRhcmdldCwgd2hpY2ggcmVsaWVzIG9uIHRoZSBsZWdhY3kgSVIuXG5kZWNsYXJlIG1vZHVsZSAnLi4vJyB7XG4gIGludGVyZmFjZSBGaWVsZCB7XG4gICAgY29uZGl0aW9ucz86IEJvb2xlYW5Db25kaXRpb25bXTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29sbGVjdEFuZE1lcmdlRmllbGRzKFxuICBzZWxlY3Rpb25TZXQ6IFNlbGVjdGlvblNldCxcbiAgbWVyZ2VJbkZyYWdtZW50U3ByZWFkczogQm9vbGVhbiA9IHRydWVcbik6IEZpZWxkW10ge1xuICBjb25zdCBncm91cGVkRmllbGRzOiBNYXA8c3RyaW5nLCBGaWVsZFtdPiA9IG5ldyBNYXAoKTtcblxuICBmdW5jdGlvbiB2aXNpdFNlbGVjdGlvblNldChcbiAgICBzZWxlY3Rpb25zOiBTZWxlY3Rpb25bXSxcbiAgICBwb3NzaWJsZVR5cGVzOiBHcmFwaFFMT2JqZWN0VHlwZVtdLFxuICAgIGNvbmRpdGlvbnM6IEJvb2xlYW5Db25kaXRpb25bXSA9IFtdXG4gICkge1xuICAgIGlmIChwb3NzaWJsZVR5cGVzLmxlbmd0aCA8IDEpIHJldHVybjtcblxuICAgIGZvciAoY29uc3Qgc2VsZWN0aW9uIG9mIHNlbGVjdGlvbnMpIHtcbiAgICAgIHN3aXRjaCAoc2VsZWN0aW9uLmtpbmQpIHtcbiAgICAgICAgY2FzZSAnRmllbGQnOlxuICAgICAgICAgIGxldCBncm91cEZvclJlc3BvbnNlS2V5ID0gZ3JvdXBlZEZpZWxkcy5nZXQoc2VsZWN0aW9uLnJlc3BvbnNlS2V5KTtcbiAgICAgICAgICBpZiAoIWdyb3VwRm9yUmVzcG9uc2VLZXkpIHtcbiAgICAgICAgICAgIGdyb3VwRm9yUmVzcG9uc2VLZXkgPSBbXTtcbiAgICAgICAgICAgIGdyb3VwZWRGaWVsZHMuc2V0KHNlbGVjdGlvbi5yZXNwb25zZUtleSwgZ3JvdXBGb3JSZXNwb25zZUtleSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0byBkZWVwIGNsb25lIHNlbGVjdGlvbnMgdG8gYXZvaWQgbW9kaWZ5aW5nIHRoZSBvcmlnaW5hbCBmaWVsZFxuICAgICAgICAgIC8vIFRPRE86IFNob3VsZCB3ZSB1c2UgYW4gb2JqZWN0IGZyZWV6aW5nIC8gaW1tdXRhYmlsaXR5IHNvbHV0aW9uP1xuICAgICAgICAgIGdyb3VwRm9yUmVzcG9uc2VLZXkucHVzaCh7XG4gICAgICAgICAgICAuLi5zZWxlY3Rpb24sXG4gICAgICAgICAgICBpc0NvbmRpdGlvbmFsOiBjb25kaXRpb25zLmxlbmd0aCA+IDAsXG4gICAgICAgICAgICBjb25kaXRpb25zLFxuICAgICAgICAgICAgc2VsZWN0aW9uU2V0OiBzZWxlY3Rpb24uc2VsZWN0aW9uU2V0XG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgcG9zc2libGVUeXBlczogc2VsZWN0aW9uLnNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzLFxuICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uczogWy4uLnNlbGVjdGlvbi5zZWxlY3Rpb25TZXQuc2VsZWN0aW9uc11cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ0ZyYWdtZW50U3ByZWFkJzpcbiAgICAgICAgY2FzZSAnVHlwZUNvbmRpdGlvbic6XG4gICAgICAgICAgaWYgKHNlbGVjdGlvbi5raW5kID09PSAnRnJhZ21lbnRTcHJlYWQnICYmICFtZXJnZUluRnJhZ21lbnRTcHJlYWRzKSBjb250aW51ZTtcblxuICAgICAgICAgIC8vIE9ubHkgbWVyZ2UgZnJhZ21lbnQgc3ByZWFkcyBhbmQgdHlwZSBjb25kaXRpb25zIGlmIHRoZXkgbWF0Y2ggYWxsIHBvc3NpYmxlIHR5cGVzLlxuICAgICAgICAgIGlmICghcG9zc2libGVUeXBlcy5ldmVyeSh0eXBlID0+IHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcy5pbmNsdWRlcyh0eXBlKSkpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgdmlzaXRTZWxlY3Rpb25TZXQoc2VsZWN0aW9uLnNlbGVjdGlvblNldC5zZWxlY3Rpb25zLCBwb3NzaWJsZVR5cGVzLCBjb25kaXRpb25zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnQm9vbGVhbkNvbmRpdGlvbic6XG4gICAgICAgICAgdmlzaXRTZWxlY3Rpb25TZXQoc2VsZWN0aW9uLnNlbGVjdGlvblNldC5zZWxlY3Rpb25zLCBwb3NzaWJsZVR5cGVzLCBbLi4uY29uZGl0aW9ucywgc2VsZWN0aW9uXSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdmlzaXRTZWxlY3Rpb25TZXQoc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMsIHNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzKTtcblxuICAvLyBNZXJnZSBzZWxlY3Rpb24gc2V0c1xuXG4gIGNvbnN0IGZpZWxkcyA9IEFycmF5LmZyb20oZ3JvdXBlZEZpZWxkcy52YWx1ZXMoKSkubWFwKGZpZWxkcyA9PiB7XG4gICAgY29uc3QgaXNGaWVsZEluY2x1ZGVkVW5jb25kaXRpb25hbGx5ID0gZmllbGRzLnNvbWUoZmllbGQgPT4gIWZpZWxkLmlzQ29uZGl0aW9uYWwpO1xuXG4gICAgcmV0dXJuIGZpZWxkc1xuICAgICAgLm1hcChmaWVsZCA9PiB7XG4gICAgICAgIGlmIChpc0ZpZWxkSW5jbHVkZWRVbmNvbmRpdGlvbmFsbHkgJiYgZmllbGQuaXNDb25kaXRpb25hbCAmJiBmaWVsZC5zZWxlY3Rpb25TZXQpIHtcbiAgICAgICAgICBmaWVsZC5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucyA9IHdyYXBJbkJvb2xlYW5Db25kaXRpb25zSWZOZWVkZWQoXG4gICAgICAgICAgICBmaWVsZC5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucyxcbiAgICAgICAgICAgIGZpZWxkLmNvbmRpdGlvbnNcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmaWVsZDtcbiAgICAgIH0pXG4gICAgICAucmVkdWNlKChmaWVsZCwgb3RoZXJGaWVsZCkgPT4ge1xuICAgICAgICBmaWVsZC5pc0NvbmRpdGlvbmFsID0gZmllbGQuaXNDb25kaXRpb25hbCAmJiBvdGhlckZpZWxkLmlzQ29uZGl0aW9uYWw7XG5cbiAgICAgICAgLy8gRklYTUU6IFRoaXMgaXMgc3RyaWN0bHkgdGFrZW4gaW5jb3JyZWN0LCBiZWNhdXNlIHRoZSBjb25kaXRpb25zIHNob3VsZCBiZSBPUmVkXG4gICAgICAgIC8vIFRoZXNlIGNvbmRpdGlvbnMgYXJlIG9ubHkgdXNlZCBpbiBBbmRyb2lkIHRhcmdldCBob3dldmVyLFxuICAgICAgICAvLyBhbmQgdGhlcmUgaXMgbm93IHdheSB0byBleHByZXNzIHRoaXMgaW4gdGhlIGxlZ2FjeSBJUi5cbiAgICAgICAgaWYgKGZpZWxkLmNvbmRpdGlvbnMgJiYgb3RoZXJGaWVsZC5jb25kaXRpb25zKSB7XG4gICAgICAgICAgZmllbGQuY29uZGl0aW9ucyA9IFsuLi5maWVsZC5jb25kaXRpb25zLCAuLi5vdGhlckZpZWxkLmNvbmRpdGlvbnNdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZpZWxkLmNvbmRpdGlvbnMgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZmllbGQuc2VsZWN0aW9uU2V0ICYmIG90aGVyRmllbGQuc2VsZWN0aW9uU2V0KSB7XG4gICAgICAgICAgZmllbGQuc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMucHVzaCguLi5vdGhlckZpZWxkLnNlbGVjdGlvblNldC5zZWxlY3Rpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmaWVsZDtcbiAgICAgIH0pO1xuICB9KTtcblxuICAvLyBSZXBsYWNlIGZpZWxkIGRlc2NyaXB0aW9ucyB3aXRoIHR5cGUtc3BlY2lmaWMgZGVzY3JpcHRpb25zIGlmIHBvc3NpYmxlXG4gIGlmIChzZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcy5sZW5ndGggPT0gMSkge1xuICAgIGNvbnN0IHR5cGUgPSBzZWxlY3Rpb25TZXQucG9zc2libGVUeXBlc1swXTtcbiAgICBjb25zdCBmaWVsZERlZk1hcCA9IHR5cGUuZ2V0RmllbGRzKCk7XG5cbiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIGZpZWxkcykge1xuICAgICAgY29uc3QgZmllbGREZWYgPSBmaWVsZERlZk1hcFtmaWVsZC5uYW1lXTtcblxuICAgICAgaWYgKGZpZWxkRGVmICYmIGZpZWxkRGVmLmRlc2NyaXB0aW9uKSB7XG4gICAgICAgIGZpZWxkLmRlc2NyaXB0aW9uID0gZmllbGREZWYuZGVzY3JpcHRpb247XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZpZWxkcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdyYXBJbkJvb2xlYW5Db25kaXRpb25zSWZOZWVkZWQoXG4gIHNlbGVjdGlvbnM6IFNlbGVjdGlvbltdLFxuICBjb25kaXRpb25zPzogQm9vbGVhbkNvbmRpdGlvbltdXG4pOiBTZWxlY3Rpb25bXSB7XG4gIGlmICghY29uZGl0aW9ucyB8fCBjb25kaXRpb25zLmxlbmd0aCA9PSAwKSByZXR1cm4gc2VsZWN0aW9ucztcblxuICBjb25zdCBbY29uZGl0aW9uLCAuLi5yZXN0XSA9IGNvbmRpdGlvbnM7XG4gIHJldHVybiBbXG4gICAge1xuICAgICAgLi4uY29uZGl0aW9uLFxuICAgICAgc2VsZWN0aW9uU2V0OiB7XG4gICAgICAgIHBvc3NpYmxlVHlwZXM6IGNvbmRpdGlvbi5zZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcyxcbiAgICAgICAgc2VsZWN0aW9uczogd3JhcEluQm9vbGVhbkNvbmRpdGlvbnNJZk5lZWRlZChzZWxlY3Rpb25zLCByZXN0KVxuICAgICAgfVxuICAgIH1cbiAgXTtcbn1cbiJdfQ==");"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function collectAndMergeFields(selectionSet, mergeInFragmentSpreads = true) {
    const groupedFields = new Map();
    function visitSelectionSet(selections, possibleTypes, conditions = []) {
        if (possibleTypes.length < 1)
        return;
        for (const selection of selections) {
            switch (selection.kind) {
                case 'Field':
                    let groupForResponseKey = groupedFields.get(selection.responseKey);
                    if (!groupForResponseKey) {
                        groupForResponseKey = [];
                        groupedFields.set(selection.responseKey, groupForResponseKey);
                    }
                    groupForResponseKey.push(Object.assign({}, selection, { isConditional: conditions.length > 0, conditions, selectionSet: selection.selectionSet ?
                        {
                            possibleTypes: selection.selectionSet.possibleTypes,
                            selections: [...selection.selectionSet.selections] } :

                        undefined }));
                    break;
                case 'FragmentSpread':
                case 'TypeCondition':
                    if (selection.kind === 'FragmentSpread' && !mergeInFragmentSpreads)
                    continue;
                    if (!possibleTypes.every(type => selection.selectionSet.possibleTypes.includes(type)))
                    continue;
                    visitSelectionSet(selection.selectionSet.selections, possibleTypes, conditions);
                    break;
                case 'BooleanCondition':
                    visitSelectionSet(selection.selectionSet.selections, possibleTypes, [...conditions, selection]);
                    break;}

        }
    }
    visitSelectionSet(selectionSet.selections, selectionSet.possibleTypes);
    const fields = Array.from(groupedFields.values()).map(fields => {
        const isFieldIncludedUnconditionally = fields.some(field => !field.isConditional);
        return fields.
        map(field => {
            if (isFieldIncludedUnconditionally && field.isConditional && field.selectionSet) {
                field.selectionSet.selections = wrapInBooleanConditionsIfNeeded(field.selectionSet.selections, field.conditions);
            }
            return field;
        }).
        reduce((field, otherField) => {
            field.isConditional = field.isConditional && otherField.isConditional;
            if (field.conditions && otherField.conditions) {
                field.conditions = [...field.conditions, ...otherField.conditions];
            } else
            {
                field.conditions = undefined;
            }
            if (field.selectionSet && otherField.selectionSet) {
                field.selectionSet.selections.push(...otherField.selectionSet.selections);
            }
            return field;
        });
    });
    if (selectionSet.possibleTypes.length == 1) {
        const type = selectionSet.possibleTypes[0];
        const fieldDefMap = type.getFields();
        for (const field of fields) {
            const fieldDef = fieldDefMap[field.name];
            if (fieldDef && fieldDef.description) {
                field.description = fieldDef.description;
            }
        }
    }
    return fields;
}
exports.collectAndMergeFields = collectAndMergeFields;
function wrapInBooleanConditionsIfNeeded(selections, conditions) {
    if (!conditions || conditions.length == 0)
    return selections;
    const [condition, ...rest] = conditions;
    return [
    Object.assign({}, condition, { selectionSet: {
            possibleTypes: condition.selectionSet.possibleTypes,
            selections: wrapInBooleanConditionsIfNeeded(selections, rest) } })];


}
exports.wrapInBooleanConditionsIfNeeded = wrapInBooleanConditionsIfNeeded;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbGxlY3RBbmRNZXJnZUZpZWxkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVdBLFNBQUEscUJBQUEsQ0FDRSxZQURGLEVBRUUseUJBQWtDLElBRnBDLEVBRXdDO0FBRXRDLFVBQU0sZ0JBQXNDLElBQUksR0FBSixFQUE1QztBQUVBLGFBQUEsaUJBQUEsQ0FDRSxVQURGLEVBRUUsYUFGRixFQUdFLGFBQWlDLEVBSG5DLEVBR3FDO0FBRW5DLFlBQUksY0FBYyxNQUFkLEdBQXVCLENBQTNCO0FBQThCO0FBRTlCLGFBQUssTUFBTSxTQUFYLElBQXdCLFVBQXhCLEVBQW9DO0FBQ2xDLG9CQUFRLFVBQVUsSUFBbEI7QUFDRSxxQkFBSyxPQUFMO0FBQ0Usd0JBQUksc0JBQXNCLGNBQWMsR0FBZCxDQUFrQixVQUFVLFdBQTVCLENBQTFCO0FBQ0Esd0JBQUksQ0FBQyxtQkFBTCxFQUEwQjtBQUN4Qiw4Q0FBc0IsRUFBdEI7QUFDQSxzQ0FBYyxHQUFkLENBQWtCLFVBQVUsV0FBNUIsRUFBeUMsbUJBQXpDO0FBQ0Q7QUFHRCx3Q0FBb0IsSUFBcEIsQ0FBd0IsT0FBQSxNQUFBLENBQUEsRUFBQSxFQUNuQixTQURtQixFQUNWLEVBQ1osZUFBZSxXQUFXLE1BQVgsR0FBb0IsQ0FEdkIsRUFFWixVQUZZLEVBR1osY0FBYyxVQUFVLFlBQVY7QUFDVjtBQUNFLDJDQUFlLFVBQVUsWUFBVixDQUF1QixhQUR4QztBQUVFLHdDQUFZLENBQUMsR0FBRyxVQUFVLFlBQVYsQ0FBdUIsVUFBM0IsQ0FGZCxFQURVOztBQUtWLGlDQVJRLEVBRFUsQ0FBeEI7QUFXQTtBQUNGLHFCQUFLLGdCQUFMO0FBQ0EscUJBQUssZUFBTDtBQUNFLHdCQUFJLFVBQVUsSUFBVixLQUFtQixnQkFBbkIsSUFBdUMsQ0FBQyxzQkFBNUM7QUFBb0U7QUFHcEUsd0JBQUksQ0FBQyxjQUFjLEtBQWQsQ0FBb0IsUUFBUSxVQUFVLFlBQVYsQ0FBdUIsYUFBdkIsQ0FBcUMsUUFBckMsQ0FBOEMsSUFBOUMsQ0FBNUIsQ0FBTDtBQUF1RjtBQUV2RixzQ0FBa0IsVUFBVSxZQUFWLENBQXVCLFVBQXpDLEVBQXFELGFBQXJELEVBQW9FLFVBQXBFO0FBQ0E7QUFDRixxQkFBSyxrQkFBTDtBQUNFLHNDQUFrQixVQUFVLFlBQVYsQ0FBdUIsVUFBekMsRUFBcUQsYUFBckQsRUFBb0UsQ0FBQyxHQUFHLFVBQUosRUFBZ0IsU0FBaEIsQ0FBcEU7QUFDQSwwQkFoQ0o7O0FBa0NEO0FBQ0Y7QUFFRCxzQkFBa0IsYUFBYSxVQUEvQixFQUEyQyxhQUFhLGFBQXhEO0FBSUEsVUFBTSxTQUFTLE1BQU0sSUFBTixDQUFXLGNBQWMsTUFBZCxFQUFYLEVBQW1DLEdBQW5DLENBQXVDLFVBQVM7QUFDN0QsY0FBTSxpQ0FBaUMsT0FBTyxJQUFQLENBQVksU0FBUyxDQUFDLE1BQU0sYUFBNUIsQ0FBdkM7QUFFQSxlQUFPO0FBQ0osV0FESSxDQUNBLFNBQVE7QUFDWCxnQkFBSSxrQ0FBa0MsTUFBTSxhQUF4QyxJQUF5RCxNQUFNLFlBQW5FLEVBQWlGO0FBQy9FLHNCQUFNLFlBQU4sQ0FBbUIsVUFBbkIsR0FBZ0MsZ0NBQzlCLE1BQU0sWUFBTixDQUFtQixVQURXLEVBRTlCLE1BQU0sVUFGd0IsQ0FBaEM7QUFJRDtBQUNELG1CQUFPLEtBQVA7QUFDRCxTQVRJO0FBVUosY0FWSSxDQVVHLENBQUMsS0FBRCxFQUFRLFVBQVIsS0FBc0I7QUFDNUIsa0JBQU0sYUFBTixHQUFzQixNQUFNLGFBQU4sSUFBdUIsV0FBVyxhQUF4RDtBQUtBLGdCQUFJLE1BQU0sVUFBTixJQUFvQixXQUFXLFVBQW5DLEVBQStDO0FBQzdDLHNCQUFNLFVBQU4sR0FBbUIsQ0FBQyxHQUFHLE1BQU0sVUFBVixFQUFzQixHQUFHLFdBQVcsVUFBcEMsQ0FBbkI7QUFDRCxhQUZEO0FBRU87QUFDTCxzQkFBTSxVQUFOLEdBQW1CLFNBQW5CO0FBQ0Q7QUFFRCxnQkFBSSxNQUFNLFlBQU4sSUFBc0IsV0FBVyxZQUFyQyxFQUFtRDtBQUNqRCxzQkFBTSxZQUFOLENBQW1CLFVBQW5CLENBQThCLElBQTlCLENBQW1DLEdBQUcsV0FBVyxZQUFYLENBQXdCLFVBQTlEO0FBQ0Q7QUFFRCxtQkFBTyxLQUFQO0FBQ0QsU0EzQkksQ0FBUDtBQTRCRCxLQS9CYyxDQUFmO0FBa0NBLFFBQUksYUFBYSxhQUFiLENBQTJCLE1BQTNCLElBQXFDLENBQXpDLEVBQTRDO0FBQzFDLGNBQU0sT0FBTyxhQUFhLGFBQWIsQ0FBMkIsQ0FBM0IsQ0FBYjtBQUNBLGNBQU0sY0FBYyxLQUFLLFNBQUwsRUFBcEI7QUFFQSxhQUFLLE1BQU0sS0FBWCxJQUFvQixNQUFwQixFQUE0QjtBQUMxQixrQkFBTSxXQUFXLFlBQVksTUFBTSxJQUFsQixDQUFqQjtBQUVBLGdCQUFJLFlBQVksU0FBUyxXQUF6QixFQUFzQztBQUNwQyxzQkFBTSxXQUFOLEdBQW9CLFNBQVMsV0FBN0I7QUFDRDtBQUNGO0FBQ0Y7QUFFRCxXQUFPLE1BQVA7QUFDRDtBQXZHRCxRQUFBLHFCQUFBLEdBQUEscUJBQUE7QUF5R0EsU0FBQSwrQkFBQSxDQUNFLFVBREYsRUFFRSxVQUZGLEVBRWlDO0FBRS9CLFFBQUksQ0FBQyxVQUFELElBQWUsV0FBVyxNQUFYLElBQXFCLENBQXhDO0FBQTJDLFdBQU8sVUFBUDtBQUUzQyxVQUFNLENBQUMsU0FBRCxFQUFZLEdBQUcsSUFBZixJQUF1QixVQUE3QjtBQUNBLFdBQU87c0JBRUEsUyxFQUFTLEVBQ1osY0FBYztBQUNaLDJCQUFlLFVBQVUsWUFBVixDQUF1QixhQUQxQjtBQUVaLHdCQUFZLGdDQUFnQyxVQUFoQyxFQUE0QyxJQUE1QyxDQUZBLEVBREYsRSxDQUZULENBQVA7OztBQVNEO0FBaEJELFFBQUEsK0JBQUEsR0FBQSwrQkFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlbGVjdGlvblNldCwgU2VsZWN0aW9uLCBGaWVsZCwgQm9vbGVhbkNvbmRpdGlvbiB9IGZyb20gJy4uLyc7XG5pbXBvcnQgeyBHcmFwaFFMT2JqZWN0VHlwZSB9IGZyb20gJ2dyYXBocWwnO1xuXG4vLyBUaGlzIGlzIGEgdGVtcG9yYXJ5IHdvcmthcm91bmQgdG8ga2VlcCB0cmFjayBvZiBjb25kaXRpb25zIG9uIGZpZWxkcyBpbiB0aGUgZmllbGRzIHRoZW1zZWx2ZXMuXG4vLyBJdCBpcyBvbmx5IGFkZGVkIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIGV4cG9zZSBpdCB0byB0aGUgQW5kcm9pZCB0YXJnZXQsIHdoaWNoIHJlbGllcyBvbiB0aGUgbGVnYWN5IElSLlxuZGVjbGFyZSBtb2R1bGUgJy4uLycge1xuICBpbnRlcmZhY2UgRmllbGQge1xuICAgIGNvbmRpdGlvbnM/OiBCb29sZWFuQ29uZGl0aW9uW107XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbGxlY3RBbmRNZXJnZUZpZWxkcyhcbiAgc2VsZWN0aW9uU2V0OiBTZWxlY3Rpb25TZXQsXG4gIG1lcmdlSW5GcmFnbWVudFNwcmVhZHM6IEJvb2xlYW4gPSB0cnVlXG4pOiBGaWVsZFtdIHtcbiAgY29uc3QgZ3JvdXBlZEZpZWxkczogTWFwPHN0cmluZywgRmllbGRbXT4gPSBuZXcgTWFwKCk7XG5cbiAgZnVuY3Rpb24gdmlzaXRTZWxlY3Rpb25TZXQoXG4gICAgc2VsZWN0aW9uczogU2VsZWN0aW9uW10sXG4gICAgcG9zc2libGVUeXBlczogR3JhcGhRTE9iamVjdFR5cGVbXSxcbiAgICBjb25kaXRpb25zOiBCb29sZWFuQ29uZGl0aW9uW10gPSBbXVxuICApIHtcbiAgICBpZiAocG9zc2libGVUeXBlcy5sZW5ndGggPCAxKSByZXR1cm47XG5cbiAgICBmb3IgKGNvbnN0IHNlbGVjdGlvbiBvZiBzZWxlY3Rpb25zKSB7XG4gICAgICBzd2l0Y2ggKHNlbGVjdGlvbi5raW5kKSB7XG4gICAgICAgIGNhc2UgJ0ZpZWxkJzpcbiAgICAgICAgICBsZXQgZ3JvdXBGb3JSZXNwb25zZUtleSA9IGdyb3VwZWRGaWVsZHMuZ2V0KHNlbGVjdGlvbi5yZXNwb25zZUtleSk7XG4gICAgICAgICAgaWYgKCFncm91cEZvclJlc3BvbnNlS2V5KSB7XG4gICAgICAgICAgICBncm91cEZvclJlc3BvbnNlS2V5ID0gW107XG4gICAgICAgICAgICBncm91cGVkRmllbGRzLnNldChzZWxlY3Rpb24ucmVzcG9uc2VLZXksIGdyb3VwRm9yUmVzcG9uc2VLZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBNYWtlIHN1cmUgdG8gZGVlcCBjbG9uZSBzZWxlY3Rpb25zIHRvIGF2b2lkIG1vZGlmeWluZyB0aGUgb3JpZ2luYWwgZmllbGRcbiAgICAgICAgICAvLyBUT0RPOiBTaG91bGQgd2UgdXNlIGFuIG9iamVjdCBmcmVlemluZyAvIGltbXV0YWJpbGl0eSBzb2x1dGlvbj9cbiAgICAgICAgICBncm91cEZvclJlc3BvbnNlS2V5LnB1c2goe1xuICAgICAgICAgICAgLi4uc2VsZWN0aW9uLFxuICAgICAgICAgICAgaXNDb25kaXRpb25hbDogY29uZGl0aW9ucy5sZW5ndGggPiAwLFxuICAgICAgICAgICAgY29uZGl0aW9ucyxcbiAgICAgICAgICAgIHNlbGVjdGlvblNldDogc2VsZWN0aW9uLnNlbGVjdGlvblNldFxuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIHBvc3NpYmxlVHlwZXM6IHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcyxcbiAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbnM6IFsuLi5zZWxlY3Rpb24uc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnNdXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdGcmFnbWVudFNwcmVhZCc6XG4gICAgICAgIGNhc2UgJ1R5cGVDb25kaXRpb24nOlxuICAgICAgICAgIGlmIChzZWxlY3Rpb24ua2luZCA9PT0gJ0ZyYWdtZW50U3ByZWFkJyAmJiAhbWVyZ2VJbkZyYWdtZW50U3ByZWFkcykgY29udGludWU7XG5cbiAgICAgICAgICAvLyBPbmx5IG1lcmdlIGZyYWdtZW50IHNwcmVhZHMgYW5kIHR5cGUgY29uZGl0aW9ucyBpZiB0aGV5IG1hdGNoIGFsbCBwb3NzaWJsZSB0eXBlcy5cbiAgICAgICAgICBpZiAoIXBvc3NpYmxlVHlwZXMuZXZlcnkodHlwZSA9PiBzZWxlY3Rpb24uc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMuaW5jbHVkZXModHlwZSkpKSBjb250aW51ZTtcblxuICAgICAgICAgIHZpc2l0U2VsZWN0aW9uU2V0KHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucywgcG9zc2libGVUeXBlcywgY29uZGl0aW9ucyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ0Jvb2xlYW5Db25kaXRpb24nOlxuICAgICAgICAgIHZpc2l0U2VsZWN0aW9uU2V0KHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucywgcG9zc2libGVUeXBlcywgWy4uLmNvbmRpdGlvbnMsIHNlbGVjdGlvbl0pO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHZpc2l0U2VsZWN0aW9uU2V0KHNlbGVjdGlvblNldC5zZWxlY3Rpb25zLCBzZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcyk7XG5cbiAgLy8gTWVyZ2Ugc2VsZWN0aW9uIHNldHNcblxuICBjb25zdCBmaWVsZHMgPSBBcnJheS5mcm9tKGdyb3VwZWRGaWVsZHMudmFsdWVzKCkpLm1hcChmaWVsZHMgPT4ge1xuICAgIGNvbnN0IGlzRmllbGRJbmNsdWRlZFVuY29uZGl0aW9uYWxseSA9IGZpZWxkcy5zb21lKGZpZWxkID0+ICFmaWVsZC5pc0NvbmRpdGlvbmFsKTtcblxuICAgIHJldHVybiBmaWVsZHNcbiAgICAgIC5tYXAoZmllbGQgPT4ge1xuICAgICAgICBpZiAoaXNGaWVsZEluY2x1ZGVkVW5jb25kaXRpb25hbGx5ICYmIGZpZWxkLmlzQ29uZGl0aW9uYWwgJiYgZmllbGQuc2VsZWN0aW9uU2V0KSB7XG4gICAgICAgICAgZmllbGQuc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMgPSB3cmFwSW5Cb29sZWFuQ29uZGl0aW9uc0lmTmVlZGVkKFxuICAgICAgICAgICAgZmllbGQuc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMsXG4gICAgICAgICAgICBmaWVsZC5jb25kaXRpb25zXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmllbGQ7XG4gICAgICB9KVxuICAgICAgLnJlZHVjZSgoZmllbGQsIG90aGVyRmllbGQpID0+IHtcbiAgICAgICAgZmllbGQuaXNDb25kaXRpb25hbCA9IGZpZWxkLmlzQ29uZGl0aW9uYWwgJiYgb3RoZXJGaWVsZC5pc0NvbmRpdGlvbmFsO1xuXG4gICAgICAgIC8vIEZJWE1FOiBUaGlzIGlzIHN0cmljdGx5IHRha2VuIGluY29ycmVjdCwgYmVjYXVzZSB0aGUgY29uZGl0aW9ucyBzaG91bGQgYmUgT1JlZFxuICAgICAgICAvLyBUaGVzZSBjb25kaXRpb25zIGFyZSBvbmx5IHVzZWQgaW4gQW5kcm9pZCB0YXJnZXQgaG93ZXZlcixcbiAgICAgICAgLy8gYW5kIHRoZXJlIGlzIG5vdyB3YXkgdG8gZXhwcmVzcyB0aGlzIGluIHRoZSBsZWdhY3kgSVIuXG4gICAgICAgIGlmIChmaWVsZC5jb25kaXRpb25zICYmIG90aGVyRmllbGQuY29uZGl0aW9ucykge1xuICAgICAgICAgIGZpZWxkLmNvbmRpdGlvbnMgPSBbLi4uZmllbGQuY29uZGl0aW9ucywgLi4ub3RoZXJGaWVsZC5jb25kaXRpb25zXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaWVsZC5jb25kaXRpb25zID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpZWxkLnNlbGVjdGlvblNldCAmJiBvdGhlckZpZWxkLnNlbGVjdGlvblNldCkge1xuICAgICAgICAgIGZpZWxkLnNlbGVjdGlvblNldC5zZWxlY3Rpb25zLnB1c2goLi4ub3RoZXJGaWVsZC5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmllbGQ7XG4gICAgICB9KTtcbiAgfSk7XG5cbiAgLy8gUmVwbGFjZSBmaWVsZCBkZXNjcmlwdGlvbnMgd2l0aCB0eXBlLXNwZWNpZmljIGRlc2NyaXB0aW9ucyBpZiBwb3NzaWJsZVxuICBpZiAoc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMubGVuZ3RoID09IDEpIHtcbiAgICBjb25zdCB0eXBlID0gc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXNbMF07XG4gICAgY29uc3QgZmllbGREZWZNYXAgPSB0eXBlLmdldEZpZWxkcygpO1xuXG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHtcbiAgICAgIGNvbnN0IGZpZWxkRGVmID0gZmllbGREZWZNYXBbZmllbGQubmFtZV07XG5cbiAgICAgIGlmIChmaWVsZERlZiAmJiBmaWVsZERlZi5kZXNjcmlwdGlvbikge1xuICAgICAgICBmaWVsZC5kZXNjcmlwdGlvbiA9IGZpZWxkRGVmLmRlc2NyaXB0aW9uO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmaWVsZHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cmFwSW5Cb29sZWFuQ29uZGl0aW9uc0lmTmVlZGVkKFxuICBzZWxlY3Rpb25zOiBTZWxlY3Rpb25bXSxcbiAgY29uZGl0aW9ucz86IEJvb2xlYW5Db25kaXRpb25bXVxuKTogU2VsZWN0aW9uW10ge1xuICBpZiAoIWNvbmRpdGlvbnMgfHwgY29uZGl0aW9ucy5sZW5ndGggPT0gMCkgcmV0dXJuIHNlbGVjdGlvbnM7XG5cbiAgY29uc3QgW2NvbmRpdGlvbiwgLi4ucmVzdF0gPSBjb25kaXRpb25zO1xuICByZXR1cm4gW1xuICAgIHtcbiAgICAgIC4uLmNvbmRpdGlvbixcbiAgICAgIHNlbGVjdGlvblNldDoge1xuICAgICAgICBwb3NzaWJsZVR5cGVzOiBjb25kaXRpb24uc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMsXG4gICAgICAgIHNlbGVjdGlvbnM6IHdyYXBJbkJvb2xlYW5Db25kaXRpb25zSWZOZWVkZWQoc2VsZWN0aW9ucywgcmVzdClcbiAgICAgIH1cbiAgICB9XG4gIF07XG59XG4iXSwic291cmNlUm9vdCI6IiJ9