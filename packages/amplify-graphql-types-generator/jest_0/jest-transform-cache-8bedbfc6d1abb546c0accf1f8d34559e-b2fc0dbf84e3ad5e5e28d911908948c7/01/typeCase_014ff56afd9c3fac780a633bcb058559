4b3e47c72341615441ecb224edc840c8
'use strict';require('ts-jest').install("/c/Users/Sandro/repo/amplify-cli/packages/amplify-graphql-types-generator/src/compiler/visitors/typeCase.ts", "\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst util_1 = require(\"util\");\nconst collectAndMergeFields_1 = require(\"./collectAndMergeFields\");\nclass Variant {\n    constructor(possibleTypes, selections = [], fragmentSpreads = []) {\n        this.possibleTypes = possibleTypes;\n        this.selections = selections;\n        this.fragmentSpreads = fragmentSpreads;\n    }\n    get fields() {\n        return collectAndMergeFields_1.collectAndMergeFields(this);\n    }\n    inspect() {\n        return `${util_1.inspect(this.possibleTypes)} -> ${util_1.inspect(collectAndMergeFields_1.collectAndMergeFields(this, false).map(field => field.responseKey))} ${util_1.inspect(this.fragmentSpreads.map(fragmentSpread => fragmentSpread.fragmentName))}\\n`;\n    }\n}\nexports.Variant = Variant;\nfunction typeCaseForSelectionSet(selectionSet, mergeInFragmentSpreads = true) {\n    const typeCase = new TypeCase(selectionSet.possibleTypes);\n    for (const selection of selectionSet.selections) {\n        switch (selection.kind) {\n            case 'Field':\n                for (const variant of typeCase.disjointVariantsFor(selectionSet.possibleTypes)) {\n                    variant.selections.push(selection);\n                }\n                break;\n            case 'FragmentSpread':\n                if (typeCase.default.fragmentSpreads.some(fragmentSpread => fragmentSpread.fragmentName === selection.fragmentName))\n                    continue;\n                for (const variant of typeCase.disjointVariantsFor(selectionSet.possibleTypes)) {\n                    variant.fragmentSpreads.push(selection);\n                    if (!mergeInFragmentSpreads) {\n                        variant.selections.push(selection);\n                    }\n                }\n                if (mergeInFragmentSpreads) {\n                    typeCase.merge(typeCaseForSelectionSet({\n                        possibleTypes: selectionSet.possibleTypes.filter(type => selection.selectionSet.possibleTypes.includes(type)),\n                        selections: selection.selectionSet.selections\n                    }, mergeInFragmentSpreads));\n                }\n                break;\n            case 'TypeCondition':\n                typeCase.merge(typeCaseForSelectionSet({\n                    possibleTypes: selectionSet.possibleTypes.filter(type => selection.selectionSet.possibleTypes.includes(type)),\n                    selections: selection.selectionSet.selections\n                }, mergeInFragmentSpreads));\n                break;\n            case 'BooleanCondition':\n                typeCase.merge(typeCaseForSelectionSet(selection.selectionSet, mergeInFragmentSpreads), selectionSet => [\n                    Object.assign({}, selection, { selectionSet })\n                ]);\n                break;\n        }\n    }\n    return typeCase;\n}\nexports.typeCaseForSelectionSet = typeCaseForSelectionSet;\nclass TypeCase {\n    get variants() {\n        return Array.from(new Set(this.variantsByType.values()));\n    }\n    get defaultAndVariants() {\n        return [this.default, ...this.variants];\n    }\n    get remainder() {\n        if (this.default.possibleTypes.some(type => !this.variantsByType.has(type))) {\n            return new Variant(this.default.possibleTypes.filter(type => !this.variantsByType.has(type)), this.default.selections, this.default.fragmentSpreads);\n        }\n        else {\n            return undefined;\n        }\n    }\n    get exhaustiveVariants() {\n        const remainder = this.remainder;\n        if (remainder) {\n            return [remainder, ...this.variants];\n        }\n        else {\n            return this.variants;\n        }\n    }\n    constructor(possibleTypes) {\n        this.default = new Variant(possibleTypes);\n        this.variantsByType = new Map();\n    }\n    disjointVariantsFor(possibleTypes) {\n        const variants = [];\n        const matchesDefault = this.default.possibleTypes.every(type => possibleTypes.includes(type));\n        if (matchesDefault) {\n            variants.push(this.default);\n        }\n        const splits = new Map();\n        for (const type of possibleTypes) {\n            let original = this.variantsByType.get(type);\n            if (!original) {\n                if (matchesDefault)\n                    continue;\n                original = this.default;\n            }\n            let split = splits.get(original);\n            if (!split) {\n                split = new Variant([], [...original.selections], [...original.fragmentSpreads]);\n                splits.set(original, split);\n                variants.push(split);\n            }\n            if (original !== this.default) {\n                original.possibleTypes.splice(original.possibleTypes.indexOf(type), 1);\n            }\n            this.variantsByType.set(type, split);\n            split.possibleTypes.push(type);\n        }\n        return variants;\n    }\n    merge(otherTypeCase, transform) {\n        for (const otherVariant of otherTypeCase.defaultAndVariants) {\n            if (otherVariant.selections.length < 1)\n                continue;\n            for (const variant of this.disjointVariantsFor(otherVariant.possibleTypes)) {\n                if (otherVariant.fragmentSpreads.length > 0) {\n                    variant.fragmentSpreads = [...variant.fragmentSpreads, ...otherVariant.fragmentSpreads].filter((a, index, array) => array.findIndex(b => b.fragmentName == a.fragmentName) == index);\n                }\n                variant.selections.push(...(transform ? transform(otherVariant) : otherVariant.selections));\n            }\n        }\n    }\n    inspect() {\n        return (`TypeCase\\n` +\n            `  default -> ${util_1.inspect(this.default)}\\n` +\n            this.variants.map(variant => `  ${util_1.inspect(variant)}\\n`).join(''));\n    }\n}\nexports.TypeCase = TypeCase;\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZUNhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0eXBlQ2FzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUsvQixtRUFBZ0U7QUFFaEU7SUFDRSxZQUNTLGFBQWtDLEVBQ2xDLGFBQTBCLEVBQUUsRUFDNUIsa0JBQW9DLEVBQUU7UUFGdEMsa0JBQWEsR0FBYixhQUFhLENBQXFCO1FBQ2xDLGVBQVUsR0FBVixVQUFVLENBQWtCO1FBQzVCLG9CQUFlLEdBQWYsZUFBZSxDQUF1QjtJQUM1QyxDQUFDO0lBRUosSUFBSSxNQUFNO1FBQ1IsT0FBTyw2Q0FBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sR0FBRyxjQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLGNBQU8sQ0FDakQsNkNBQXFCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FDbkUsSUFBSSxjQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQzVGLENBQUM7Q0FDRjtBQWhCRCwwQkFnQkM7QUFFRCxpQ0FDRSxZQUEwQixFQUMxQix5QkFBa0MsSUFBSTtJQUV0QyxNQUFNLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFMUQsS0FBSyxNQUFNLFNBQVMsSUFBSSxZQUFZLENBQUMsVUFBVSxFQUFFO1FBQy9DLFFBQVEsU0FBUyxDQUFDLElBQUksRUFBRTtZQUN0QixLQUFLLE9BQU87Z0JBQ1YsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxFQUFFO29CQUM5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QyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxDQUNyRixDQUFDO2lCQUNIO2dCQUNELE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7YUFDN0Y7U0FDRjtJQUNILENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxDQUNMLFlBQVk7WUFDWixnQkFBZ0IsY0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSTtZQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssY0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQ2pFLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1R0QsNEJBNEdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5zcGVjdCB9IGZyb20gJ3V0aWwnO1xuXG5pbXBvcnQgeyBHcmFwaFFMT2JqZWN0VHlwZSB9IGZyb20gJ2dyYXBocWwnO1xuXG5pbXBvcnQgeyBTZWxlY3Rpb25TZXQsIFNlbGVjdGlvbiwgRmllbGQsIEZyYWdtZW50U3ByZWFkIH0gZnJvbSAnLi4vJztcbmltcG9ydCB7IGNvbGxlY3RBbmRNZXJnZUZpZWxkcyB9IGZyb20gJy4vY29sbGVjdEFuZE1lcmdlRmllbGRzJztcblxuZXhwb3J0IGNsYXNzIFZhcmlhbnQgaW1wbGVtZW50cyBTZWxlY3Rpb25TZXQge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcG9zc2libGVUeXBlczogR3JhcGhRTE9iamVjdFR5cGVbXSxcbiAgICBwdWJsaWMgc2VsZWN0aW9uczogU2VsZWN0aW9uW10gPSBbXSxcbiAgICBwdWJsaWMgZnJhZ21lbnRTcHJlYWRzOiBGcmFnbWVudFNwcmVhZFtdID0gW11cbiAgKSB7fVxuXG4gIGdldCBmaWVsZHMoKTogRmllbGRbXSB7XG4gICAgcmV0dXJuIGNvbGxlY3RBbmRNZXJnZUZpZWxkcyh0aGlzKTtcbiAgfVxuXG4gIGluc3BlY3QoKSB7XG4gICAgcmV0dXJuIGAke2luc3BlY3QodGhpcy5wb3NzaWJsZVR5cGVzKX0gLT4gJHtpbnNwZWN0KFxuICAgICAgY29sbGVjdEFuZE1lcmdlRmllbGRzKHRoaXMsIGZhbHNlKS5tYXAoZmllbGQgPT4gZmllbGQucmVzcG9uc2VLZXkpXG4gICAgKX0gJHtpbnNwZWN0KHRoaXMuZnJhZ21lbnRTcHJlYWRzLm1hcChmcmFnbWVudFNwcmVhZCA9PiBmcmFnbWVudFNwcmVhZC5mcmFnbWVudE5hbWUpKX1cXG5gO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0eXBlQ2FzZUZvclNlbGVjdGlvblNldChcbiAgc2VsZWN0aW9uU2V0OiBTZWxlY3Rpb25TZXQsXG4gIG1lcmdlSW5GcmFnbWVudFNwcmVhZHM6IGJvb2xlYW4gPSB0cnVlXG4pOiBUeXBlQ2FzZSB7XG4gIGNvbnN0IHR5cGVDYXNlID0gbmV3IFR5cGVDYXNlKHNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzKTtcblxuICBmb3IgKGNvbnN0IHNlbGVjdGlvbiBvZiBzZWxlY3Rpb25TZXQuc2VsZWN0aW9ucykge1xuICAgIHN3aXRjaCAoc2VsZWN0aW9uLmtpbmQpIHtcbiAgICAgIGNhc2UgJ0ZpZWxkJzpcbiAgICAgICAgZm9yIChjb25zdCB2YXJpYW50IG9mIHR5cGVDYXNlLmRpc2pvaW50VmFyaWFudHNGb3Ioc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMpKSB7XG4gICAgICAgICAgdmFyaWFudC5zZWxlY3Rpb25zLnB1c2goc2VsZWN0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0ZyYWdtZW50U3ByZWFkJzpcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHR5cGVDYXNlLmRlZmF1bHQuZnJhZ21lbnRTcHJlYWRzLnNvbWUoXG4gICAgICAgICAgICBmcmFnbWVudFNwcmVhZCA9PiBmcmFnbWVudFNwcmVhZC5mcmFnbWVudE5hbWUgPT09IHNlbGVjdGlvbi5mcmFnbWVudE5hbWVcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICBmb3IgKGNvbnN0IHZhcmlhbnQgb2YgdHlwZUNhc2UuZGlzam9pbnRWYXJpYW50c0ZvcihzZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcykpIHtcbiAgICAgICAgICB2YXJpYW50LmZyYWdtZW50U3ByZWFkcy5wdXNoKHNlbGVjdGlvbik7XG5cbiAgICAgICAgICBpZiAoIW1lcmdlSW5GcmFnbWVudFNwcmVhZHMpIHtcbiAgICAgICAgICAgIHZhcmlhbnQuc2VsZWN0aW9ucy5wdXNoKHNlbGVjdGlvbik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChtZXJnZUluRnJhZ21lbnRTcHJlYWRzKSB7XG4gICAgICAgICAgdHlwZUNhc2UubWVyZ2UoXG4gICAgICAgICAgICB0eXBlQ2FzZUZvclNlbGVjdGlvblNldChcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHBvc3NpYmxlVHlwZXM6IHNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzLmZpbHRlcih0eXBlID0+XG4gICAgICAgICAgICAgICAgICBzZWxlY3Rpb24uc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMuaW5jbHVkZXModHlwZSlcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbnM6IHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQuc2VsZWN0aW9uc1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBtZXJnZUluRnJhZ21lbnRTcHJlYWRzXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1R5cGVDb25kaXRpb24nOlxuICAgICAgICB0eXBlQ2FzZS5tZXJnZShcbiAgICAgICAgICB0eXBlQ2FzZUZvclNlbGVjdGlvblNldChcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcG9zc2libGVUeXBlczogc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMuZmlsdGVyKHR5cGUgPT5cbiAgICAgICAgICAgICAgICBzZWxlY3Rpb24uc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMuaW5jbHVkZXModHlwZSlcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgc2VsZWN0aW9uczogc2VsZWN0aW9uLnNlbGVjdGlvblNldC5zZWxlY3Rpb25zXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWVyZ2VJbkZyYWdtZW50U3ByZWFkc1xuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdCb29sZWFuQ29uZGl0aW9uJzpcbiAgICAgICAgdHlwZUNhc2UubWVyZ2UoXG4gICAgICAgICAgdHlwZUNhc2VGb3JTZWxlY3Rpb25TZXQoc2VsZWN0aW9uLnNlbGVjdGlvblNldCwgbWVyZ2VJbkZyYWdtZW50U3ByZWFkcyksXG4gICAgICAgICAgc2VsZWN0aW9uU2V0ID0+IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgLi4uc2VsZWN0aW9uLFxuICAgICAgICAgICAgICBzZWxlY3Rpb25TZXRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0eXBlQ2FzZTtcbn1cblxuZXhwb3J0IGNsYXNzIFR5cGVDYXNlIHtcbiAgZGVmYXVsdDogVmFyaWFudDtcbiAgcHJpdmF0ZSB2YXJpYW50c0J5VHlwZTogTWFwPEdyYXBoUUxPYmplY3RUeXBlLCBWYXJpYW50PjtcblxuICBnZXQgdmFyaWFudHMoKTogVmFyaWFudFtdIHtcbiAgICAvLyBVbmlxdWUgdGhlIHZhcmlhbnRzIGJlZm9yZSByZXR1cm5pbmcgdGhlbS5cbiAgICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KHRoaXMudmFyaWFudHNCeVR5cGUudmFsdWVzKCkpKTtcbiAgfVxuXG4gIGdldCBkZWZhdWx0QW5kVmFyaWFudHMoKTogVmFyaWFudFtdIHtcbiAgICByZXR1cm4gW3RoaXMuZGVmYXVsdCwgLi4udGhpcy52YXJpYW50c107XG4gIH1cblxuICBnZXQgcmVtYWluZGVyKCk6IFZhcmlhbnQgfCB1bmRlZmluZWQge1xuICAgIGlmICh0aGlzLmRlZmF1bHQucG9zc2libGVUeXBlcy5zb21lKHR5cGUgPT4gIXRoaXMudmFyaWFudHNCeVR5cGUuaGFzKHR5cGUpKSkge1xuICAgICAgcmV0dXJuIG5ldyBWYXJpYW50KFxuICAgICAgICB0aGlzLmRlZmF1bHQucG9zc2libGVUeXBlcy5maWx0ZXIodHlwZSA9PiAhdGhpcy52YXJpYW50c0J5VHlwZS5oYXModHlwZSkpLFxuICAgICAgICB0aGlzLmRlZmF1bHQuc2VsZWN0aW9ucyxcbiAgICAgICAgdGhpcy5kZWZhdWx0LmZyYWdtZW50U3ByZWFkc1xuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBnZXQgZXhoYXVzdGl2ZVZhcmlhbnRzKCk6IFZhcmlhbnRbXSB7XG4gICAgY29uc3QgcmVtYWluZGVyID0gdGhpcy5yZW1haW5kZXI7XG4gICAgaWYgKHJlbWFpbmRlcikge1xuICAgICAgcmV0dXJuIFtyZW1haW5kZXIsIC4uLnRoaXMudmFyaWFudHNdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy52YXJpYW50cztcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwb3NzaWJsZVR5cGVzOiBHcmFwaFFMT2JqZWN0VHlwZVtdKSB7XG4gICAgLy8gV2Ugc3RhcnQgb3V0IHdpdGggYSBzaW5nbGUgZGVmYXVsdCB2YXJpYW50IHRoYXQgcmVwcmVzZW50cyBhbGwgcG9zc2libGUgdHlwZXMgb2YgdGhlIHNlbGVjdGlvbiBzZXQuXG4gICAgdGhpcy5kZWZhdWx0ID0gbmV3IFZhcmlhbnQocG9zc2libGVUeXBlcyk7XG5cbiAgICB0aGlzLnZhcmlhbnRzQnlUeXBlID0gbmV3IE1hcCgpO1xuICB9XG5cbiAgLy8gUmV0dXJucyByZWNvcmRzIHJlcHJlc2VudGluZyBhIHNldCBvZiBwb3NzaWJsZSB0eXBlcywgbWFraW5nIHN1cmUgdGhleSBhcmUgZGlzam9pbnQgd2l0aCBvdGhlciBwb3NzaWJsZSB0eXBlcy5cbiAgLy8gVGhhdCBtYXkgaW52b2x2ZSByZWZpbmluZyB0aGUgZXhpc3RpbmcgcGFydGl0aW9uIChodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9QYXJ0aXRpb25fcmVmaW5lbWVudClcbiAgLy8gd2l0aCB0aGUgcGFzc2VkIGluIHNldCBvZiBwb3NzaWJsZSB0eXBlcy5cbiAgZGlzam9pbnRWYXJpYW50c0Zvcihwb3NzaWJsZVR5cGVzOiBHcmFwaFFMT2JqZWN0VHlwZVtdKTogVmFyaWFudFtdIHtcbiAgICBjb25zdCB2YXJpYW50czogVmFyaWFudFtdID0gW107XG5cbiAgICBjb25zdCBtYXRjaGVzRGVmYXVsdCA9IHRoaXMuZGVmYXVsdC5wb3NzaWJsZVR5cGVzLmV2ZXJ5KHR5cGUgPT4gcG9zc2libGVUeXBlcy5pbmNsdWRlcyh0eXBlKSk7XG5cbiAgICBpZiAobWF0Y2hlc0RlZmF1bHQpIHtcbiAgICAgIHZhcmlhbnRzLnB1c2godGhpcy5kZWZhdWx0KTtcbiAgICB9XG5cbiAgICAvLyBXZSBrZWVwIGEgbWFwIGZyb20gb3JpZ2luYWwgcmVjb3JkcyB0byBzcGxpdCByZWNvcmRzLiBXZSdsbCB0aGVuIHJlbW92ZSBwb3NzaWJsZSB0eXBlcyBmcm9tIHRoZVxuICAgIC8vIG9yaWdpbmFsIHJlY29yZCBhbmQgbW92ZSB0aGVtIHRvIHRoZSBzcGxpdCByZWNvcmQuXG4gICAgLy8gVGhpcyBtZWFucyB0aGUgb3JpZ2luYWwgcmVjb3JkIHdpbGwgYmUgbW9kaWZpZWQgdG8gcmVwcmVzZW50IHRoZSBzZXQgdGhlb3JldGljYWwgZGlmZmVyZW5jZSBiZXR3ZWVuXG4gICAgLy8gdGhlIG9yaWdpbmFsIHNldCBvZiBwb3NzaWJsZSB0eXBlcyBhbmQgdGhlIHJlZmluZW1lbnQgc2V0LCBhbmQgdGhlIHNwbGl0IHJlY29yZCB3aWxsIHJlcHJlc2VudCB0aGVcbiAgICAvLyBpbnRlcnNlY3Rpb24uXG4gICAgY29uc3Qgc3BsaXRzOiBNYXA8VmFyaWFudCwgVmFyaWFudD4gPSBuZXcgTWFwKCk7XG5cbiAgICBmb3IgKGNvbnN0IHR5cGUgb2YgcG9zc2libGVUeXBlcykge1xuICAgICAgbGV0IG9yaWdpbmFsID0gdGhpcy52YXJpYW50c0J5VHlwZS5nZXQodHlwZSk7XG5cbiAgICAgIGlmICghb3JpZ2luYWwpIHtcbiAgICAgICAgaWYgKG1hdGNoZXNEZWZhdWx0KSBjb250aW51ZTtcbiAgICAgICAgb3JpZ2luYWwgPSB0aGlzLmRlZmF1bHQ7XG4gICAgICB9XG5cbiAgICAgIGxldCBzcGxpdCA9IHNwbGl0cy5nZXQob3JpZ2luYWwpO1xuICAgICAgaWYgKCFzcGxpdCkge1xuICAgICAgICBzcGxpdCA9IG5ldyBWYXJpYW50KFtdLCBbLi4ub3JpZ2luYWwuc2VsZWN0aW9uc10sIFsuLi5vcmlnaW5hbC5mcmFnbWVudFNwcmVhZHNdKTtcbiAgICAgICAgc3BsaXRzLnNldChvcmlnaW5hbCwgc3BsaXQpO1xuICAgICAgICB2YXJpYW50cy5wdXNoKHNwbGl0KTtcbiAgICAgIH1cblxuICAgICAgaWYgKG9yaWdpbmFsICE9PSB0aGlzLmRlZmF1bHQpIHtcbiAgICAgICAgb3JpZ2luYWwucG9zc2libGVUeXBlcy5zcGxpY2Uob3JpZ2luYWwucG9zc2libGVUeXBlcy5pbmRleE9mKHR5cGUpLCAxKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy52YXJpYW50c0J5VHlwZS5zZXQodHlwZSwgc3BsaXQpO1xuICAgICAgc3BsaXQucG9zc2libGVUeXBlcy5wdXNoKHR5cGUpO1xuICAgIH1cblxuICAgIHJldHVybiB2YXJpYW50cztcbiAgfVxuXG4gIG1lcmdlKG90aGVyVHlwZUNhc2U6IFR5cGVDYXNlLCB0cmFuc2Zvcm0/OiAoc2VsZWN0aW9uU2V0OiBTZWxlY3Rpb25TZXQpID0+IFNlbGVjdGlvbltdKSB7XG4gICAgZm9yIChjb25zdCBvdGhlclZhcmlhbnQgb2Ygb3RoZXJUeXBlQ2FzZS5kZWZhdWx0QW5kVmFyaWFudHMpIHtcbiAgICAgIGlmIChvdGhlclZhcmlhbnQuc2VsZWN0aW9ucy5sZW5ndGggPCAxKSBjb250aW51ZTtcbiAgICAgIGZvciAoY29uc3QgdmFyaWFudCBvZiB0aGlzLmRpc2pvaW50VmFyaWFudHNGb3Iob3RoZXJWYXJpYW50LnBvc3NpYmxlVHlwZXMpKSB7XG4gICAgICAgIGlmIChvdGhlclZhcmlhbnQuZnJhZ21lbnRTcHJlYWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyBVbmlvbiBvZiB2YXJpYW50LmZyYWdtZW50U3ByZWFkcyBhbmQgb3RoZXJWYXJpYW50LmZyYWdtZW50U3ByZWFkc1xuICAgICAgICAgIHZhcmlhbnQuZnJhZ21lbnRTcHJlYWRzID0gWy4uLnZhcmlhbnQuZnJhZ21lbnRTcHJlYWRzLCAuLi5vdGhlclZhcmlhbnQuZnJhZ21lbnRTcHJlYWRzXS5maWx0ZXIoXG4gICAgICAgICAgICAoYSwgaW5kZXgsIGFycmF5KSA9PiBhcnJheS5maW5kSW5kZXgoYiA9PiBiLmZyYWdtZW50TmFtZSA9PSBhLmZyYWdtZW50TmFtZSkgPT0gaW5kZXhcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHZhcmlhbnQuc2VsZWN0aW9ucy5wdXNoKC4uLih0cmFuc2Zvcm0gPyB0cmFuc2Zvcm0ob3RoZXJWYXJpYW50KSA6IG90aGVyVmFyaWFudC5zZWxlY3Rpb25zKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaW5zcGVjdCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgYFR5cGVDYXNlXFxuYCArXG4gICAgICBgICBkZWZhdWx0IC0+ICR7aW5zcGVjdCh0aGlzLmRlZmF1bHQpfVxcbmAgK1xuICAgICAgdGhpcy52YXJpYW50cy5tYXAodmFyaWFudCA9PiBgICAke2luc3BlY3QodmFyaWFudCl9XFxuYCkuam9pbignJylcbiAgICApO1xuICB9XG59XG4iXX0=");"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const collectAndMergeFields_1 = require("./collectAndMergeFields");
class Variant {
    constructor(possibleTypes, selections = [], fragmentSpreads = []) {
        this.possibleTypes = possibleTypes;
        this.selections = selections;
        this.fragmentSpreads = fragmentSpreads;
    }
    get fields() {
        return collectAndMergeFields_1.collectAndMergeFields(this);
    }
    inspect() {
        return `${util_1.inspect(this.possibleTypes)} -> ${util_1.inspect(collectAndMergeFields_1.collectAndMergeFields(this, false).map(field => field.responseKey))} ${util_1.inspect(this.fragmentSpreads.map(fragmentSpread => fragmentSpread.fragmentName))}\n`;
    }}

exports.Variant = Variant;
function typeCaseForSelectionSet(selectionSet, mergeInFragmentSpreads = true) {
    const typeCase = new TypeCase(selectionSet.possibleTypes);
    for (const selection of selectionSet.selections) {
        switch (selection.kind) {
            case 'Field':
                for (const variant of typeCase.disjointVariantsFor(selectionSet.possibleTypes)) {
                    variant.selections.push(selection);
                }
                break;
            case 'FragmentSpread':
                if (typeCase.default.fragmentSpreads.some(fragmentSpread => fragmentSpread.fragmentName === selection.fragmentName))
                continue;
                for (const variant of typeCase.disjointVariantsFor(selectionSet.possibleTypes)) {
                    variant.fragmentSpreads.push(selection);
                    if (!mergeInFragmentSpreads) {
                        variant.selections.push(selection);
                    }
                }
                if (mergeInFragmentSpreads) {
                    typeCase.merge(typeCaseForSelectionSet({
                        possibleTypes: selectionSet.possibleTypes.filter(type => selection.selectionSet.possibleTypes.includes(type)),
                        selections: selection.selectionSet.selections },
                    mergeInFragmentSpreads));
                }
                break;
            case 'TypeCondition':
                typeCase.merge(typeCaseForSelectionSet({
                    possibleTypes: selectionSet.possibleTypes.filter(type => selection.selectionSet.possibleTypes.includes(type)),
                    selections: selection.selectionSet.selections },
                mergeInFragmentSpreads));
                break;
            case 'BooleanCondition':
                typeCase.merge(typeCaseForSelectionSet(selection.selectionSet, mergeInFragmentSpreads), selectionSet => [
                Object.assign({}, selection, { selectionSet })]);

                break;}

    }
    return typeCase;
}
exports.typeCaseForSelectionSet = typeCaseForSelectionSet;
class TypeCase {
    get variants() {
        return Array.from(new Set(this.variantsByType.values()));
    }
    get defaultAndVariants() {
        return [this.default, ...this.variants];
    }
    get remainder() {
        if (this.default.possibleTypes.some(type => !this.variantsByType.has(type))) {
            return new Variant(this.default.possibleTypes.filter(type => !this.variantsByType.has(type)), this.default.selections, this.default.fragmentSpreads);
        } else
        {
            return undefined;
        }
    }
    get exhaustiveVariants() {
        const remainder = this.remainder;
        if (remainder) {
            return [remainder, ...this.variants];
        } else
        {
            return this.variants;
        }
    }
    constructor(possibleTypes) {
        this.default = new Variant(possibleTypes);
        this.variantsByType = new Map();
    }
    disjointVariantsFor(possibleTypes) {
        const variants = [];
        const matchesDefault = this.default.possibleTypes.every(type => possibleTypes.includes(type));
        if (matchesDefault) {
            variants.push(this.default);
        }
        const splits = new Map();
        for (const type of possibleTypes) {
            let original = this.variantsByType.get(type);
            if (!original) {
                if (matchesDefault)
                continue;
                original = this.default;
            }
            let split = splits.get(original);
            if (!split) {
                split = new Variant([], [...original.selections], [...original.fragmentSpreads]);
                splits.set(original, split);
                variants.push(split);
            }
            if (original !== this.default) {
                original.possibleTypes.splice(original.possibleTypes.indexOf(type), 1);
            }
            this.variantsByType.set(type, split);
            split.possibleTypes.push(type);
        }
        return variants;
    }
    merge(otherTypeCase, transform) {
        for (const otherVariant of otherTypeCase.defaultAndVariants) {
            if (otherVariant.selections.length < 1)
            continue;
            for (const variant of this.disjointVariantsFor(otherVariant.possibleTypes)) {
                if (otherVariant.fragmentSpreads.length > 0) {
                    variant.fragmentSpreads = [...variant.fragmentSpreads, ...otherVariant.fragmentSpreads].filter((a, index, array) => array.findIndex(b => b.fragmentName == a.fragmentName) == index);
                }
                variant.selections.push(...(transform ? transform(otherVariant) : otherVariant.selections));
            }
        }
    }
    inspect() {
        return `TypeCase\n` +
        `  default -> ${util_1.inspect(this.default)}\n` +
        this.variants.map(variant => `  ${util_1.inspect(variant)}\n`).join('');
    }}

exports.TypeCase = TypeCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInR5cGVDYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBQSxTQUFBLFFBQUEsTUFBQSxDQUFBO0FBS0EsTUFBQSwwQkFBQSxRQUFBLHlCQUFBLENBQUE7QUFFQSxNQUFBLE9BQUEsQ0FBQTtBQUNFLGdCQUNTLGFBRFQsRUFFUyxhQUEwQixFQUZuQyxFQUdTLGtCQUFvQyxFQUg3QyxFQUcrQztBQUZ0QyxhQUFBLGFBQUEsR0FBQSxhQUFBO0FBQ0EsYUFBQSxVQUFBLEdBQUEsVUFBQTtBQUNBLGFBQUEsZUFBQSxHQUFBLGVBQUE7QUFDTDtBQUVKLFFBQUksTUFBSixHQUFVO0FBQ1IsZUFBTyx3QkFBQSxxQkFBQSxDQUFzQixJQUF0QixDQUFQO0FBQ0Q7QUFFRCxjQUFPO0FBQ0wsZUFBTyxHQUFHLE9BQUEsT0FBQSxDQUFRLEtBQUssYUFBYixDQUEyQixPQUFPLE9BQUEsT0FBQSxDQUMxQyx3QkFBQSxxQkFBQSxDQUFzQixJQUF0QixFQUE0QixLQUE1QixFQUFtQyxHQUFuQyxDQUF1QyxTQUFTLE1BQU0sV0FBdEQsQ0FEMEMsQ0FFM0MsSUFBSSxPQUFBLE9BQUEsQ0FBUSxLQUFLLGVBQUwsQ0FBcUIsR0FBckIsQ0FBeUIsa0JBQWtCLGVBQWUsWUFBMUQsQ0FBUixDQUFnRixJQUZyRjtBQUdELEtBZkg7O0FBQUEsUUFBQSxPQUFBLEdBQUEsT0FBQTtBQWtCQSxTQUFBLHVCQUFBLENBQ0UsWUFERixFQUVFLHlCQUFrQyxJQUZwQyxFQUV3QztBQUV0QyxVQUFNLFdBQVcsSUFBSSxRQUFKLENBQWEsYUFBYSxhQUExQixDQUFqQjtBQUVBLFNBQUssTUFBTSxTQUFYLElBQXdCLGFBQWEsVUFBckMsRUFBaUQ7QUFDL0MsZ0JBQVEsVUFBVSxJQUFsQjtBQUNFLGlCQUFLLE9BQUw7QUFDRSxxQkFBSyxNQUFNLE9BQVgsSUFBc0IsU0FBUyxtQkFBVCxDQUE2QixhQUFhLGFBQTFDLENBQXRCLEVBQWdGO0FBQzlFLDRCQUFRLFVBQVIsQ0FBbUIsSUFBbkIsQ0FBd0IsU0FBeEI7QUFDRDtBQUNEO0FBQ0YsaUJBQUssZ0JBQUw7QUFDRSxvQkFDRSxTQUFTLE9BQVQsQ0FBaUIsZUFBakIsQ0FBaUMsSUFBakMsQ0FDRSxrQkFBa0IsZUFBZSxZQUFmLEtBQWdDLFVBQVUsWUFEOUQsQ0FERjtBQUtFO0FBRUYscUJBQUssTUFBTSxPQUFYLElBQXNCLFNBQVMsbUJBQVQsQ0FBNkIsYUFBYSxhQUExQyxDQUF0QixFQUFnRjtBQUM5RSw0QkFBUSxlQUFSLENBQXdCLElBQXhCLENBQTZCLFNBQTdCO0FBRUEsd0JBQUksQ0FBQyxzQkFBTCxFQUE2QjtBQUMzQixnQ0FBUSxVQUFSLENBQW1CLElBQW5CLENBQXdCLFNBQXhCO0FBQ0Q7QUFDRjtBQUNELG9CQUFJLHNCQUFKLEVBQTRCO0FBQzFCLDZCQUFTLEtBQVQsQ0FDRSx3QkFDRTtBQUNFLHVDQUFlLGFBQWEsYUFBYixDQUEyQixNQUEzQixDQUFrQyxRQUMvQyxVQUFVLFlBQVYsQ0FBdUIsYUFBdkIsQ0FBcUMsUUFBckMsQ0FBOEMsSUFBOUMsQ0FEYSxDQURqQjtBQUlFLG9DQUFZLFVBQVUsWUFBVixDQUF1QixVQUpyQyxFQURGO0FBT0UsMENBUEYsQ0FERjtBQVdEO0FBQ0Q7QUFDRixpQkFBSyxlQUFMO0FBQ0UseUJBQVMsS0FBVCxDQUNFLHdCQUNFO0FBQ0UsbUNBQWUsYUFBYSxhQUFiLENBQTJCLE1BQTNCLENBQWtDLFFBQy9DLFVBQVUsWUFBVixDQUF1QixhQUF2QixDQUFxQyxRQUFyQyxDQUE4QyxJQUE5QyxDQURhLENBRGpCO0FBSUUsZ0NBQVksVUFBVSxZQUFWLENBQXVCLFVBSnJDLEVBREY7QUFPRSxzQ0FQRixDQURGO0FBV0E7QUFDRixpQkFBSyxrQkFBTDtBQUNFLHlCQUFTLEtBQVQsQ0FDRSx3QkFBd0IsVUFBVSxZQUFsQyxFQUFnRCxzQkFBaEQsQ0FERixFQUVFLGdCQUFnQjtrQ0FFVCxTLEVBQVMsRUFDWixZQURZLEUsQ0FGQSxDQUZsQjs7QUFTQSxzQkExREo7O0FBNEREO0FBRUQsV0FBTyxRQUFQO0FBQ0Q7QUF0RUQsUUFBQSx1QkFBQSxHQUFBLHVCQUFBO0FBd0VBLE1BQUEsUUFBQSxDQUFBO0FBSUUsUUFBSSxRQUFKLEdBQVk7QUFFVixlQUFPLE1BQU0sSUFBTixDQUFXLElBQUksR0FBSixDQUFRLEtBQUssY0FBTCxDQUFvQixNQUFwQixFQUFSLENBQVgsQ0FBUDtBQUNEO0FBRUQsUUFBSSxrQkFBSixHQUFzQjtBQUNwQixlQUFPLENBQUMsS0FBSyxPQUFOLEVBQWUsR0FBRyxLQUFLLFFBQXZCLENBQVA7QUFDRDtBQUVELFFBQUksU0FBSixHQUFhO0FBQ1gsWUFBSSxLQUFLLE9BQUwsQ0FBYSxhQUFiLENBQTJCLElBQTNCLENBQWdDLFFBQVEsQ0FBQyxLQUFLLGNBQUwsQ0FBb0IsR0FBcEIsQ0FBd0IsSUFBeEIsQ0FBekMsQ0FBSixFQUE2RTtBQUMzRSxtQkFBTyxJQUFJLE9BQUosQ0FDTCxLQUFLLE9BQUwsQ0FBYSxhQUFiLENBQTJCLE1BQTNCLENBQWtDLFFBQVEsQ0FBQyxLQUFLLGNBQUwsQ0FBb0IsR0FBcEIsQ0FBd0IsSUFBeEIsQ0FBM0MsQ0FESyxFQUVMLEtBQUssT0FBTCxDQUFhLFVBRlIsRUFHTCxLQUFLLE9BQUwsQ0FBYSxlQUhSLENBQVA7QUFLRCxTQU5EO0FBTU87QUFDTCxtQkFBTyxTQUFQO0FBQ0Q7QUFDRjtBQUVELFFBQUksa0JBQUosR0FBc0I7QUFDcEIsY0FBTSxZQUFZLEtBQUssU0FBdkI7QUFDQSxZQUFJLFNBQUosRUFBZTtBQUNiLG1CQUFPLENBQUMsU0FBRCxFQUFZLEdBQUcsS0FBSyxRQUFwQixDQUFQO0FBQ0QsU0FGRDtBQUVPO0FBQ0wsbUJBQU8sS0FBSyxRQUFaO0FBQ0Q7QUFDRjtBQUVELGdCQUFZLGFBQVosRUFBOEM7QUFFNUMsYUFBSyxPQUFMLEdBQWUsSUFBSSxPQUFKLENBQVksYUFBWixDQUFmO0FBRUEsYUFBSyxjQUFMLEdBQXNCLElBQUksR0FBSixFQUF0QjtBQUNEO0FBS0Qsd0JBQW9CLGFBQXBCLEVBQXNEO0FBQ3BELGNBQU0sV0FBc0IsRUFBNUI7QUFFQSxjQUFNLGlCQUFpQixLQUFLLE9BQUwsQ0FBYSxhQUFiLENBQTJCLEtBQTNCLENBQWlDLFFBQVEsY0FBYyxRQUFkLENBQXVCLElBQXZCLENBQXpDLENBQXZCO0FBRUEsWUFBSSxjQUFKLEVBQW9CO0FBQ2xCLHFCQUFTLElBQVQsQ0FBYyxLQUFLLE9BQW5CO0FBQ0Q7QUFPRCxjQUFNLFNBQWdDLElBQUksR0FBSixFQUF0QztBQUVBLGFBQUssTUFBTSxJQUFYLElBQW1CLGFBQW5CLEVBQWtDO0FBQ2hDLGdCQUFJLFdBQVcsS0FBSyxjQUFMLENBQW9CLEdBQXBCLENBQXdCLElBQXhCLENBQWY7QUFFQSxnQkFBSSxDQUFDLFFBQUwsRUFBZTtBQUNiLG9CQUFJLGNBQUo7QUFBb0I7QUFDcEIsMkJBQVcsS0FBSyxPQUFoQjtBQUNEO0FBRUQsZ0JBQUksUUFBUSxPQUFPLEdBQVAsQ0FBVyxRQUFYLENBQVo7QUFDQSxnQkFBSSxDQUFDLEtBQUwsRUFBWTtBQUNWLHdCQUFRLElBQUksT0FBSixDQUFZLEVBQVosRUFBZ0IsQ0FBQyxHQUFHLFNBQVMsVUFBYixDQUFoQixFQUEwQyxDQUFDLEdBQUcsU0FBUyxlQUFiLENBQTFDLENBQVI7QUFDQSx1QkFBTyxHQUFQLENBQVcsUUFBWCxFQUFxQixLQUFyQjtBQUNBLHlCQUFTLElBQVQsQ0FBYyxLQUFkO0FBQ0Q7QUFFRCxnQkFBSSxhQUFhLEtBQUssT0FBdEIsRUFBK0I7QUFDN0IseUJBQVMsYUFBVCxDQUF1QixNQUF2QixDQUE4QixTQUFTLGFBQVQsQ0FBdUIsT0FBdkIsQ0FBK0IsSUFBL0IsQ0FBOUIsRUFBb0UsQ0FBcEU7QUFDRDtBQUVELGlCQUFLLGNBQUwsQ0FBb0IsR0FBcEIsQ0FBd0IsSUFBeEIsRUFBOEIsS0FBOUI7QUFDQSxrQkFBTSxhQUFOLENBQW9CLElBQXBCLENBQXlCLElBQXpCO0FBQ0Q7QUFFRCxlQUFPLFFBQVA7QUFDRDtBQUVELFVBQU0sYUFBTixFQUErQixTQUEvQixFQUFzRjtBQUNwRixhQUFLLE1BQU0sWUFBWCxJQUEyQixjQUFjLGtCQUF6QyxFQUE2RDtBQUMzRCxnQkFBSSxhQUFhLFVBQWIsQ0FBd0IsTUFBeEIsR0FBaUMsQ0FBckM7QUFBd0M7QUFDeEMsaUJBQUssTUFBTSxPQUFYLElBQXNCLEtBQUssbUJBQUwsQ0FBeUIsYUFBYSxhQUF0QyxDQUF0QixFQUE0RTtBQUMxRSxvQkFBSSxhQUFhLGVBQWIsQ0FBNkIsTUFBN0IsR0FBc0MsQ0FBMUMsRUFBNkM7QUFFM0MsNEJBQVEsZUFBUixHQUEwQixDQUFDLEdBQUcsUUFBUSxlQUFaLEVBQTZCLEdBQUcsYUFBYSxlQUE3QyxFQUE4RCxNQUE5RCxDQUN4QixDQUFDLENBQUQsRUFBSSxLQUFKLEVBQVcsS0FBWCxLQUFxQixNQUFNLFNBQU4sQ0FBZ0IsS0FBSyxFQUFFLFlBQUYsSUFBa0IsRUFBRSxZQUF6QyxLQUEwRCxLQUR2RCxDQUExQjtBQUdEO0FBQ0Qsd0JBQVEsVUFBUixDQUFtQixJQUFuQixDQUF3QixJQUFJLFlBQVksVUFBVSxZQUFWLENBQVosR0FBc0MsYUFBYSxVQUF2RCxDQUF4QjtBQUNEO0FBQ0Y7QUFDRjtBQUVELGNBQU87QUFDTCxlQUNFLFlBQUE7QUFDQSx3QkFBZ0IsT0FBQSxPQUFBLENBQVEsS0FBSyxPQUFiLENBQXFCLElBRHJDO0FBRUEsYUFBSyxRQUFMLENBQWMsR0FBZCxDQUFrQixXQUFXLEtBQUssT0FBQSxPQUFBLENBQVEsT0FBUixDQUFnQixJQUFsRCxFQUF3RCxJQUF4RCxDQUE2RCxFQUE3RCxDQUhGO0FBS0QsS0EzR0g7O0FBQUEsUUFBQSxRQUFBLEdBQUEsUUFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluc3BlY3QgfSBmcm9tICd1dGlsJztcblxuaW1wb3J0IHsgR3JhcGhRTE9iamVjdFR5cGUgfSBmcm9tICdncmFwaHFsJztcblxuaW1wb3J0IHsgU2VsZWN0aW9uU2V0LCBTZWxlY3Rpb24sIEZpZWxkLCBGcmFnbWVudFNwcmVhZCB9IGZyb20gJy4uLyc7XG5pbXBvcnQgeyBjb2xsZWN0QW5kTWVyZ2VGaWVsZHMgfSBmcm9tICcuL2NvbGxlY3RBbmRNZXJnZUZpZWxkcyc7XG5cbmV4cG9ydCBjbGFzcyBWYXJpYW50IGltcGxlbWVudHMgU2VsZWN0aW9uU2V0IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHBvc3NpYmxlVHlwZXM6IEdyYXBoUUxPYmplY3RUeXBlW10sXG4gICAgcHVibGljIHNlbGVjdGlvbnM6IFNlbGVjdGlvbltdID0gW10sXG4gICAgcHVibGljIGZyYWdtZW50U3ByZWFkczogRnJhZ21lbnRTcHJlYWRbXSA9IFtdXG4gICkge31cblxuICBnZXQgZmllbGRzKCk6IEZpZWxkW10ge1xuICAgIHJldHVybiBjb2xsZWN0QW5kTWVyZ2VGaWVsZHModGhpcyk7XG4gIH1cblxuICBpbnNwZWN0KCkge1xuICAgIHJldHVybiBgJHtpbnNwZWN0KHRoaXMucG9zc2libGVUeXBlcyl9IC0+ICR7aW5zcGVjdChcbiAgICAgIGNvbGxlY3RBbmRNZXJnZUZpZWxkcyh0aGlzLCBmYWxzZSkubWFwKGZpZWxkID0+IGZpZWxkLnJlc3BvbnNlS2V5KVxuICAgICl9ICR7aW5zcGVjdCh0aGlzLmZyYWdtZW50U3ByZWFkcy5tYXAoZnJhZ21lbnRTcHJlYWQgPT4gZnJhZ21lbnRTcHJlYWQuZnJhZ21lbnROYW1lKSl9XFxuYDtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdHlwZUNhc2VGb3JTZWxlY3Rpb25TZXQoXG4gIHNlbGVjdGlvblNldDogU2VsZWN0aW9uU2V0LFxuICBtZXJnZUluRnJhZ21lbnRTcHJlYWRzOiBib29sZWFuID0gdHJ1ZVxuKTogVHlwZUNhc2Uge1xuICBjb25zdCB0eXBlQ2FzZSA9IG5ldyBUeXBlQ2FzZShzZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcyk7XG5cbiAgZm9yIChjb25zdCBzZWxlY3Rpb24gb2Ygc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMpIHtcbiAgICBzd2l0Y2ggKHNlbGVjdGlvbi5raW5kKSB7XG4gICAgICBjYXNlICdGaWVsZCc6XG4gICAgICAgIGZvciAoY29uc3QgdmFyaWFudCBvZiB0eXBlQ2FzZS5kaXNqb2ludFZhcmlhbnRzRm9yKHNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzKSkge1xuICAgICAgICAgIHZhcmlhbnQuc2VsZWN0aW9ucy5wdXNoKHNlbGVjdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdGcmFnbWVudFNwcmVhZCc6XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0eXBlQ2FzZS5kZWZhdWx0LmZyYWdtZW50U3ByZWFkcy5zb21lKFxuICAgICAgICAgICAgZnJhZ21lbnRTcHJlYWQgPT4gZnJhZ21lbnRTcHJlYWQuZnJhZ21lbnROYW1lID09PSBzZWxlY3Rpb24uZnJhZ21lbnROYW1lXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgZm9yIChjb25zdCB2YXJpYW50IG9mIHR5cGVDYXNlLmRpc2pvaW50VmFyaWFudHNGb3Ioc2VsZWN0aW9uU2V0LnBvc3NpYmxlVHlwZXMpKSB7XG4gICAgICAgICAgdmFyaWFudC5mcmFnbWVudFNwcmVhZHMucHVzaChzZWxlY3Rpb24pO1xuXG4gICAgICAgICAgaWYgKCFtZXJnZUluRnJhZ21lbnRTcHJlYWRzKSB7XG4gICAgICAgICAgICB2YXJpYW50LnNlbGVjdGlvbnMucHVzaChzZWxlY3Rpb24pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAobWVyZ2VJbkZyYWdtZW50U3ByZWFkcykge1xuICAgICAgICAgIHR5cGVDYXNlLm1lcmdlKFxuICAgICAgICAgICAgdHlwZUNhc2VGb3JTZWxlY3Rpb25TZXQoXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBwb3NzaWJsZVR5cGVzOiBzZWxlY3Rpb25TZXQucG9zc2libGVUeXBlcy5maWx0ZXIodHlwZSA9PlxuICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uLnNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzLmluY2x1ZGVzKHR5cGUpXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25zOiBzZWxlY3Rpb24uc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnNcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgbWVyZ2VJbkZyYWdtZW50U3ByZWFkc1xuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdUeXBlQ29uZGl0aW9uJzpcbiAgICAgICAgdHlwZUNhc2UubWVyZ2UoXG4gICAgICAgICAgdHlwZUNhc2VGb3JTZWxlY3Rpb25TZXQoXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHBvc3NpYmxlVHlwZXM6IHNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzLmZpbHRlcih0eXBlID0+XG4gICAgICAgICAgICAgICAgc2VsZWN0aW9uLnNlbGVjdGlvblNldC5wb3NzaWJsZVR5cGVzLmluY2x1ZGVzKHR5cGUpXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIHNlbGVjdGlvbnM6IHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQuc2VsZWN0aW9uc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1lcmdlSW5GcmFnbWVudFNwcmVhZHNcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQm9vbGVhbkNvbmRpdGlvbic6XG4gICAgICAgIHR5cGVDYXNlLm1lcmdlKFxuICAgICAgICAgIHR5cGVDYXNlRm9yU2VsZWN0aW9uU2V0KHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQsIG1lcmdlSW5GcmFnbWVudFNwcmVhZHMpLFxuICAgICAgICAgIHNlbGVjdGlvblNldCA9PiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIC4uLnNlbGVjdGlvbixcbiAgICAgICAgICAgICAgc2VsZWN0aW9uU2V0XG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHlwZUNhc2U7XG59XG5cbmV4cG9ydCBjbGFzcyBUeXBlQ2FzZSB7XG4gIGRlZmF1bHQ6IFZhcmlhbnQ7XG4gIHByaXZhdGUgdmFyaWFudHNCeVR5cGU6IE1hcDxHcmFwaFFMT2JqZWN0VHlwZSwgVmFyaWFudD47XG5cbiAgZ2V0IHZhcmlhbnRzKCk6IFZhcmlhbnRbXSB7XG4gICAgLy8gVW5pcXVlIHRoZSB2YXJpYW50cyBiZWZvcmUgcmV0dXJuaW5nIHRoZW0uXG4gICAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldCh0aGlzLnZhcmlhbnRzQnlUeXBlLnZhbHVlcygpKSk7XG4gIH1cblxuICBnZXQgZGVmYXVsdEFuZFZhcmlhbnRzKCk6IFZhcmlhbnRbXSB7XG4gICAgcmV0dXJuIFt0aGlzLmRlZmF1bHQsIC4uLnRoaXMudmFyaWFudHNdO1xuICB9XG5cbiAgZ2V0IHJlbWFpbmRlcigpOiBWYXJpYW50IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodGhpcy5kZWZhdWx0LnBvc3NpYmxlVHlwZXMuc29tZSh0eXBlID0+ICF0aGlzLnZhcmlhbnRzQnlUeXBlLmhhcyh0eXBlKSkpIHtcbiAgICAgIHJldHVybiBuZXcgVmFyaWFudChcbiAgICAgICAgdGhpcy5kZWZhdWx0LnBvc3NpYmxlVHlwZXMuZmlsdGVyKHR5cGUgPT4gIXRoaXMudmFyaWFudHNCeVR5cGUuaGFzKHR5cGUpKSxcbiAgICAgICAgdGhpcy5kZWZhdWx0LnNlbGVjdGlvbnMsXG4gICAgICAgIHRoaXMuZGVmYXVsdC5mcmFnbWVudFNwcmVhZHNcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGV4aGF1c3RpdmVWYXJpYW50cygpOiBWYXJpYW50W10ge1xuICAgIGNvbnN0IHJlbWFpbmRlciA9IHRoaXMucmVtYWluZGVyO1xuICAgIGlmIChyZW1haW5kZXIpIHtcbiAgICAgIHJldHVybiBbcmVtYWluZGVyLCAuLi50aGlzLnZhcmlhbnRzXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMudmFyaWFudHM7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IocG9zc2libGVUeXBlczogR3JhcGhRTE9iamVjdFR5cGVbXSkge1xuICAgIC8vIFdlIHN0YXJ0IG91dCB3aXRoIGEgc2luZ2xlIGRlZmF1bHQgdmFyaWFudCB0aGF0IHJlcHJlc2VudHMgYWxsIHBvc3NpYmxlIHR5cGVzIG9mIHRoZSBzZWxlY3Rpb24gc2V0LlxuICAgIHRoaXMuZGVmYXVsdCA9IG5ldyBWYXJpYW50KHBvc3NpYmxlVHlwZXMpO1xuXG4gICAgdGhpcy52YXJpYW50c0J5VHlwZSA9IG5ldyBNYXAoKTtcbiAgfVxuXG4gIC8vIFJldHVybnMgcmVjb3JkcyByZXByZXNlbnRpbmcgYSBzZXQgb2YgcG9zc2libGUgdHlwZXMsIG1ha2luZyBzdXJlIHRoZXkgYXJlIGRpc2pvaW50IHdpdGggb3RoZXIgcG9zc2libGUgdHlwZXMuXG4gIC8vIFRoYXQgbWF5IGludm9sdmUgcmVmaW5pbmcgdGhlIGV4aXN0aW5nIHBhcnRpdGlvbiAoaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUGFydGl0aW9uX3JlZmluZW1lbnQpXG4gIC8vIHdpdGggdGhlIHBhc3NlZCBpbiBzZXQgb2YgcG9zc2libGUgdHlwZXMuXG4gIGRpc2pvaW50VmFyaWFudHNGb3IocG9zc2libGVUeXBlczogR3JhcGhRTE9iamVjdFR5cGVbXSk6IFZhcmlhbnRbXSB7XG4gICAgY29uc3QgdmFyaWFudHM6IFZhcmlhbnRbXSA9IFtdO1xuXG4gICAgY29uc3QgbWF0Y2hlc0RlZmF1bHQgPSB0aGlzLmRlZmF1bHQucG9zc2libGVUeXBlcy5ldmVyeSh0eXBlID0+IHBvc3NpYmxlVHlwZXMuaW5jbHVkZXModHlwZSkpO1xuXG4gICAgaWYgKG1hdGNoZXNEZWZhdWx0KSB7XG4gICAgICB2YXJpYW50cy5wdXNoKHRoaXMuZGVmYXVsdCk7XG4gICAgfVxuXG4gICAgLy8gV2Uga2VlcCBhIG1hcCBmcm9tIG9yaWdpbmFsIHJlY29yZHMgdG8gc3BsaXQgcmVjb3Jkcy4gV2UnbGwgdGhlbiByZW1vdmUgcG9zc2libGUgdHlwZXMgZnJvbSB0aGVcbiAgICAvLyBvcmlnaW5hbCByZWNvcmQgYW5kIG1vdmUgdGhlbSB0byB0aGUgc3BsaXQgcmVjb3JkLlxuICAgIC8vIFRoaXMgbWVhbnMgdGhlIG9yaWdpbmFsIHJlY29yZCB3aWxsIGJlIG1vZGlmaWVkIHRvIHJlcHJlc2VudCB0aGUgc2V0IHRoZW9yZXRpY2FsIGRpZmZlcmVuY2UgYmV0d2VlblxuICAgIC8vIHRoZSBvcmlnaW5hbCBzZXQgb2YgcG9zc2libGUgdHlwZXMgYW5kIHRoZSByZWZpbmVtZW50IHNldCwgYW5kIHRoZSBzcGxpdCByZWNvcmQgd2lsbCByZXByZXNlbnQgdGhlXG4gICAgLy8gaW50ZXJzZWN0aW9uLlxuICAgIGNvbnN0IHNwbGl0czogTWFwPFZhcmlhbnQsIFZhcmlhbnQ+ID0gbmV3IE1hcCgpO1xuXG4gICAgZm9yIChjb25zdCB0eXBlIG9mIHBvc3NpYmxlVHlwZXMpIHtcbiAgICAgIGxldCBvcmlnaW5hbCA9IHRoaXMudmFyaWFudHNCeVR5cGUuZ2V0KHR5cGUpO1xuXG4gICAgICBpZiAoIW9yaWdpbmFsKSB7XG4gICAgICAgIGlmIChtYXRjaGVzRGVmYXVsdCkgY29udGludWU7XG4gICAgICAgIG9yaWdpbmFsID0gdGhpcy5kZWZhdWx0O1xuICAgICAgfVxuXG4gICAgICBsZXQgc3BsaXQgPSBzcGxpdHMuZ2V0KG9yaWdpbmFsKTtcbiAgICAgIGlmICghc3BsaXQpIHtcbiAgICAgICAgc3BsaXQgPSBuZXcgVmFyaWFudChbXSwgWy4uLm9yaWdpbmFsLnNlbGVjdGlvbnNdLCBbLi4ub3JpZ2luYWwuZnJhZ21lbnRTcHJlYWRzXSk7XG4gICAgICAgIHNwbGl0cy5zZXQob3JpZ2luYWwsIHNwbGl0KTtcbiAgICAgICAgdmFyaWFudHMucHVzaChzcGxpdCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChvcmlnaW5hbCAhPT0gdGhpcy5kZWZhdWx0KSB7XG4gICAgICAgIG9yaWdpbmFsLnBvc3NpYmxlVHlwZXMuc3BsaWNlKG9yaWdpbmFsLnBvc3NpYmxlVHlwZXMuaW5kZXhPZih0eXBlKSwgMSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMudmFyaWFudHNCeVR5cGUuc2V0KHR5cGUsIHNwbGl0KTtcbiAgICAgIHNwbGl0LnBvc3NpYmxlVHlwZXMucHVzaCh0eXBlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFyaWFudHM7XG4gIH1cblxuICBtZXJnZShvdGhlclR5cGVDYXNlOiBUeXBlQ2FzZSwgdHJhbnNmb3JtPzogKHNlbGVjdGlvblNldDogU2VsZWN0aW9uU2V0KSA9PiBTZWxlY3Rpb25bXSkge1xuICAgIGZvciAoY29uc3Qgb3RoZXJWYXJpYW50IG9mIG90aGVyVHlwZUNhc2UuZGVmYXVsdEFuZFZhcmlhbnRzKSB7XG4gICAgICBpZiAob3RoZXJWYXJpYW50LnNlbGVjdGlvbnMubGVuZ3RoIDwgMSkgY29udGludWU7XG4gICAgICBmb3IgKGNvbnN0IHZhcmlhbnQgb2YgdGhpcy5kaXNqb2ludFZhcmlhbnRzRm9yKG90aGVyVmFyaWFudC5wb3NzaWJsZVR5cGVzKSkge1xuICAgICAgICBpZiAob3RoZXJWYXJpYW50LmZyYWdtZW50U3ByZWFkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgLy8gVW5pb24gb2YgdmFyaWFudC5mcmFnbWVudFNwcmVhZHMgYW5kIG90aGVyVmFyaWFudC5mcmFnbWVudFNwcmVhZHNcbiAgICAgICAgICB2YXJpYW50LmZyYWdtZW50U3ByZWFkcyA9IFsuLi52YXJpYW50LmZyYWdtZW50U3ByZWFkcywgLi4ub3RoZXJWYXJpYW50LmZyYWdtZW50U3ByZWFkc10uZmlsdGVyKFxuICAgICAgICAgICAgKGEsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuZmluZEluZGV4KGIgPT4gYi5mcmFnbWVudE5hbWUgPT0gYS5mcmFnbWVudE5hbWUpID09IGluZGV4XG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB2YXJpYW50LnNlbGVjdGlvbnMucHVzaCguLi4odHJhbnNmb3JtID8gdHJhbnNmb3JtKG90aGVyVmFyaWFudCkgOiBvdGhlclZhcmlhbnQuc2VsZWN0aW9ucykpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGluc3BlY3QoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIGBUeXBlQ2FzZVxcbmAgK1xuICAgICAgYCAgZGVmYXVsdCAtPiAke2luc3BlY3QodGhpcy5kZWZhdWx0KX1cXG5gICtcbiAgICAgIHRoaXMudmFyaWFudHMubWFwKHZhcmlhbnQgPT4gYCAgJHtpbnNwZWN0KHZhcmlhbnQpfVxcbmApLmpvaW4oJycpXG4gICAgKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==