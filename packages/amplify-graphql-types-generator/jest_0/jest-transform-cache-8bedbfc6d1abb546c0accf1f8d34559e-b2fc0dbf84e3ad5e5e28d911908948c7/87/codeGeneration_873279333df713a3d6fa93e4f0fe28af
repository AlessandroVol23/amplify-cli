ae70c8052839403e72329046d45eed64
'use strict';require('ts-jest').install("/c/Users/Sandro/repo/amplify-cli/packages/amplify-graphql-types-generator/src/scala/codeGeneration.js", "\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst graphql_1 = require(\"graphql\");\nconst graphql_2 = require(\"../utilities/graphql\");\nconst printing_1 = require(\"../utilities/printing\");\nconst language_1 = require(\"./language\");\nconst naming_1 = require(\"./naming\");\nconst values_1 = require(\"./values\");\nconst types_1 = require(\"./types\");\nconst CodeGenerator_1 = require(\"../utilities/CodeGenerator\");\nfunction generateSource(context, options) {\n    const generator = new CodeGenerator_1.default(context);\n    generator.printOnNewline('//  This file was automatically generated and should not be edited.');\n    generator.printNewline();\n    if (context.namespace) {\n        language_1.packageDeclaration(generator, context.namespace);\n    }\n    context.typesUsed.forEach(type => {\n        typeDeclarationForGraphQLType(generator, type);\n    });\n    Object.values(context.operations).forEach(operation => {\n        classDeclarationForOperation(generator, operation);\n    });\n    Object.values(context.fragments).forEach(fragment => {\n        caseClassDeclarationForFragment(generator, fragment);\n    });\n    return generator.output;\n}\nexports.generateSource = generateSource;\nfunction classDeclarationForOperation(generator, { operationName, operationType, rootType, variables, fields, inlineFragments, fragmentSpreads, fragmentsReferenced, source, sourceWithFragments, operationId }) {\n    let objectName;\n    let protocol;\n    switch (operationType) {\n        case 'query':\n            objectName = `${naming_1.operationClassName(operationName)}Query`;\n            protocol = 'com.apollographql.scalajs.GraphQLQuery';\n            break;\n        case 'mutation':\n            objectName = `${naming_1.operationClassName(operationName)}Mutation`;\n            protocol = 'com.apollographql.scalajs.GraphQLMutation';\n            break;\n        default:\n            throw new graphql_1.GraphQLError(`Unsupported operation type \"${operationType}\"`);\n    }\n    language_1.objectDeclaration(generator, {\n        objectName,\n        modifiers: [],\n        superclass: protocol\n    }, () => {\n        if (source) {\n            generator.printOnNewline('val operationString =');\n            generator.withIndent(() => {\n                values_1.multilineString(generator, source);\n            });\n        }\n        operationIdentifier(generator, { operationName, sourceWithFragments, operationId });\n        if (fragmentsReferenced && fragmentsReferenced.length > 0) {\n            generator.printNewlineIfNeeded();\n            generator.printOnNewline('val requestString: String = { operationString');\n            fragmentsReferenced.forEach(fragment => {\n                generator.print(` + ${naming_1.caseClassNameForFragmentName(fragment)}.fragmentString`);\n            });\n            generator.print(' }');\n            generator.printOnNewline('val operation = com.apollographql.scalajs.gql(requestString)');\n        }\n        else {\n            generator.printOnNewline('val operation = com.apollographql.scalajs.gql(operationString)');\n        }\n        generator.printNewlineIfNeeded();\n        if (variables && variables.length > 0) {\n            const properties = variables.map(({ name, type }) => {\n                const propertyName = language_1.escapeIdentifierIfNeeded(name);\n                const typeName = types_1.typeNameFromGraphQLType(generator.context, type);\n                const isOptional = !(type instanceof graphql_1.GraphQLNonNull || type.ofType instanceof graphql_1.GraphQLNonNull);\n                return { name, propertyName, type, typeName, isOptional };\n            });\n            language_1.caseClassDeclaration(generator, { caseClassName: 'Variables', description: '', params: properties.map(p => {\n                    return {\n                        name: p.propertyName,\n                        type: p.typeName\n                    };\n                }) }, () => { });\n        }\n        else {\n            generator.printOnNewline('type Variables = Unit');\n        }\n        caseClassDeclarationForSelectionSet(generator, {\n            caseClassName: \"Data\",\n            parentType: rootType,\n            fields,\n            inlineFragments,\n            fragmentSpreads\n        });\n    });\n}\nexports.classDeclarationForOperation = classDeclarationForOperation;\nfunction caseClassDeclarationForFragment(generator, { fragmentName, typeCondition, fields, inlineFragments, fragmentSpreads, source }) {\n    const caseClassName = naming_1.caseClassNameForFragmentName(fragmentName);\n    caseClassDeclarationForSelectionSet(generator, {\n        caseClassName,\n        parentType: typeCondition,\n        fields,\n        inlineFragments,\n        fragmentSpreads\n    }, () => { }, () => {\n        if (source) {\n            generator.printOnNewline('val fragmentString =');\n            generator.withIndent(() => {\n                values_1.multilineString(generator, source);\n            });\n        }\n    });\n}\nexports.caseClassDeclarationForFragment = caseClassDeclarationForFragment;\nfunction caseClassDeclarationForSelectionSet(generator, { caseClassName, parentType, fields, inlineFragments, fragmentSpreads, viewableAs }, beforeClosure, objectClosure) {\n    const possibleTypes = parentType ? types_1.possibleTypesForType(generator.context, parentType) : null;\n    let properties;\n    if (!possibleTypes || possibleTypes.length == 1) {\n        properties = fields\n            .map(field => naming_1.propertyFromField(generator.context, field))\n            .filter(field => field.propertyName != \"__typename\");\n        language_1.caseClassDeclaration(generator, { caseClassName, params: properties.map(p => {\n                return {\n                    name: p.responseName,\n                    type: p.typeName,\n                };\n            }) }, () => { });\n    }\n    else {\n        generator.printNewlineIfNeeded();\n        const properties = fields\n            .map(field => naming_1.propertyFromField(generator.context, field))\n            .filter(field => field.propertyName != \"__typename\");\n        language_1.caseClassDeclaration(generator, { caseClassName, params: properties.map(p => {\n                return {\n                    name: p.responseName,\n                    type: p.typeName,\n                };\n            }), superclass: 'me.shadaj.slinky.core.WithRaw' }, () => {\n            if (inlineFragments && inlineFragments.length > 0) {\n                inlineFragments.forEach((inlineFragment) => {\n                    const fragClass = naming_1.caseClassNameForInlineFragment(inlineFragment);\n                    generator.printOnNewline(`def as${inlineFragment.typeCondition}`);\n                    generator.print(`: Option[${fragClass}] =`);\n                    generator.withinBlock(() => {\n                        generator.printOnNewline(`if (${fragClass}.possibleTypes.contains(this.raw.__typename.asInstanceOf[String])) Some(implicitly[me.shadaj.slinky.core.Reader[${fragClass}]].read(this.raw)) else None`);\n                    });\n                });\n            }\n            if (fragmentSpreads) {\n                fragmentSpreads.forEach(s => {\n                    const fragment = generator.context.fragments[s];\n                    const alwaysDefined = graphql_2.isTypeProperSuperTypeOf(generator.context.schema, fragment.typeCondition, parentType);\n                    if (!alwaysDefined) {\n                        generator.printOnNewline(`def as${s}`);\n                        generator.print(`: Option[${s}] =`);\n                        generator.withinBlock(() => {\n                            generator.printOnNewline(`if (${s}.possibleTypes.contains(this.raw.__typename.asInstanceOf[String])) Some(implicitly[me.shadaj.slinky.core.Reader[${s}]].read(this.raw)) else None`);\n                        });\n                    }\n                });\n            }\n        });\n        if (inlineFragments && inlineFragments.length > 0) {\n            inlineFragments.forEach((inlineFragment) => {\n                caseClassDeclarationForSelectionSet(generator, {\n                    caseClassName: naming_1.caseClassNameForInlineFragment(inlineFragment),\n                    parentType: inlineFragment.typeCondition,\n                    fields: inlineFragment.fields,\n                    inlineFragments: inlineFragment.inlineFragments,\n                    fragmentSpreads: inlineFragment.fragmentSpreads,\n                    viewableAs: {\n                        caseClassName,\n                        properties,\n                    },\n                });\n            });\n        }\n    }\n    language_1.objectDeclaration(generator, { objectName: caseClassName }, () => {\n        if (possibleTypes) {\n            generator.printNewlineIfNeeded();\n            generator.printOnNewline('val possibleTypes = scala.collection.Set(');\n            generator.print(printing_1.join(possibleTypes.map(type => `\"${String(type)}\"`), ', '));\n            generator.print(')');\n        }\n        if (viewableAs) {\n            generator.printOnNewline(`implicit def to${viewableAs.caseClassName}(a: ${caseClassName}): ${viewableAs.caseClassName} = ${viewableAs.caseClassName}(${viewableAs.properties.map(p => \"a.\" + p.responseName).join(', ')})`);\n        }\n        if (fragmentSpreads) {\n            fragmentSpreads.forEach(s => {\n                const fragment = generator.context.fragments[s];\n                const alwaysDefined = graphql_2.isTypeProperSuperTypeOf(generator.context.schema, fragment.typeCondition, parentType);\n                if (alwaysDefined) {\n                    generator.printOnNewline(`implicit def to${s}(a: ${caseClassName}): ${s} = ${s}(${(fragment.fields || []).map(p => \"a.\" + p.responseName).join(', ')})`);\n                }\n            });\n        }\n        if (objectClosure) {\n            objectClosure();\n        }\n    });\n    fields.filter(field => graphql_1.isCompositeType(graphql_1.getNamedType(field.type))).forEach(field => {\n        caseClassDeclarationForSelectionSet(generator, {\n            caseClassName: naming_1.caseClassNameForPropertyName(field.responseName),\n            parentType: graphql_1.getNamedType(field.type),\n            fields: field.fields,\n            inlineFragments: field.inlineFragments,\n            fragmentSpreads: field.fragmentSpreads\n        });\n    });\n}\nexports.caseClassDeclarationForSelectionSet = caseClassDeclarationForSelectionSet;\nfunction operationIdentifier(generator, { operationName, sourceWithFragments, operationId }) {\n    if (!generator.context.generateOperationIds) {\n        return;\n    }\n    generator.printNewlineIfNeeded();\n    generator.printOnNewline(`val operationIdentifier: String = \"${operationId}\"`);\n}\nfunction typeDeclarationForGraphQLType(generator, type) {\n    if (type instanceof graphql_1.GraphQLEnumType) {\n        enumerationDeclaration(generator, type);\n    }\n    else if (type instanceof graphql_1.GraphQLInputObjectType) {\n        caseClassDeclarationForInputObjectType(generator, type);\n    }\n}\nexports.typeDeclarationForGraphQLType = typeDeclarationForGraphQLType;\nfunction enumerationDeclaration(generator, type) {\n    const { name, description } = type;\n    const values = type.getValues();\n    generator.printNewlineIfNeeded();\n    language_1.comment(generator, description);\n    generator.printOnNewline(`object ${name}`);\n    generator.withinBlock(() => {\n        values.forEach(value => {\n            language_1.comment(generator, value.description);\n            generator.printOnNewline(`val ${language_1.escapeIdentifierIfNeeded(naming_1.enumCaseName(value.name))} = \"${value.value}\"`);\n        });\n    });\n    generator.printNewline();\n}\nfunction caseClassDeclarationForInputObjectType(generator, type) {\n    const { name: caseClassName, description } = type;\n    const fields = Object.values(type.getFields());\n    const properties = fields.map(field => naming_1.propertyFromField(generator.context, field));\n    language_1.caseClassDeclaration(generator, { caseClassName, description, params: properties.map(p => {\n            return {\n                name: p.propertyName,\n                type: p.typeName\n            };\n        }) }, () => { });\n}\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZUdlbmVyYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb2RlR2VuZXJhdGlvbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQVlnQjtBQUVoQixrREFBK0Q7QUFFL0Qsb0RBRytCO0FBRS9CLHlDQVFvQjtBQUVwQixxQ0FVa0I7QUFFbEIscUNBSWtCO0FBRWxCLG1DQUdpQjtBQUVqQiw4REFBdUQ7QUFFdkQsd0JBQStCLE9BQU8sRUFBRSxPQUFPO0lBQzdDLE1BQU0sU0FBUyxHQUFHLElBQUksdUJBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUU3QyxTQUFTLENBQUMsY0FBYyxDQUFDLHFFQUFxRSxDQUFDLENBQUM7SUFDaEcsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBRXpCLElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRTtRQUNyQiw2QkFBa0IsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ2xEO0lBRUQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDL0IsNkJBQTZCLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQ3BELDRCQUE0QixDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUNyRCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUNsRCwrQkFBK0IsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDdkQsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLFNBQVMsQ0FBQyxNQUFNLENBQUM7QUFDMUIsQ0FBQztBQXZCRCx3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Q0FBQyxZQUFZO2dCQUNwQixJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQVE7YUFDakIsQ0FBQztRQUNKLENBQUMsQ0FBQyxFQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEdyYXBoUUxFcnJvcixcbiAgZ2V0TmFtZWRUeXBlLFxuICBpc0NvbXBvc2l0ZVR5cGUsXG4gIGlzQWJzdHJhY3RUeXBlLFxuICBpc0VxdWFsVHlwZSxcbiAgR3JhcGhRTFNjYWxhclR5cGUsXG4gIEdyYXBoUUxFbnVtVHlwZSxcbiAgR3JhcGhRTExpc3QsXG4gIEdyYXBoUUxOb25OdWxsLFxuICBHcmFwaFFMSUQsXG4gIEdyYXBoUUxJbnB1dE9iamVjdFR5cGVcbn0gZnJvbSAnZ3JhcGhxbCdcblxuaW1wb3J0ICB7IGlzVHlwZVByb3BlclN1cGVyVHlwZU9mIH0gZnJvbSAnLi4vdXRpbGl0aWVzL2dyYXBocWwnXG5cbmltcG9ydCB7XG4gIGpvaW4sXG4gIHdyYXAsXG59IGZyb20gJy4uL3V0aWxpdGllcy9wcmludGluZyc7XG5cbmltcG9ydCB7XG4gIHBhY2thZ2VEZWNsYXJhdGlvbixcbiAgb2JqZWN0RGVjbGFyYXRpb24sXG4gIGNhc2VDbGFzc0RlY2xhcmF0aW9uLFxuICBwcm9wZXJ0eURlY2xhcmF0aW9uLFxuICBwcm9wZXJ0eURlY2xhcmF0aW9ucyxcbiAgZXNjYXBlSWRlbnRpZmllcklmTmVlZGVkLFxuICBjb21tZW50XG59IGZyb20gJy4vbGFuZ3VhZ2UnO1xuXG5pbXBvcnQge1xuICBjYXNlQ2xhc3NOYW1lRm9yUHJvcGVydHlOYW1lLFxuICBjYXNlQ2xhc3NOYW1lRm9yRnJhZ21lbnROYW1lLFxuICBjYXNlQ2xhc3NOYW1lRm9ySW5saW5lRnJhZ21lbnQsXG4gIG9wZXJhdGlvbkNsYXNzTmFtZSxcbiAgZW51bUNhc2VOYW1lLFxuICBwcm9wZXJ0aWVzRnJvbVNlbGVjdGlvblNldCxcbiAgcHJvcGVydHlGcm9tRmllbGQsXG4gIHByb3BlcnR5RnJvbUlubGluZUZyYWdtZW50LFxuICBwcm9wZXJ0eUZyb21GcmFnbWVudFNwcmVhZFxufSBmcm9tICcuL25hbWluZyc7XG5cbmltcG9ydCB7XG4gIGVzY2FwZWRTdHJpbmcsXG4gIG11bHRpbGluZVN0cmluZyxcbiAgZGljdGlvbmFyeUxpdGVyYWxGb3JGaWVsZEFyZ3VtZW50cyxcbn0gZnJvbSAnLi92YWx1ZXMnO1xuXG5pbXBvcnQge1xuICBwb3NzaWJsZVR5cGVzRm9yVHlwZSxcbiAgdHlwZU5hbWVGcm9tR3JhcGhRTFR5cGUsXG59IGZyb20gJy4vdHlwZXMnO1xuXG5pbXBvcnQgQ29kZUdlbmVyYXRvciBmcm9tICcuLi91dGlsaXRpZXMvQ29kZUdlbmVyYXRvcic7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVNvdXJjZShjb250ZXh0LCBvcHRpb25zKSB7XG4gIGNvbnN0IGdlbmVyYXRvciA9IG5ldyBDb2RlR2VuZXJhdG9yKGNvbnRleHQpO1xuXG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgnLy8gIFRoaXMgZmlsZSB3YXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIHNob3VsZCBub3QgYmUgZWRpdGVkLicpO1xuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG5cbiAgaWYgKGNvbnRleHQubmFtZXNwYWNlKSB7XG4gICAgcGFja2FnZURlY2xhcmF0aW9uKGdlbmVyYXRvciwgY29udGV4dC5uYW1lc3BhY2UpO1xuICB9XG5cbiAgY29udGV4dC50eXBlc1VzZWQuZm9yRWFjaCh0eXBlID0+IHtcbiAgICB0eXBlRGVjbGFyYXRpb25Gb3JHcmFwaFFMVHlwZShnZW5lcmF0b3IsIHR5cGUpO1xuICB9KTtcblxuICBPYmplY3QudmFsdWVzKGNvbnRleHQub3BlcmF0aW9ucykuZm9yRWFjaChvcGVyYXRpb24gPT4ge1xuICAgIGNsYXNzRGVjbGFyYXRpb25Gb3JPcGVyYXRpb24oZ2VuZXJhdG9yLCBvcGVyYXRpb24pO1xuICB9KTtcblxuICBPYmplY3QudmFsdWVzKGNvbnRleHQuZnJhZ21lbnRzKS5mb3JFYWNoKGZyYWdtZW50ID0+IHtcbiAgICBjYXNlQ2xhc3NEZWNsYXJhdGlvbkZvckZyYWdtZW50KGdlbmVyYXRvciwgZnJhZ21lbnQpO1xuICB9KTtcblxuICByZXR1cm4gZ2VuZXJhdG9yLm91dHB1dDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsYXNzRGVjbGFyYXRpb25Gb3JPcGVyYXRpb24oXG4gIGdlbmVyYXRvcixcbiAge1xuICAgIG9wZXJhdGlvbk5hbWUsXG4gICAgb3BlcmF0aW9uVHlwZSxcbiAgICByb290VHlwZSxcbiAgICB2YXJpYWJsZXMsXG4gICAgZmllbGRzLFxuICAgIGlubGluZUZyYWdtZW50cyxcbiAgICBmcmFnbWVudFNwcmVhZHMsXG4gICAgZnJhZ21lbnRzUmVmZXJlbmNlZCxcbiAgICBzb3VyY2UsXG4gICAgc291cmNlV2l0aEZyYWdtZW50cyxcbiAgICBvcGVyYXRpb25JZFxuICB9XG4pIHtcbiAgbGV0IG9iamVjdE5hbWU7XG4gIGxldCBwcm90b2NvbDtcblxuICBzd2l0Y2ggKG9wZXJhdGlvblR5cGUpIHtcbiAgICBjYXNlICdxdWVyeSc6XG4gICAgICBvYmplY3ROYW1lID0gYCR7b3BlcmF0aW9uQ2xhc3NOYW1lKG9wZXJhdGlvbk5hbWUpfVF1ZXJ5YDtcbiAgICAgIHByb3RvY29sID0gJ2NvbS5hcG9sbG9ncmFwaHFsLnNjYWxhanMuR3JhcGhRTFF1ZXJ5JztcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ211dGF0aW9uJzpcbiAgICAgIG9iamVjdE5hbWUgPSBgJHtvcGVyYXRpb25DbGFzc05hbWUob3BlcmF0aW9uTmFtZSl9TXV0YXRpb25gO1xuICAgICAgcHJvdG9jb2wgPSAnY29tLmFwb2xsb2dyYXBocWwuc2NhbGFqcy5HcmFwaFFMTXV0YXRpb24nO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBHcmFwaFFMRXJyb3IoYFVuc3VwcG9ydGVkIG9wZXJhdGlvbiB0eXBlIFwiJHtvcGVyYXRpb25UeXBlfVwiYCk7XG4gIH1cblxuICBvYmplY3REZWNsYXJhdGlvbihnZW5lcmF0b3IsIHtcbiAgICBvYmplY3ROYW1lLFxuICAgIG1vZGlmaWVyczogW10sXG4gICAgc3VwZXJjbGFzczogcHJvdG9jb2xcbiAgfSwgKCkgPT4ge1xuICAgIGlmIChzb3VyY2UpIHtcbiAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgndmFsIG9wZXJhdGlvblN0cmluZyA9Jyk7XG4gICAgICBnZW5lcmF0b3Iud2l0aEluZGVudCgoKSA9PiB7XG4gICAgICAgIG11bHRpbGluZVN0cmluZyhnZW5lcmF0b3IsIHNvdXJjZSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBvcGVyYXRpb25JZGVudGlmaWVyKGdlbmVyYXRvciwgeyBvcGVyYXRpb25OYW1lLCBzb3VyY2VXaXRoRnJhZ21lbnRzLCBvcGVyYXRpb25JZCB9KTtcblxuICAgIGlmIChmcmFnbWVudHNSZWZlcmVuY2VkICYmIGZyYWdtZW50c1JlZmVyZW5jZWQubGVuZ3RoID4gMCkge1xuICAgICAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ3ZhbCByZXF1ZXN0U3RyaW5nOiBTdHJpbmcgPSB7IG9wZXJhdGlvblN0cmluZycpO1xuICAgICAgZnJhZ21lbnRzUmVmZXJlbmNlZC5mb3JFYWNoKGZyYWdtZW50ID0+IHtcbiAgICAgICAgZ2VuZXJhdG9yLnByaW50KGAgKyAke2Nhc2VDbGFzc05hbWVGb3JGcmFnbWVudE5hbWUoZnJhZ21lbnQpfS5mcmFnbWVudFN0cmluZ2ApXG4gICAgICB9KTtcbiAgICAgIGdlbmVyYXRvci5wcmludCgnIH0nKTtcblxuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCd2YWwgb3BlcmF0aW9uID0gY29tLmFwb2xsb2dyYXBocWwuc2NhbGFqcy5ncWwocmVxdWVzdFN0cmluZyknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCd2YWwgb3BlcmF0aW9uID0gY29tLmFwb2xsb2dyYXBocWwuc2NhbGFqcy5ncWwob3BlcmF0aW9uU3RyaW5nKScpO1xuICAgIH1cblxuICAgIGdlbmVyYXRvci5wcmludE5ld2xpbmVJZk5lZWRlZCgpO1xuXG4gICAgaWYgKHZhcmlhYmxlcyAmJiB2YXJpYWJsZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgcHJvcGVydGllcyA9IHZhcmlhYmxlcy5tYXAoKHsgbmFtZSwgdHlwZSB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IGVzY2FwZUlkZW50aWZpZXJJZk5lZWRlZChuYW1lKTtcbiAgICAgICAgY29uc3QgdHlwZU5hbWUgPSB0eXBlTmFtZUZyb21HcmFwaFFMVHlwZShnZW5lcmF0b3IuY29udGV4dCwgdHlwZSk7XG4gICAgICAgIGNvbnN0IGlzT3B0aW9uYWwgPSAhKHR5cGUgaW5zdGFuY2VvZiBHcmFwaFFMTm9uTnVsbCB8fCB0eXBlLm9mVHlwZSBpbnN0YW5jZW9mIEdyYXBoUUxOb25OdWxsKTtcbiAgICAgICAgcmV0dXJuIHsgbmFtZSwgcHJvcGVydHlOYW1lLCB0eXBlLCB0eXBlTmFtZSwgaXNPcHRpb25hbCB9O1xuICAgICAgfSk7XG5cbiAgICAgIGNhc2VDbGFzc0RlY2xhcmF0aW9uKGdlbmVyYXRvciwgeyBjYXNlQ2xhc3NOYW1lOiAnVmFyaWFibGVzJywgZGVzY3JpcHRpb246ICcnLCBwYXJhbXM6IHByb3BlcnRpZXMubWFwKHAgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IHAucHJvcGVydHlOYW1lLFxuICAgICAgICAgIHR5cGU6IHAudHlwZU5hbWVcbiAgICAgICAgfTtcbiAgICAgIH0pfSwgKCkgPT4ge30pO1xuICAgIH0gZWxzZSB7XG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ3R5cGUgVmFyaWFibGVzID0gVW5pdCcpO1xuICAgIH1cblxuICAgIGNhc2VDbGFzc0RlY2xhcmF0aW9uRm9yU2VsZWN0aW9uU2V0KFxuICAgICAgZ2VuZXJhdG9yLFxuICAgICAge1xuICAgICAgICBjYXNlQ2xhc3NOYW1lOiBcIkRhdGFcIixcbiAgICAgICAgcGFyZW50VHlwZTogcm9vdFR5cGUsXG4gICAgICAgIGZpZWxkcyxcbiAgICAgICAgaW5saW5lRnJhZ21lbnRzLFxuICAgICAgICBmcmFnbWVudFNwcmVhZHNcbiAgICAgIH1cbiAgICApO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhc2VDbGFzc0RlY2xhcmF0aW9uRm9yRnJhZ21lbnQoXG4gIGdlbmVyYXRvcixcbiAge1xuICAgIGZyYWdtZW50TmFtZSxcbiAgICB0eXBlQ29uZGl0aW9uLFxuICAgIGZpZWxkcyxcbiAgICBpbmxpbmVGcmFnbWVudHMsXG4gICAgZnJhZ21lbnRTcHJlYWRzLFxuICAgIHNvdXJjZVxuICB9XG4pIHtcbiAgY29uc3QgY2FzZUNsYXNzTmFtZSA9IGNhc2VDbGFzc05hbWVGb3JGcmFnbWVudE5hbWUoZnJhZ21lbnROYW1lKTtcblxuICBjYXNlQ2xhc3NEZWNsYXJhdGlvbkZvclNlbGVjdGlvblNldChnZW5lcmF0b3IsIHtcbiAgICBjYXNlQ2xhc3NOYW1lLFxuICAgIHBhcmVudFR5cGU6IHR5cGVDb25kaXRpb24sXG4gICAgZmllbGRzLFxuICAgIGlubGluZUZyYWdtZW50cyxcbiAgICBmcmFnbWVudFNwcmVhZHNcbiAgfSwgKCkgPT4ge30sICgpID0+IHtcbiAgICBpZiAoc291cmNlKSB7XG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ3ZhbCBmcmFnbWVudFN0cmluZyA9Jyk7XG4gICAgICBnZW5lcmF0b3Iud2l0aEluZGVudCgoKSA9PiB7XG4gICAgICAgIG11bHRpbGluZVN0cmluZyhnZW5lcmF0b3IsIHNvdXJjZSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FzZUNsYXNzRGVjbGFyYXRpb25Gb3JTZWxlY3Rpb25TZXQoXG4gIGdlbmVyYXRvcixcbiAge1xuICAgIGNhc2VDbGFzc05hbWUsXG4gICAgcGFyZW50VHlwZSxcbiAgICBmaWVsZHMsXG4gICAgaW5saW5lRnJhZ21lbnRzLFxuICAgIGZyYWdtZW50U3ByZWFkcyxcbiAgICB2aWV3YWJsZUFzXG4gIH0sXG4gIGJlZm9yZUNsb3N1cmUsXG4gIG9iamVjdENsb3N1cmUsXG4pIHtcbiAgY29uc3QgcG9zc2libGVUeXBlcyA9IHBhcmVudFR5cGUgPyBwb3NzaWJsZVR5cGVzRm9yVHlwZShnZW5lcmF0b3IuY29udGV4dCwgcGFyZW50VHlwZSkgOiBudWxsO1xuXG4gIGxldCBwcm9wZXJ0aWVzO1xuXG4gIGlmICghcG9zc2libGVUeXBlcyB8fCBwb3NzaWJsZVR5cGVzLmxlbmd0aCA9PSAxKSB7XG4gICAgcHJvcGVydGllcyA9IGZpZWxkc1xuICAgICAgLm1hcChmaWVsZCA9PiBwcm9wZXJ0eUZyb21GaWVsZChnZW5lcmF0b3IuY29udGV4dCwgZmllbGQpKVxuICAgICAgLmZpbHRlcihmaWVsZCA9PiBmaWVsZC5wcm9wZXJ0eU5hbWUgIT0gXCJfX3R5cGVuYW1lXCIpO1xuXG4gICAgY2FzZUNsYXNzRGVjbGFyYXRpb24oZ2VuZXJhdG9yLCB7IGNhc2VDbGFzc05hbWUsIHBhcmFtczogcHJvcGVydGllcy5tYXAocCA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiBwLnJlc3BvbnNlTmFtZSxcbiAgICAgICAgdHlwZTogcC50eXBlTmFtZSxcbiAgICAgIH07XG4gICAgfSkgfSwgKCkgPT4ge30pO1xuICB9IGVsc2Uge1xuICAgIGdlbmVyYXRvci5wcmludE5ld2xpbmVJZk5lZWRlZCgpO1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBmaWVsZHNcbiAgICAgIC5tYXAoZmllbGQgPT4gcHJvcGVydHlGcm9tRmllbGQoZ2VuZXJhdG9yLmNvbnRleHQsIGZpZWxkKSlcbiAgICAgIC5maWx0ZXIoZmllbGQgPT4gZmllbGQucHJvcGVydHlOYW1lICE9IFwiX190eXBlbmFtZVwiKTtcblxuICAgIGNhc2VDbGFzc0RlY2xhcmF0aW9uKGdlbmVyYXRvciwgeyBjYXNlQ2xhc3NOYW1lLCBwYXJhbXM6IHByb3BlcnRpZXMubWFwKHAgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogcC5yZXNwb25zZU5hbWUsXG4gICAgICAgIHR5cGU6IHAudHlwZU5hbWUsXG4gICAgICB9O1xuICAgIH0pLCBzdXBlcmNsYXNzOiAnbWUuc2hhZGFqLnNsaW5reS5jb3JlLldpdGhSYXcnfSwgKCkgPT4ge1xuICAgICAgaWYgKGlubGluZUZyYWdtZW50cyAmJiBpbmxpbmVGcmFnbWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgICBpbmxpbmVGcmFnbWVudHMuZm9yRWFjaCgoaW5saW5lRnJhZ21lbnQpID0+IHtcbiAgICAgICAgICBjb25zdCBmcmFnQ2xhc3MgPSBjYXNlQ2xhc3NOYW1lRm9ySW5saW5lRnJhZ21lbnQoaW5saW5lRnJhZ21lbnQpO1xuICAgICAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgZGVmIGFzJHtpbmxpbmVGcmFnbWVudC50eXBlQ29uZGl0aW9ufWApO1xuICAgICAgICAgIGdlbmVyYXRvci5wcmludChgOiBPcHRpb25bJHtmcmFnQ2xhc3N9XSA9YCk7XG4gICAgICAgICAgZ2VuZXJhdG9yLndpdGhpbkJsb2NrKCgpID0+IHtcbiAgICAgICAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaWYgKCR7ZnJhZ0NsYXNzfS5wb3NzaWJsZVR5cGVzLmNvbnRhaW5zKHRoaXMucmF3Ll9fdHlwZW5hbWUuYXNJbnN0YW5jZU9mW1N0cmluZ10pKSBTb21lKGltcGxpY2l0bHlbbWUuc2hhZGFqLnNsaW5reS5jb3JlLlJlYWRlclske2ZyYWdDbGFzc31dXS5yZWFkKHRoaXMucmF3KSkgZWxzZSBOb25lYCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoZnJhZ21lbnRTcHJlYWRzKSB7XG4gICAgICAgIGZyYWdtZW50U3ByZWFkcy5mb3JFYWNoKHMgPT4ge1xuICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gZ2VuZXJhdG9yLmNvbnRleHQuZnJhZ21lbnRzW3NdO1xuICAgICAgICAgIGNvbnN0IGFsd2F5c0RlZmluZWQgPSBpc1R5cGVQcm9wZXJTdXBlclR5cGVPZihnZW5lcmF0b3IuY29udGV4dC5zY2hlbWEsIGZyYWdtZW50LnR5cGVDb25kaXRpb24sIHBhcmVudFR5cGUpO1xuICAgICAgICAgIGlmICghYWx3YXlzRGVmaW5lZCkge1xuICAgICAgICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBkZWYgYXMke3N9YCk7XG4gICAgICAgICAgICBnZW5lcmF0b3IucHJpbnQoYDogT3B0aW9uWyR7c31dID1gKTtcbiAgICAgICAgICAgIGdlbmVyYXRvci53aXRoaW5CbG9jaygoKSA9PiB7XG4gICAgICAgICAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaWYgKCR7c30ucG9zc2libGVUeXBlcy5jb250YWlucyh0aGlzLnJhdy5fX3R5cGVuYW1lLmFzSW5zdGFuY2VPZltTdHJpbmddKSkgU29tZShpbXBsaWNpdGx5W21lLnNoYWRhai5zbGlua3kuY29yZS5SZWFkZXJbJHtzfV1dLnJlYWQodGhpcy5yYXcpKSBlbHNlIE5vbmVgKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIGFkZCB0eXBlcyBhbmQgaW1wbGljaXQgY29udmVyc2lvbnNcbiAgICBpZiAoaW5saW5lRnJhZ21lbnRzICYmIGlubGluZUZyYWdtZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICBpbmxpbmVGcmFnbWVudHMuZm9yRWFjaCgoaW5saW5lRnJhZ21lbnQpID0+IHtcbiAgICAgICAgY2FzZUNsYXNzRGVjbGFyYXRpb25Gb3JTZWxlY3Rpb25TZXQoXG4gICAgICAgICAgZ2VuZXJhdG9yLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGNhc2VDbGFzc05hbWU6IGNhc2VDbGFzc05hbWVGb3JJbmxpbmVGcmFnbWVudChpbmxpbmVGcmFnbWVudCksXG4gICAgICAgICAgICBwYXJlbnRUeXBlOiBpbmxpbmVGcmFnbWVudC50eXBlQ29uZGl0aW9uLFxuICAgICAgICAgICAgZmllbGRzOiBpbmxpbmVGcmFnbWVudC5maWVsZHMsXG4gICAgICAgICAgICBpbmxpbmVGcmFnbWVudHM6IGlubGluZUZyYWdtZW50LmlubGluZUZyYWdtZW50cyxcbiAgICAgICAgICAgIGZyYWdtZW50U3ByZWFkczogaW5saW5lRnJhZ21lbnQuZnJhZ21lbnRTcHJlYWRzLFxuICAgICAgICAgICAgdmlld2FibGVBczoge1xuICAgICAgICAgICAgICBjYXNlQ2xhc3NOYW1lLFxuICAgICAgICAgICAgICBwcm9wZXJ0aWVzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBvYmplY3REZWNsYXJhdGlvbihnZW5lcmF0b3IsIHsgb2JqZWN0TmFtZTogY2FzZUNsYXNzTmFtZSB9LCAoKSA9PiB7XG4gICAgaWYgKHBvc3NpYmxlVHlwZXMpIHtcbiAgICAgIGdlbmVyYXRvci5wcmludE5ld2xpbmVJZk5lZWRlZCgpO1xuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCd2YWwgcG9zc2libGVUeXBlcyA9IHNjYWxhLmNvbGxlY3Rpb24uU2V0KCcpO1xuICAgICAgZ2VuZXJhdG9yLnByaW50KGpvaW4ocG9zc2libGVUeXBlcy5tYXAodHlwZSA9PiBgXCIke1N0cmluZyh0eXBlKX1cImApLCAnLCAnKSk7XG4gICAgICBnZW5lcmF0b3IucHJpbnQoJyknKTtcbiAgICB9XG5cbiAgICBpZiAodmlld2FibGVBcykge1xuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBpbXBsaWNpdCBkZWYgdG8ke3ZpZXdhYmxlQXMuY2FzZUNsYXNzTmFtZX0oYTogJHtjYXNlQ2xhc3NOYW1lfSk6ICR7dmlld2FibGVBcy5jYXNlQ2xhc3NOYW1lfSA9ICR7dmlld2FibGVBcy5jYXNlQ2xhc3NOYW1lfSgke3ZpZXdhYmxlQXMucHJvcGVydGllcy5tYXAocCA9PiBcImEuXCIgKyBwLnJlc3BvbnNlTmFtZSkuam9pbignLCAnKX0pYCk7XG4gICAgfVxuXG4gICAgaWYgKGZyYWdtZW50U3ByZWFkcykge1xuICAgICAgZnJhZ21lbnRTcHJlYWRzLmZvckVhY2gocyA9PiB7XG4gICAgICAgIGNvbnN0IGZyYWdtZW50ID0gZ2VuZXJhdG9yLmNvbnRleHQuZnJhZ21lbnRzW3NdO1xuICAgICAgICBjb25zdCBhbHdheXNEZWZpbmVkID0gaXNUeXBlUHJvcGVyU3VwZXJUeXBlT2YoZ2VuZXJhdG9yLmNvbnRleHQuc2NoZW1hLCBmcmFnbWVudC50eXBlQ29uZGl0aW9uLCBwYXJlbnRUeXBlKTtcbiAgICAgICAgaWYgKGFsd2F5c0RlZmluZWQpIHtcbiAgICAgICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYGltcGxpY2l0IGRlZiB0byR7c30oYTogJHtjYXNlQ2xhc3NOYW1lfSk6ICR7c30gPSAke3N9KCR7KGZyYWdtZW50LmZpZWxkcyB8fCBbXSkubWFwKHAgPT4gXCJhLlwiICsgcC5yZXNwb25zZU5hbWUpLmpvaW4oJywgJyl9KWApO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmIChvYmplY3RDbG9zdXJlKSB7XG4gICAgICBvYmplY3RDbG9zdXJlKCk7XG4gICAgfVxuICB9KTtcblxuICBmaWVsZHMuZmlsdGVyKGZpZWxkID0+IGlzQ29tcG9zaXRlVHlwZShnZXROYW1lZFR5cGUoZmllbGQudHlwZSkpKS5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICBjYXNlQ2xhc3NEZWNsYXJhdGlvbkZvclNlbGVjdGlvblNldChcbiAgICAgIGdlbmVyYXRvcixcbiAgICAgIHtcbiAgICAgICAgY2FzZUNsYXNzTmFtZTogY2FzZUNsYXNzTmFtZUZvclByb3BlcnR5TmFtZShmaWVsZC5yZXNwb25zZU5hbWUpLFxuICAgICAgICBwYXJlbnRUeXBlOiBnZXROYW1lZFR5cGUoZmllbGQudHlwZSksXG4gICAgICAgIGZpZWxkczogZmllbGQuZmllbGRzLFxuICAgICAgICBpbmxpbmVGcmFnbWVudHM6IGZpZWxkLmlubGluZUZyYWdtZW50cyxcbiAgICAgICAgZnJhZ21lbnRTcHJlYWRzOiBmaWVsZC5mcmFnbWVudFNwcmVhZHNcbiAgICAgIH1cbiAgICApO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gb3BlcmF0aW9uSWRlbnRpZmllcihnZW5lcmF0b3IsICB7IG9wZXJhdGlvbk5hbWUsIHNvdXJjZVdpdGhGcmFnbWVudHMsIG9wZXJhdGlvbklkIH0pIHtcbiAgaWYgKCFnZW5lcmF0b3IuY29udGV4dC5nZW5lcmF0ZU9wZXJhdGlvbklkcykge1xuICAgIHJldHVyblxuICB9XG5cbiAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgdmFsIG9wZXJhdGlvbklkZW50aWZpZXI6IFN0cmluZyA9IFwiJHtvcGVyYXRpb25JZH1cImApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdHlwZURlY2xhcmF0aW9uRm9yR3JhcGhRTFR5cGUoZ2VuZXJhdG9yLCB0eXBlKSB7XG4gIGlmICh0eXBlIGluc3RhbmNlb2YgR3JhcGhRTEVudW1UeXBlKSB7XG4gICAgZW51bWVyYXRpb25EZWNsYXJhdGlvbihnZW5lcmF0b3IsIHR5cGUpO1xuICB9IGVsc2UgaWYgKHR5cGUgaW5zdGFuY2VvZiBHcmFwaFFMSW5wdXRPYmplY3RUeXBlKSB7XG4gICAgY2FzZUNsYXNzRGVjbGFyYXRpb25Gb3JJbnB1dE9iamVjdFR5cGUoZ2VuZXJhdG9yLCB0eXBlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBlbnVtZXJhdGlvbkRlY2xhcmF0aW9uKGdlbmVyYXRvciwgdHlwZSkge1xuICBjb25zdCB7IG5hbWUsIGRlc2NyaXB0aW9uIH0gPSB0eXBlO1xuICBjb25zdCB2YWx1ZXMgPSB0eXBlLmdldFZhbHVlcygpO1xuXG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmVJZk5lZWRlZCgpO1xuICBjb21tZW50KGdlbmVyYXRvciwgZGVzY3JpcHRpb24pO1xuICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYG9iamVjdCAke25hbWV9YCk7XG4gIGdlbmVyYXRvci53aXRoaW5CbG9jaygoKSA9PiB7XG4gICAgdmFsdWVzLmZvckVhY2godmFsdWUgPT4ge1xuICAgICAgY29tbWVudChnZW5lcmF0b3IsIHZhbHVlLmRlc2NyaXB0aW9uKTtcbiAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgdmFsICR7ZXNjYXBlSWRlbnRpZmllcklmTmVlZGVkKGVudW1DYXNlTmFtZSh2YWx1ZS5uYW1lKSl9ID0gXCIke3ZhbHVlLnZhbHVlfVwiYCk7XG4gICAgfSk7XG4gIH0pO1xuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lKCk7XG59XG5cbmZ1bmN0aW9uIGNhc2VDbGFzc0RlY2xhcmF0aW9uRm9ySW5wdXRPYmplY3RUeXBlKGdlbmVyYXRvciwgdHlwZSkge1xuICBjb25zdCB7IG5hbWU6IGNhc2VDbGFzc05hbWUsIGRlc2NyaXB0aW9uIH0gPSB0eXBlO1xuICBjb25zdCBmaWVsZHMgPSBPYmplY3QudmFsdWVzKHR5cGUuZ2V0RmllbGRzKCkpO1xuICBjb25zdCBwcm9wZXJ0aWVzID0gZmllbGRzLm1hcChmaWVsZCA9PiBwcm9wZXJ0eUZyb21GaWVsZChnZW5lcmF0b3IuY29udGV4dCwgZmllbGQpKTtcblxuICBjYXNlQ2xhc3NEZWNsYXJhdGlvbihnZW5lcmF0b3IsIHsgY2FzZUNsYXNzTmFtZSwgZGVzY3JpcHRpb24sIHBhcmFtczogcHJvcGVydGllcy5tYXAocCA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IHAucHJvcGVydHlOYW1lLFxuICAgICAgdHlwZTogcC50eXBlTmFtZVxuICAgIH07XG4gIH0pfSwgKCkgPT4ge30pO1xufVxuIl19");"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const graphql_1 = require("graphql");
const graphql_2 = require("../utilities/graphql");
const printing_1 = require("../utilities/printing");
const language_1 = require("./language");
const naming_1 = require("./naming");
const values_1 = require("./values");
const types_1 = require("./types");
const CodeGenerator_1 = require("../utilities/CodeGenerator");
function generateSource(context, options) {
    const generator = new CodeGenerator_1.default(context);
    generator.printOnNewline('//  This file was automatically generated and should not be edited.');
    generator.printNewline();
    if (context.namespace) {
        language_1.packageDeclaration(generator, context.namespace);
    }
    context.typesUsed.forEach(type => {
        typeDeclarationForGraphQLType(generator, type);
    });
    Object.values(context.operations).forEach(operation => {
        classDeclarationForOperation(generator, operation);
    });
    Object.values(context.fragments).forEach(fragment => {
        caseClassDeclarationForFragment(generator, fragment);
    });
    return generator.output;
}
exports.generateSource = generateSource;
function classDeclarationForOperation(generator, { operationName, operationType, rootType, variables, fields, inlineFragments, fragmentSpreads, fragmentsReferenced, source, sourceWithFragments, operationId }) {
    let objectName;
    let protocol;
    switch (operationType) {
        case 'query':
            objectName = `${naming_1.operationClassName(operationName)}Query`;
            protocol = 'com.apollographql.scalajs.GraphQLQuery';
            break;
        case 'mutation':
            objectName = `${naming_1.operationClassName(operationName)}Mutation`;
            protocol = 'com.apollographql.scalajs.GraphQLMutation';
            break;
        default:
            throw new graphql_1.GraphQLError(`Unsupported operation type "${operationType}"`);}

    language_1.objectDeclaration(generator, {
        objectName,
        modifiers: [],
        superclass: protocol },
    () => {
        if (source) {
            generator.printOnNewline('val operationString =');
            generator.withIndent(() => {
                values_1.multilineString(generator, source);
            });
        }
        operationIdentifier(generator, { operationName, sourceWithFragments, operationId });
        if (fragmentsReferenced && fragmentsReferenced.length > 0) {
            generator.printNewlineIfNeeded();
            generator.printOnNewline('val requestString: String = { operationString');
            fragmentsReferenced.forEach(fragment => {
                generator.print(` + ${naming_1.caseClassNameForFragmentName(fragment)}.fragmentString`);
            });
            generator.print(' }');
            generator.printOnNewline('val operation = com.apollographql.scalajs.gql(requestString)');
        } else
        {
            generator.printOnNewline('val operation = com.apollographql.scalajs.gql(operationString)');
        }
        generator.printNewlineIfNeeded();
        if (variables && variables.length > 0) {
            const properties = variables.map(({ name, type }) => {
                const propertyName = language_1.escapeIdentifierIfNeeded(name);
                const typeName = types_1.typeNameFromGraphQLType(generator.context, type);
                const isOptional = !(type instanceof graphql_1.GraphQLNonNull || type.ofType instanceof graphql_1.GraphQLNonNull);
                return { name, propertyName, type, typeName, isOptional };
            });
            language_1.caseClassDeclaration(generator, { caseClassName: 'Variables', description: '', params: properties.map(p => {
                    return {
                        name: p.propertyName,
                        type: p.typeName };

                }) }, () => {});
        } else
        {
            generator.printOnNewline('type Variables = Unit');
        }
        caseClassDeclarationForSelectionSet(generator, {
            caseClassName: "Data",
            parentType: rootType,
            fields,
            inlineFragments,
            fragmentSpreads });

    });
}
exports.classDeclarationForOperation = classDeclarationForOperation;
function caseClassDeclarationForFragment(generator, { fragmentName, typeCondition, fields, inlineFragments, fragmentSpreads, source }) {
    const caseClassName = naming_1.caseClassNameForFragmentName(fragmentName);
    caseClassDeclarationForSelectionSet(generator, {
        caseClassName,
        parentType: typeCondition,
        fields,
        inlineFragments,
        fragmentSpreads },
    () => {}, () => {
        if (source) {
            generator.printOnNewline('val fragmentString =');
            generator.withIndent(() => {
                values_1.multilineString(generator, source);
            });
        }
    });
}
exports.caseClassDeclarationForFragment = caseClassDeclarationForFragment;
function caseClassDeclarationForSelectionSet(generator, { caseClassName, parentType, fields, inlineFragments, fragmentSpreads, viewableAs }, beforeClosure, objectClosure) {
    const possibleTypes = parentType ? types_1.possibleTypesForType(generator.context, parentType) : null;
    let properties;
    if (!possibleTypes || possibleTypes.length == 1) {
        properties = fields.
        map(field => naming_1.propertyFromField(generator.context, field)).
        filter(field => field.propertyName != "__typename");
        language_1.caseClassDeclaration(generator, { caseClassName, params: properties.map(p => {
                return {
                    name: p.responseName,
                    type: p.typeName };

            }) }, () => {});
    } else
    {
        generator.printNewlineIfNeeded();
        const properties = fields.
        map(field => naming_1.propertyFromField(generator.context, field)).
        filter(field => field.propertyName != "__typename");
        language_1.caseClassDeclaration(generator, { caseClassName, params: properties.map(p => {
                return {
                    name: p.responseName,
                    type: p.typeName };

            }), superclass: 'me.shadaj.slinky.core.WithRaw' }, () => {
            if (inlineFragments && inlineFragments.length > 0) {
                inlineFragments.forEach(inlineFragment => {
                    const fragClass = naming_1.caseClassNameForInlineFragment(inlineFragment);
                    generator.printOnNewline(`def as${inlineFragment.typeCondition}`);
                    generator.print(`: Option[${fragClass}] =`);
                    generator.withinBlock(() => {
                        generator.printOnNewline(`if (${fragClass}.possibleTypes.contains(this.raw.__typename.asInstanceOf[String])) Some(implicitly[me.shadaj.slinky.core.Reader[${fragClass}]].read(this.raw)) else None`);
                    });
                });
            }
            if (fragmentSpreads) {
                fragmentSpreads.forEach(s => {
                    const fragment = generator.context.fragments[s];
                    const alwaysDefined = graphql_2.isTypeProperSuperTypeOf(generator.context.schema, fragment.typeCondition, parentType);
                    if (!alwaysDefined) {
                        generator.printOnNewline(`def as${s}`);
                        generator.print(`: Option[${s}] =`);
                        generator.withinBlock(() => {
                            generator.printOnNewline(`if (${s}.possibleTypes.contains(this.raw.__typename.asInstanceOf[String])) Some(implicitly[me.shadaj.slinky.core.Reader[${s}]].read(this.raw)) else None`);
                        });
                    }
                });
            }
        });
        if (inlineFragments && inlineFragments.length > 0) {
            inlineFragments.forEach(inlineFragment => {
                caseClassDeclarationForSelectionSet(generator, {
                    caseClassName: naming_1.caseClassNameForInlineFragment(inlineFragment),
                    parentType: inlineFragment.typeCondition,
                    fields: inlineFragment.fields,
                    inlineFragments: inlineFragment.inlineFragments,
                    fragmentSpreads: inlineFragment.fragmentSpreads,
                    viewableAs: {
                        caseClassName,
                        properties } });


            });
        }
    }
    language_1.objectDeclaration(generator, { objectName: caseClassName }, () => {
        if (possibleTypes) {
            generator.printNewlineIfNeeded();
            generator.printOnNewline('val possibleTypes = scala.collection.Set(');
            generator.print(printing_1.join(possibleTypes.map(type => `"${String(type)}"`), ', '));
            generator.print(')');
        }
        if (viewableAs) {
            generator.printOnNewline(`implicit def to${viewableAs.caseClassName}(a: ${caseClassName}): ${viewableAs.caseClassName} = ${viewableAs.caseClassName}(${viewableAs.properties.map(p => "a." + p.responseName).join(', ')})`);
        }
        if (fragmentSpreads) {
            fragmentSpreads.forEach(s => {
                const fragment = generator.context.fragments[s];
                const alwaysDefined = graphql_2.isTypeProperSuperTypeOf(generator.context.schema, fragment.typeCondition, parentType);
                if (alwaysDefined) {
                    generator.printOnNewline(`implicit def to${s}(a: ${caseClassName}): ${s} = ${s}(${(fragment.fields || []).map(p => "a." + p.responseName).join(', ')})`);
                }
            });
        }
        if (objectClosure) {
            objectClosure();
        }
    });
    fields.filter(field => graphql_1.isCompositeType(graphql_1.getNamedType(field.type))).forEach(field => {
        caseClassDeclarationForSelectionSet(generator, {
            caseClassName: naming_1.caseClassNameForPropertyName(field.responseName),
            parentType: graphql_1.getNamedType(field.type),
            fields: field.fields,
            inlineFragments: field.inlineFragments,
            fragmentSpreads: field.fragmentSpreads });

    });
}
exports.caseClassDeclarationForSelectionSet = caseClassDeclarationForSelectionSet;
function operationIdentifier(generator, { operationName, sourceWithFragments, operationId }) {
    if (!generator.context.generateOperationIds) {
        return;
    }
    generator.printNewlineIfNeeded();
    generator.printOnNewline(`val operationIdentifier: String = "${operationId}"`);
}
function typeDeclarationForGraphQLType(generator, type) {
    if (type instanceof graphql_1.GraphQLEnumType) {
        enumerationDeclaration(generator, type);
    } else
    if (type instanceof graphql_1.GraphQLInputObjectType) {
        caseClassDeclarationForInputObjectType(generator, type);
    }
}
exports.typeDeclarationForGraphQLType = typeDeclarationForGraphQLType;
function enumerationDeclaration(generator, type) {
    const { name, description } = type;
    const values = type.getValues();
    generator.printNewlineIfNeeded();
    language_1.comment(generator, description);
    generator.printOnNewline(`object ${name}`);
    generator.withinBlock(() => {
        values.forEach(value => {
            language_1.comment(generator, value.description);
            generator.printOnNewline(`val ${language_1.escapeIdentifierIfNeeded(naming_1.enumCaseName(value.name))} = "${value.value}"`);
        });
    });
    generator.printNewline();
}
function caseClassDeclarationForInputObjectType(generator, type) {
    const { name: caseClassName, description } = type;
    const fields = Object.values(type.getFields());
    const properties = fields.map(field => naming_1.propertyFromField(generator.context, field));
    language_1.caseClassDeclaration(generator, { caseClassName, description, params: properties.map(p => {
            return {
                name: p.propertyName,
                type: p.typeName };

        }) }, () => {});
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvZGVHZW5lcmF0aW9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBQSxZQUFBLFFBQUEsU0FBQSxDQUFBO0FBY0EsTUFBQSxZQUFBLFFBQUEsc0JBQUEsQ0FBQTtBQUVBLE1BQUEsYUFBQSxRQUFBLHVCQUFBLENBQUE7QUFLQSxNQUFBLGFBQUEsUUFBQSxZQUFBLENBQUE7QUFVQSxNQUFBLFdBQUEsUUFBQSxVQUFBLENBQUE7QUFZQSxNQUFBLFdBQUEsUUFBQSxVQUFBLENBQUE7QUFNQSxNQUFBLFVBQUEsUUFBQSxTQUFBLENBQUE7QUFLQSxNQUFBLGtCQUFBLFFBQUEsNEJBQUEsQ0FBQTtBQUVBLFNBQUEsY0FBQSxDQUErQixPQUEvQixFQUF3QyxPQUF4QyxFQUErQztBQUM3QyxVQUFNLFlBQVksSUFBSSxnQkFBQSxPQUFKLENBQWtCLE9BQWxCLENBQWxCO0FBRUEsY0FBVSxjQUFWLENBQXlCLHFFQUF6QjtBQUNBLGNBQVUsWUFBVjtBQUVBLFFBQUksUUFBUSxTQUFaLEVBQXVCO0FBQ3JCLG1CQUFBLGtCQUFBLENBQW1CLFNBQW5CLEVBQThCLFFBQVEsU0FBdEM7QUFDRDtBQUVELFlBQVEsU0FBUixDQUFrQixPQUFsQixDQUEwQixRQUFPO0FBQy9CLHNDQUE4QixTQUE5QixFQUF5QyxJQUF6QztBQUNELEtBRkQ7QUFJQSxXQUFPLE1BQVAsQ0FBYyxRQUFRLFVBQXRCLEVBQWtDLE9BQWxDLENBQTBDLGFBQVk7QUFDcEQscUNBQTZCLFNBQTdCLEVBQXdDLFNBQXhDO0FBQ0QsS0FGRDtBQUlBLFdBQU8sTUFBUCxDQUFjLFFBQVEsU0FBdEIsRUFBaUMsT0FBakMsQ0FBeUMsWUFBVztBQUNsRCx3Q0FBZ0MsU0FBaEMsRUFBMkMsUUFBM0M7QUFDRCxLQUZEO0FBSUEsV0FBTyxVQUFVLE1BQWpCO0FBQ0Q7QUF2QkQsUUFBQSxjQUFBLEdBQUEsY0FBQTtBQXlCQSxTQUFBLDRCQUFBLENBQ0UsU0FERixFQUVFLEVBQ0UsYUFERixFQUVFLGFBRkYsRUFHRSxRQUhGLEVBSUUsU0FKRixFQUtFLE1BTEYsRUFNRSxlQU5GLEVBT0UsZUFQRixFQVFFLG1CQVJGLEVBU0UsTUFURixFQVVFLG1CQVZGLEVBV0UsV0FYRixFQUZGLEVBY0c7QUFFRCxRQUFJLFVBQUo7QUFDQSxRQUFJLFFBQUo7QUFFQSxZQUFRLGFBQVI7QUFDRSxhQUFLLE9BQUw7QUFDRSx5QkFBYSxHQUFHLFNBQUEsa0JBQUEsQ0FBbUIsYUFBbkIsQ0FBaUMsT0FBakQ7QUFDQSx1QkFBVyx3Q0FBWDtBQUNBO0FBQ0YsYUFBSyxVQUFMO0FBQ0UseUJBQWEsR0FBRyxTQUFBLGtCQUFBLENBQW1CLGFBQW5CLENBQWlDLFVBQWpEO0FBQ0EsdUJBQVcsMkNBQVg7QUFDQTtBQUNGO0FBQ0Usa0JBQU0sSUFBSSxVQUFBLFlBQUosQ0FBaUIsK0JBQStCLGFBQWEsR0FBN0QsQ0FBTixDQVZKOztBQWFBLGVBQUEsaUJBQUEsQ0FBa0IsU0FBbEIsRUFBNkI7QUFDM0Isa0JBRDJCO0FBRTNCLG1CQUFXLEVBRmdCO0FBRzNCLG9CQUFZLFFBSGUsRUFBN0I7QUFJRyxVQUFLO0FBQ04sWUFBSSxNQUFKLEVBQVk7QUFDVixzQkFBVSxjQUFWLENBQXlCLHVCQUF6QjtBQUNBLHNCQUFVLFVBQVYsQ0FBcUIsTUFBSztBQUN4Qix5QkFBQSxlQUFBLENBQWdCLFNBQWhCLEVBQTJCLE1BQTNCO0FBQ0QsYUFGRDtBQUdEO0FBRUQsNEJBQW9CLFNBQXBCLEVBQStCLEVBQUUsYUFBRixFQUFpQixtQkFBakIsRUFBc0MsV0FBdEMsRUFBL0I7QUFFQSxZQUFJLHVCQUF1QixvQkFBb0IsTUFBcEIsR0FBNkIsQ0FBeEQsRUFBMkQ7QUFDekQsc0JBQVUsb0JBQVY7QUFDQSxzQkFBVSxjQUFWLENBQXlCLCtDQUF6QjtBQUNBLGdDQUFvQixPQUFwQixDQUE0QixZQUFXO0FBQ3JDLDBCQUFVLEtBQVYsQ0FBZ0IsTUFBTSxTQUFBLDRCQUFBLENBQTZCLFFBQTdCLENBQXNDLGlCQUE1RDtBQUNELGFBRkQ7QUFHQSxzQkFBVSxLQUFWLENBQWdCLElBQWhCO0FBRUEsc0JBQVUsY0FBVixDQUF5Qiw4REFBekI7QUFDRCxTQVREO0FBU087QUFDTCxzQkFBVSxjQUFWLENBQXlCLGdFQUF6QjtBQUNEO0FBRUQsa0JBQVUsb0JBQVY7QUFFQSxZQUFJLGFBQWEsVUFBVSxNQUFWLEdBQW1CLENBQXBDLEVBQXVDO0FBQ3JDLGtCQUFNLGFBQWEsVUFBVSxHQUFWLENBQWMsQ0FBQyxFQUFFLElBQUYsRUFBUSxJQUFSLEVBQUQsS0FBbUI7QUFDbEQsc0JBQU0sZUFBZSxXQUFBLHdCQUFBLENBQXlCLElBQXpCLENBQXJCO0FBQ0Esc0JBQU0sV0FBVyxRQUFBLHVCQUFBLENBQXdCLFVBQVUsT0FBbEMsRUFBMkMsSUFBM0MsQ0FBakI7QUFDQSxzQkFBTSxhQUFhLEVBQUUsZ0JBQWdCLFVBQUEsY0FBaEIsSUFBa0MsS0FBSyxNQUFMLFlBQXVCLFVBQUEsY0FBM0QsQ0FBbkI7QUFDQSx1QkFBTyxFQUFFLElBQUYsRUFBUSxZQUFSLEVBQXNCLElBQXRCLEVBQTRCLFFBQTVCLEVBQXNDLFVBQXRDLEVBQVA7QUFDRCxhQUxrQixDQUFuQjtBQU9BLHVCQUFBLG9CQUFBLENBQXFCLFNBQXJCLEVBQWdDLEVBQUUsZUFBZSxXQUFqQixFQUE4QixhQUFhLEVBQTNDLEVBQStDLFFBQVEsV0FBVyxHQUFYLENBQWUsS0FBSTtBQUN4RywyQkFBTztBQUNMLDhCQUFNLEVBQUUsWUFESDtBQUVMLDhCQUFNLEVBQUUsUUFGSCxFQUFQOztBQUlELGlCQUxzRixDQUF2RCxFQUFoQyxFQUtLLE1BQUssQ0FBRyxDQUxiO0FBTUQsU0FkRDtBQWNPO0FBQ0wsc0JBQVUsY0FBVixDQUF5Qix1QkFBekI7QUFDRDtBQUVELDRDQUNFLFNBREYsRUFFRTtBQUNFLDJCQUFlLE1BRGpCO0FBRUUsd0JBQVksUUFGZDtBQUdFLGtCQUhGO0FBSUUsMkJBSkY7QUFLRSwyQkFMRixFQUZGOztBQVVELEtBekREO0FBMEREO0FBMUZELFFBQUEsNEJBQUEsR0FBQSw0QkFBQTtBQTRGQSxTQUFBLCtCQUFBLENBQ0UsU0FERixFQUVFLEVBQ0UsWUFERixFQUVFLGFBRkYsRUFHRSxNQUhGLEVBSUUsZUFKRixFQUtFLGVBTEYsRUFNRSxNQU5GLEVBRkYsRUFTRztBQUVELFVBQU0sZ0JBQWdCLFNBQUEsNEJBQUEsQ0FBNkIsWUFBN0IsQ0FBdEI7QUFFQSx3Q0FBb0MsU0FBcEMsRUFBK0M7QUFDN0MscUJBRDZDO0FBRTdDLG9CQUFZLGFBRmlDO0FBRzdDLGNBSDZDO0FBSTdDLHVCQUo2QztBQUs3Qyx1QkFMNkMsRUFBL0M7QUFNRyxVQUFLLENBQUcsQ0FOWCxFQU1hLE1BQUs7QUFDaEIsWUFBSSxNQUFKLEVBQVk7QUFDVixzQkFBVSxjQUFWLENBQXlCLHNCQUF6QjtBQUNBLHNCQUFVLFVBQVYsQ0FBcUIsTUFBSztBQUN4Qix5QkFBQSxlQUFBLENBQWdCLFNBQWhCLEVBQTJCLE1BQTNCO0FBQ0QsYUFGRDtBQUdEO0FBQ0YsS0FiRDtBQWNEO0FBM0JELFFBQUEsK0JBQUEsR0FBQSwrQkFBQTtBQTZCQSxTQUFBLG1DQUFBLENBQ0UsU0FERixFQUVFLEVBQ0UsYUFERixFQUVFLFVBRkYsRUFHRSxNQUhGLEVBSUUsZUFKRixFQUtFLGVBTEYsRUFNRSxVQU5GLEVBRkYsRUFVRSxhQVZGLEVBV0UsYUFYRixFQVdlO0FBRWIsVUFBTSxnQkFBZ0IsYUFBYSxRQUFBLG9CQUFBLENBQXFCLFVBQVUsT0FBL0IsRUFBd0MsVUFBeEMsQ0FBYixHQUFtRSxJQUF6RjtBQUVBLFFBQUksVUFBSjtBQUVBLFFBQUksQ0FBQyxhQUFELElBQWtCLGNBQWMsTUFBZCxJQUF3QixDQUE5QyxFQUFpRDtBQUMvQyxxQkFBYTtBQUNWLFdBRFUsQ0FDTixTQUFTLFNBQUEsaUJBQUEsQ0FBa0IsVUFBVSxPQUE1QixFQUFxQyxLQUFyQyxDQURIO0FBRVYsY0FGVSxDQUVILFNBQVMsTUFBTSxZQUFOLElBQXNCLFlBRjVCLENBQWI7QUFJQSxtQkFBQSxvQkFBQSxDQUFxQixTQUFyQixFQUFnQyxFQUFFLGFBQUYsRUFBaUIsUUFBUSxXQUFXLEdBQVgsQ0FBZSxLQUFJO0FBQzFFLHVCQUFPO0FBQ0wsMEJBQU0sRUFBRSxZQURIO0FBRUwsMEJBQU0sRUFBRSxRQUZILEVBQVA7O0FBSUQsYUFMd0QsQ0FBekIsRUFBaEMsRUFLTSxNQUFLLENBQUcsQ0FMZDtBQU1ELEtBWEQ7QUFXTztBQUNMLGtCQUFVLG9CQUFWO0FBQ0EsY0FBTSxhQUFhO0FBQ2hCLFdBRGdCLENBQ1osU0FBUyxTQUFBLGlCQUFBLENBQWtCLFVBQVUsT0FBNUIsRUFBcUMsS0FBckMsQ0FERztBQUVoQixjQUZnQixDQUVULFNBQVMsTUFBTSxZQUFOLElBQXNCLFlBRnRCLENBQW5CO0FBSUEsbUJBQUEsb0JBQUEsQ0FBcUIsU0FBckIsRUFBZ0MsRUFBRSxhQUFGLEVBQWlCLFFBQVEsV0FBVyxHQUFYLENBQWUsS0FBSTtBQUMxRSx1QkFBTztBQUNMLDBCQUFNLEVBQUUsWUFESDtBQUVMLDBCQUFNLEVBQUUsUUFGSCxFQUFQOztBQUlELGFBTHdELENBQXpCLEVBSzVCLFlBQVksK0JBTGdCLEVBQWhDLEVBS2tELE1BQUs7QUFDckQsZ0JBQUksbUJBQW1CLGdCQUFnQixNQUFoQixHQUF5QixDQUFoRCxFQUFtRDtBQUNqRCxnQ0FBZ0IsT0FBaEIsQ0FBeUIsY0FBRCxJQUFtQjtBQUN6QywwQkFBTSxZQUFZLFNBQUEsOEJBQUEsQ0FBK0IsY0FBL0IsQ0FBbEI7QUFDQSw4QkFBVSxjQUFWLENBQXlCLFNBQVMsZUFBZSxhQUFhLEVBQTlEO0FBQ0EsOEJBQVUsS0FBVixDQUFnQixZQUFZLFNBQVMsS0FBckM7QUFDQSw4QkFBVSxXQUFWLENBQXNCLE1BQUs7QUFDekIsa0NBQVUsY0FBVixDQUF5QixPQUFPLFNBQVMsbUhBQW1ILFNBQVMsOEJBQXJLO0FBQ0QscUJBRkQ7QUFHRCxpQkFQRDtBQVFEO0FBRUQsZ0JBQUksZUFBSixFQUFxQjtBQUNuQixnQ0FBZ0IsT0FBaEIsQ0FBd0IsS0FBSTtBQUMxQiwwQkFBTSxXQUFXLFVBQVUsT0FBVixDQUFrQixTQUFsQixDQUE0QixDQUE1QixDQUFqQjtBQUNBLDBCQUFNLGdCQUFnQixVQUFBLHVCQUFBLENBQXdCLFVBQVUsT0FBVixDQUFrQixNQUExQyxFQUFrRCxTQUFTLGFBQTNELEVBQTBFLFVBQTFFLENBQXRCO0FBQ0Esd0JBQUksQ0FBQyxhQUFMLEVBQW9CO0FBQ2xCLGtDQUFVLGNBQVYsQ0FBeUIsU0FBUyxDQUFDLEVBQW5DO0FBQ0Esa0NBQVUsS0FBVixDQUFnQixZQUFZLENBQUMsS0FBN0I7QUFDQSxrQ0FBVSxXQUFWLENBQXNCLE1BQUs7QUFDekIsc0NBQVUsY0FBVixDQUF5QixPQUFPLENBQUMsbUhBQW1ILENBQUMsOEJBQXJKO0FBQ0QseUJBRkQ7QUFHRDtBQUNGLGlCQVZEO0FBV0Q7QUFDRixTQTlCRDtBQWlDQSxZQUFJLG1CQUFtQixnQkFBZ0IsTUFBaEIsR0FBeUIsQ0FBaEQsRUFBbUQ7QUFDakQsNEJBQWdCLE9BQWhCLENBQXlCLGNBQUQsSUFBbUI7QUFDekMsb0RBQ0UsU0FERixFQUVFO0FBQ0UsbUNBQWUsU0FBQSw4QkFBQSxDQUErQixjQUEvQixDQURqQjtBQUVFLGdDQUFZLGVBQWUsYUFGN0I7QUFHRSw0QkFBUSxlQUFlLE1BSHpCO0FBSUUscUNBQWlCLGVBQWUsZUFKbEM7QUFLRSxxQ0FBaUIsZUFBZSxlQUxsQztBQU1FLGdDQUFZO0FBQ1YscUNBRFU7QUFFVixrQ0FGVSxFQU5kLEVBRkY7OztBQWNELGFBZkQ7QUFnQkQ7QUFDRjtBQUVELGVBQUEsaUJBQUEsQ0FBa0IsU0FBbEIsRUFBNkIsRUFBRSxZQUFZLGFBQWQsRUFBN0IsRUFBNEQsTUFBSztBQUMvRCxZQUFJLGFBQUosRUFBbUI7QUFDakIsc0JBQVUsb0JBQVY7QUFDQSxzQkFBVSxjQUFWLENBQXlCLDJDQUF6QjtBQUNBLHNCQUFVLEtBQVYsQ0FBZ0IsV0FBQSxJQUFBLENBQUssY0FBYyxHQUFkLENBQWtCLFFBQVEsSUFBSSxPQUFPLElBQVAsQ0FBWSxHQUExQyxDQUFMLEVBQXFELElBQXJELENBQWhCO0FBQ0Esc0JBQVUsS0FBVixDQUFnQixHQUFoQjtBQUNEO0FBRUQsWUFBSSxVQUFKLEVBQWdCO0FBQ2Qsc0JBQVUsY0FBVixDQUF5QixrQkFBa0IsV0FBVyxhQUFhLE9BQU8sYUFBYSxNQUFNLFdBQVcsYUFBYSxNQUFNLFdBQVcsYUFBYSxJQUFJLFdBQVcsVUFBWCxDQUFzQixHQUF0QixDQUEwQixLQUFLLE9BQU8sRUFBRSxZQUF4QyxFQUFzRCxJQUF0RCxDQUEyRCxJQUEzRCxDQUFnRSxHQUF2TjtBQUNEO0FBRUQsWUFBSSxlQUFKLEVBQXFCO0FBQ25CLDRCQUFnQixPQUFoQixDQUF3QixLQUFJO0FBQzFCLHNCQUFNLFdBQVcsVUFBVSxPQUFWLENBQWtCLFNBQWxCLENBQTRCLENBQTVCLENBQWpCO0FBQ0Esc0JBQU0sZ0JBQWdCLFVBQUEsdUJBQUEsQ0FBd0IsVUFBVSxPQUFWLENBQWtCLE1BQTFDLEVBQWtELFNBQVMsYUFBM0QsRUFBMEUsVUFBMUUsQ0FBdEI7QUFDQSxvQkFBSSxhQUFKLEVBQW1CO0FBQ2pCLDhCQUFVLGNBQVYsQ0FBeUIsa0JBQWtCLENBQUMsT0FBTyxhQUFhLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsTUFBVCxJQUFtQixFQUFwQixFQUF3QixHQUF4QixDQUE0QixLQUFLLE9BQU8sRUFBRSxZQUExQyxFQUF3RCxJQUF4RCxDQUE2RCxJQUE3RCxDQUFrRSxHQUFwSjtBQUNEO0FBQ0YsYUFORDtBQU9EO0FBRUQsWUFBSSxhQUFKLEVBQW1CO0FBQ2pCO0FBQ0Q7QUFDRixLQXpCRDtBQTJCQSxXQUFPLE1BQVAsQ0FBYyxTQUFTLFVBQUEsZUFBQSxDQUFnQixVQUFBLFlBQUEsQ0FBYSxNQUFNLElBQW5CLENBQWhCLENBQXZCLEVBQWtFLE9BQWxFLENBQTBFLFNBQVE7QUFDaEYsNENBQ0UsU0FERixFQUVFO0FBQ0UsMkJBQWUsU0FBQSw0QkFBQSxDQUE2QixNQUFNLFlBQW5DLENBRGpCO0FBRUUsd0JBQVksVUFBQSxZQUFBLENBQWEsTUFBTSxJQUFuQixDQUZkO0FBR0Usb0JBQVEsTUFBTSxNQUhoQjtBQUlFLDZCQUFpQixNQUFNLGVBSnpCO0FBS0UsNkJBQWlCLE1BQU0sZUFMekIsRUFGRjs7QUFVRCxLQVhEO0FBWUQ7QUE5SEQsUUFBQSxtQ0FBQSxHQUFBLG1DQUFBO0FBZ0lBLFNBQUEsbUJBQUEsQ0FBNkIsU0FBN0IsRUFBeUMsRUFBRSxhQUFGLEVBQWlCLG1CQUFqQixFQUFzQyxXQUF0QyxFQUF6QyxFQUE0RjtBQUMxRixRQUFJLENBQUMsVUFBVSxPQUFWLENBQWtCLG9CQUF2QixFQUE2QztBQUMzQztBQUNEO0FBRUQsY0FBVSxvQkFBVjtBQUNBLGNBQVUsY0FBVixDQUF5QixzQ0FBc0MsV0FBVyxHQUExRTtBQUNEO0FBRUQsU0FBQSw2QkFBQSxDQUE4QyxTQUE5QyxFQUF5RCxJQUF6RCxFQUE2RDtBQUMzRCxRQUFJLGdCQUFnQixVQUFBLGVBQXBCLEVBQXFDO0FBQ25DLCtCQUF1QixTQUF2QixFQUFrQyxJQUFsQztBQUNELEtBRkQ7QUFFTyxRQUFJLGdCQUFnQixVQUFBLHNCQUFwQixFQUE0QztBQUNqRCwrQ0FBdUMsU0FBdkMsRUFBa0QsSUFBbEQ7QUFDRDtBQUNGO0FBTkQsUUFBQSw2QkFBQSxHQUFBLDZCQUFBO0FBUUEsU0FBQSxzQkFBQSxDQUFnQyxTQUFoQyxFQUEyQyxJQUEzQyxFQUErQztBQUM3QyxVQUFNLEVBQUUsSUFBRixFQUFRLFdBQVIsS0FBd0IsSUFBOUI7QUFDQSxVQUFNLFNBQVMsS0FBSyxTQUFMLEVBQWY7QUFFQSxjQUFVLG9CQUFWO0FBQ0EsZUFBQSxPQUFBLENBQVEsU0FBUixFQUFtQixXQUFuQjtBQUNBLGNBQVUsY0FBVixDQUF5QixVQUFVLElBQUksRUFBdkM7QUFDQSxjQUFVLFdBQVYsQ0FBc0IsTUFBSztBQUN6QixlQUFPLE9BQVAsQ0FBZSxTQUFRO0FBQ3JCLHVCQUFBLE9BQUEsQ0FBUSxTQUFSLEVBQW1CLE1BQU0sV0FBekI7QUFDQSxzQkFBVSxjQUFWLENBQXlCLE9BQU8sV0FBQSx3QkFBQSxDQUF5QixTQUFBLFlBQUEsQ0FBYSxNQUFNLElBQW5CLENBQXpCLENBQWtELE9BQU8sTUFBTSxLQUFLLEdBQXBHO0FBQ0QsU0FIRDtBQUlELEtBTEQ7QUFNQSxjQUFVLFlBQVY7QUFDRDtBQUVELFNBQUEsc0NBQUEsQ0FBZ0QsU0FBaEQsRUFBMkQsSUFBM0QsRUFBK0Q7QUFDN0QsVUFBTSxFQUFFLE1BQU0sYUFBUixFQUF1QixXQUF2QixLQUF1QyxJQUE3QztBQUNBLFVBQU0sU0FBUyxPQUFPLE1BQVAsQ0FBYyxLQUFLLFNBQUwsRUFBZCxDQUFmO0FBQ0EsVUFBTSxhQUFhLE9BQU8sR0FBUCxDQUFXLFNBQVMsU0FBQSxpQkFBQSxDQUFrQixVQUFVLE9BQTVCLEVBQXFDLEtBQXJDLENBQXBCLENBQW5CO0FBRUEsZUFBQSxvQkFBQSxDQUFxQixTQUFyQixFQUFnQyxFQUFFLGFBQUYsRUFBaUIsV0FBakIsRUFBOEIsUUFBUSxXQUFXLEdBQVgsQ0FBZSxLQUFJO0FBQ3ZGLG1CQUFPO0FBQ0wsc0JBQU0sRUFBRSxZQURIO0FBRUwsc0JBQU0sRUFBRSxRQUZILEVBQVA7O0FBSUQsU0FMcUUsQ0FBdEMsRUFBaEMsRUFLSyxNQUFLLENBQUcsQ0FMYjtBQU1EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgR3JhcGhRTEVycm9yLFxuICBnZXROYW1lZFR5cGUsXG4gIGlzQ29tcG9zaXRlVHlwZSxcbiAgaXNBYnN0cmFjdFR5cGUsXG4gIGlzRXF1YWxUeXBlLFxuICBHcmFwaFFMU2NhbGFyVHlwZSxcbiAgR3JhcGhRTEVudW1UeXBlLFxuICBHcmFwaFFMTGlzdCxcbiAgR3JhcGhRTE5vbk51bGwsXG4gIEdyYXBoUUxJRCxcbiAgR3JhcGhRTElucHV0T2JqZWN0VHlwZVxufSBmcm9tICdncmFwaHFsJ1xuXG5pbXBvcnQgIHsgaXNUeXBlUHJvcGVyU3VwZXJUeXBlT2YgfSBmcm9tICcuLi91dGlsaXRpZXMvZ3JhcGhxbCdcblxuaW1wb3J0IHtcbiAgam9pbixcbiAgd3JhcCxcbn0gZnJvbSAnLi4vdXRpbGl0aWVzL3ByaW50aW5nJztcblxuaW1wb3J0IHtcbiAgcGFja2FnZURlY2xhcmF0aW9uLFxuICBvYmplY3REZWNsYXJhdGlvbixcbiAgY2FzZUNsYXNzRGVjbGFyYXRpb24sXG4gIHByb3BlcnR5RGVjbGFyYXRpb24sXG4gIHByb3BlcnR5RGVjbGFyYXRpb25zLFxuICBlc2NhcGVJZGVudGlmaWVySWZOZWVkZWQsXG4gIGNvbW1lbnRcbn0gZnJvbSAnLi9sYW5ndWFnZSc7XG5cbmltcG9ydCB7XG4gIGNhc2VDbGFzc05hbWVGb3JQcm9wZXJ0eU5hbWUsXG4gIGNhc2VDbGFzc05hbWVGb3JGcmFnbWVudE5hbWUsXG4gIGNhc2VDbGFzc05hbWVGb3JJbmxpbmVGcmFnbWVudCxcbiAgb3BlcmF0aW9uQ2xhc3NOYW1lLFxuICBlbnVtQ2FzZU5hbWUsXG4gIHByb3BlcnRpZXNGcm9tU2VsZWN0aW9uU2V0LFxuICBwcm9wZXJ0eUZyb21GaWVsZCxcbiAgcHJvcGVydHlGcm9tSW5saW5lRnJhZ21lbnQsXG4gIHByb3BlcnR5RnJvbUZyYWdtZW50U3ByZWFkXG59IGZyb20gJy4vbmFtaW5nJztcblxuaW1wb3J0IHtcbiAgZXNjYXBlZFN0cmluZyxcbiAgbXVsdGlsaW5lU3RyaW5nLFxuICBkaWN0aW9uYXJ5TGl0ZXJhbEZvckZpZWxkQXJndW1lbnRzLFxufSBmcm9tICcuL3ZhbHVlcyc7XG5cbmltcG9ydCB7XG4gIHBvc3NpYmxlVHlwZXNGb3JUeXBlLFxuICB0eXBlTmFtZUZyb21HcmFwaFFMVHlwZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCBDb2RlR2VuZXJhdG9yIGZyb20gJy4uL3V0aWxpdGllcy9Db2RlR2VuZXJhdG9yJztcblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlU291cmNlKGNvbnRleHQsIG9wdGlvbnMpIHtcbiAgY29uc3QgZ2VuZXJhdG9yID0gbmV3IENvZGVHZW5lcmF0b3IoY29udGV4dCk7XG5cbiAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCcvLyAgVGhpcyBmaWxlIHdhcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBlZGl0ZWQuJyk7XG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcblxuICBpZiAoY29udGV4dC5uYW1lc3BhY2UpIHtcbiAgICBwYWNrYWdlRGVjbGFyYXRpb24oZ2VuZXJhdG9yLCBjb250ZXh0Lm5hbWVzcGFjZSk7XG4gIH1cblxuICBjb250ZXh0LnR5cGVzVXNlZC5mb3JFYWNoKHR5cGUgPT4ge1xuICAgIHR5cGVEZWNsYXJhdGlvbkZvckdyYXBoUUxUeXBlKGdlbmVyYXRvciwgdHlwZSk7XG4gIH0pO1xuXG4gIE9iamVjdC52YWx1ZXMoY29udGV4dC5vcGVyYXRpb25zKS5mb3JFYWNoKG9wZXJhdGlvbiA9PiB7XG4gICAgY2xhc3NEZWNsYXJhdGlvbkZvck9wZXJhdGlvbihnZW5lcmF0b3IsIG9wZXJhdGlvbik7XG4gIH0pO1xuXG4gIE9iamVjdC52YWx1ZXMoY29udGV4dC5mcmFnbWVudHMpLmZvckVhY2goZnJhZ21lbnQgPT4ge1xuICAgIGNhc2VDbGFzc0RlY2xhcmF0aW9uRm9yRnJhZ21lbnQoZ2VuZXJhdG9yLCBmcmFnbWVudCk7XG4gIH0pO1xuXG4gIHJldHVybiBnZW5lcmF0b3Iub3V0cHV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xhc3NEZWNsYXJhdGlvbkZvck9wZXJhdGlvbihcbiAgZ2VuZXJhdG9yLFxuICB7XG4gICAgb3BlcmF0aW9uTmFtZSxcbiAgICBvcGVyYXRpb25UeXBlLFxuICAgIHJvb3RUeXBlLFxuICAgIHZhcmlhYmxlcyxcbiAgICBmaWVsZHMsXG4gICAgaW5saW5lRnJhZ21lbnRzLFxuICAgIGZyYWdtZW50U3ByZWFkcyxcbiAgICBmcmFnbWVudHNSZWZlcmVuY2VkLFxuICAgIHNvdXJjZSxcbiAgICBzb3VyY2VXaXRoRnJhZ21lbnRzLFxuICAgIG9wZXJhdGlvbklkXG4gIH1cbikge1xuICBsZXQgb2JqZWN0TmFtZTtcbiAgbGV0IHByb3RvY29sO1xuXG4gIHN3aXRjaCAob3BlcmF0aW9uVHlwZSkge1xuICAgIGNhc2UgJ3F1ZXJ5JzpcbiAgICAgIG9iamVjdE5hbWUgPSBgJHtvcGVyYXRpb25DbGFzc05hbWUob3BlcmF0aW9uTmFtZSl9UXVlcnlgO1xuICAgICAgcHJvdG9jb2wgPSAnY29tLmFwb2xsb2dyYXBocWwuc2NhbGFqcy5HcmFwaFFMUXVlcnknO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnbXV0YXRpb24nOlxuICAgICAgb2JqZWN0TmFtZSA9IGAke29wZXJhdGlvbkNsYXNzTmFtZShvcGVyYXRpb25OYW1lKX1NdXRhdGlvbmA7XG4gICAgICBwcm90b2NvbCA9ICdjb20uYXBvbGxvZ3JhcGhxbC5zY2FsYWpzLkdyYXBoUUxNdXRhdGlvbic7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEdyYXBoUUxFcnJvcihgVW5zdXBwb3J0ZWQgb3BlcmF0aW9uIHR5cGUgXCIke29wZXJhdGlvblR5cGV9XCJgKTtcbiAgfVxuXG4gIG9iamVjdERlY2xhcmF0aW9uKGdlbmVyYXRvciwge1xuICAgIG9iamVjdE5hbWUsXG4gICAgbW9kaWZpZXJzOiBbXSxcbiAgICBzdXBlcmNsYXNzOiBwcm90b2NvbFxuICB9LCAoKSA9PiB7XG4gICAgaWYgKHNvdXJjZSkge1xuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKCd2YWwgb3BlcmF0aW9uU3RyaW5nID0nKTtcbiAgICAgIGdlbmVyYXRvci53aXRoSW5kZW50KCgpID0+IHtcbiAgICAgICAgbXVsdGlsaW5lU3RyaW5nKGdlbmVyYXRvciwgc291cmNlKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIG9wZXJhdGlvbklkZW50aWZpZXIoZ2VuZXJhdG9yLCB7IG9wZXJhdGlvbk5hbWUsIHNvdXJjZVdpdGhGcmFnbWVudHMsIG9wZXJhdGlvbklkIH0pO1xuXG4gICAgaWYgKGZyYWdtZW50c1JlZmVyZW5jZWQgJiYgZnJhZ21lbnRzUmVmZXJlbmNlZC5sZW5ndGggPiAwKSB7XG4gICAgICBnZW5lcmF0b3IucHJpbnROZXdsaW5lSWZOZWVkZWQoKTtcbiAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgndmFsIHJlcXVlc3RTdHJpbmc6IFN0cmluZyA9IHsgb3BlcmF0aW9uU3RyaW5nJyk7XG4gICAgICBmcmFnbWVudHNSZWZlcmVuY2VkLmZvckVhY2goZnJhZ21lbnQgPT4ge1xuICAgICAgICBnZW5lcmF0b3IucHJpbnQoYCArICR7Y2FzZUNsYXNzTmFtZUZvckZyYWdtZW50TmFtZShmcmFnbWVudCl9LmZyYWdtZW50U3RyaW5nYClcbiAgICAgIH0pO1xuICAgICAgZ2VuZXJhdG9yLnByaW50KCcgfScpO1xuXG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ3ZhbCBvcGVyYXRpb24gPSBjb20uYXBvbGxvZ3JhcGhxbC5zY2FsYWpzLmdxbChyZXF1ZXN0U3RyaW5nKScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ3ZhbCBvcGVyYXRpb24gPSBjb20uYXBvbGxvZ3JhcGhxbC5zY2FsYWpzLmdxbChvcGVyYXRpb25TdHJpbmcpJyk7XG4gICAgfVxuXG4gICAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG5cbiAgICBpZiAodmFyaWFibGVzICYmIHZhcmlhYmxlcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBwcm9wZXJ0aWVzID0gdmFyaWFibGVzLm1hcCgoeyBuYW1lLCB0eXBlIH0pID0+IHtcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gZXNjYXBlSWRlbnRpZmllcklmTmVlZGVkKG5hbWUpO1xuICAgICAgICBjb25zdCB0eXBlTmFtZSA9IHR5cGVOYW1lRnJvbUdyYXBoUUxUeXBlKGdlbmVyYXRvci5jb250ZXh0LCB0eXBlKTtcbiAgICAgICAgY29uc3QgaXNPcHRpb25hbCA9ICEodHlwZSBpbnN0YW5jZW9mIEdyYXBoUUxOb25OdWxsIHx8IHR5cGUub2ZUeXBlIGluc3RhbmNlb2YgR3JhcGhRTE5vbk51bGwpO1xuICAgICAgICByZXR1cm4geyBuYW1lLCBwcm9wZXJ0eU5hbWUsIHR5cGUsIHR5cGVOYW1lLCBpc09wdGlvbmFsIH07XG4gICAgICB9KTtcblxuICAgICAgY2FzZUNsYXNzRGVjbGFyYXRpb24oZ2VuZXJhdG9yLCB7IGNhc2VDbGFzc05hbWU6ICdWYXJpYWJsZXMnLCBkZXNjcmlwdGlvbjogJycsIHBhcmFtczogcHJvcGVydGllcy5tYXAocCA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogcC5wcm9wZXJ0eU5hbWUsXG4gICAgICAgICAgdHlwZTogcC50eXBlTmFtZVxuICAgICAgICB9O1xuICAgICAgfSl9LCAoKSA9PiB7fSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgndHlwZSBWYXJpYWJsZXMgPSBVbml0Jyk7XG4gICAgfVxuXG4gICAgY2FzZUNsYXNzRGVjbGFyYXRpb25Gb3JTZWxlY3Rpb25TZXQoXG4gICAgICBnZW5lcmF0b3IsXG4gICAgICB7XG4gICAgICAgIGNhc2VDbGFzc05hbWU6IFwiRGF0YVwiLFxuICAgICAgICBwYXJlbnRUeXBlOiByb290VHlwZSxcbiAgICAgICAgZmllbGRzLFxuICAgICAgICBpbmxpbmVGcmFnbWVudHMsXG4gICAgICAgIGZyYWdtZW50U3ByZWFkc1xuICAgICAgfVxuICAgICk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FzZUNsYXNzRGVjbGFyYXRpb25Gb3JGcmFnbWVudChcbiAgZ2VuZXJhdG9yLFxuICB7XG4gICAgZnJhZ21lbnROYW1lLFxuICAgIHR5cGVDb25kaXRpb24sXG4gICAgZmllbGRzLFxuICAgIGlubGluZUZyYWdtZW50cyxcbiAgICBmcmFnbWVudFNwcmVhZHMsXG4gICAgc291cmNlXG4gIH1cbikge1xuICBjb25zdCBjYXNlQ2xhc3NOYW1lID0gY2FzZUNsYXNzTmFtZUZvckZyYWdtZW50TmFtZShmcmFnbWVudE5hbWUpO1xuXG4gIGNhc2VDbGFzc0RlY2xhcmF0aW9uRm9yU2VsZWN0aW9uU2V0KGdlbmVyYXRvciwge1xuICAgIGNhc2VDbGFzc05hbWUsXG4gICAgcGFyZW50VHlwZTogdHlwZUNvbmRpdGlvbixcbiAgICBmaWVsZHMsXG4gICAgaW5saW5lRnJhZ21lbnRzLFxuICAgIGZyYWdtZW50U3ByZWFkc1xuICB9LCAoKSA9PiB7fSwgKCkgPT4ge1xuICAgIGlmIChzb3VyY2UpIHtcbiAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZSgndmFsIGZyYWdtZW50U3RyaW5nID0nKTtcbiAgICAgIGdlbmVyYXRvci53aXRoSW5kZW50KCgpID0+IHtcbiAgICAgICAgbXVsdGlsaW5lU3RyaW5nKGdlbmVyYXRvciwgc291cmNlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYXNlQ2xhc3NEZWNsYXJhdGlvbkZvclNlbGVjdGlvblNldChcbiAgZ2VuZXJhdG9yLFxuICB7XG4gICAgY2FzZUNsYXNzTmFtZSxcbiAgICBwYXJlbnRUeXBlLFxuICAgIGZpZWxkcyxcbiAgICBpbmxpbmVGcmFnbWVudHMsXG4gICAgZnJhZ21lbnRTcHJlYWRzLFxuICAgIHZpZXdhYmxlQXNcbiAgfSxcbiAgYmVmb3JlQ2xvc3VyZSxcbiAgb2JqZWN0Q2xvc3VyZSxcbikge1xuICBjb25zdCBwb3NzaWJsZVR5cGVzID0gcGFyZW50VHlwZSA/IHBvc3NpYmxlVHlwZXNGb3JUeXBlKGdlbmVyYXRvci5jb250ZXh0LCBwYXJlbnRUeXBlKSA6IG51bGw7XG5cbiAgbGV0IHByb3BlcnRpZXM7XG5cbiAgaWYgKCFwb3NzaWJsZVR5cGVzIHx8IHBvc3NpYmxlVHlwZXMubGVuZ3RoID09IDEpIHtcbiAgICBwcm9wZXJ0aWVzID0gZmllbGRzXG4gICAgICAubWFwKGZpZWxkID0+IHByb3BlcnR5RnJvbUZpZWxkKGdlbmVyYXRvci5jb250ZXh0LCBmaWVsZCkpXG4gICAgICAuZmlsdGVyKGZpZWxkID0+IGZpZWxkLnByb3BlcnR5TmFtZSAhPSBcIl9fdHlwZW5hbWVcIik7XG5cbiAgICBjYXNlQ2xhc3NEZWNsYXJhdGlvbihnZW5lcmF0b3IsIHsgY2FzZUNsYXNzTmFtZSwgcGFyYW1zOiBwcm9wZXJ0aWVzLm1hcChwID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IHAucmVzcG9uc2VOYW1lLFxuICAgICAgICB0eXBlOiBwLnR5cGVOYW1lLFxuICAgICAgfTtcbiAgICB9KSB9LCAoKSA9PiB7fSk7XG4gIH0gZWxzZSB7XG4gICAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG4gICAgY29uc3QgcHJvcGVydGllcyA9IGZpZWxkc1xuICAgICAgLm1hcChmaWVsZCA9PiBwcm9wZXJ0eUZyb21GaWVsZChnZW5lcmF0b3IuY29udGV4dCwgZmllbGQpKVxuICAgICAgLmZpbHRlcihmaWVsZCA9PiBmaWVsZC5wcm9wZXJ0eU5hbWUgIT0gXCJfX3R5cGVuYW1lXCIpO1xuXG4gICAgY2FzZUNsYXNzRGVjbGFyYXRpb24oZ2VuZXJhdG9yLCB7IGNhc2VDbGFzc05hbWUsIHBhcmFtczogcHJvcGVydGllcy5tYXAocCA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiBwLnJlc3BvbnNlTmFtZSxcbiAgICAgICAgdHlwZTogcC50eXBlTmFtZSxcbiAgICAgIH07XG4gICAgfSksIHN1cGVyY2xhc3M6ICdtZS5zaGFkYWouc2xpbmt5LmNvcmUuV2l0aFJhdyd9LCAoKSA9PiB7XG4gICAgICBpZiAoaW5saW5lRnJhZ21lbnRzICYmIGlubGluZUZyYWdtZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGlubGluZUZyYWdtZW50cy5mb3JFYWNoKChpbmxpbmVGcmFnbWVudCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZyYWdDbGFzcyA9IGNhc2VDbGFzc05hbWVGb3JJbmxpbmVGcmFnbWVudChpbmxpbmVGcmFnbWVudCk7XG4gICAgICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBkZWYgYXMke2lubGluZUZyYWdtZW50LnR5cGVDb25kaXRpb259YCk7XG4gICAgICAgICAgZ2VuZXJhdG9yLnByaW50KGA6IE9wdGlvblske2ZyYWdDbGFzc31dID1gKTtcbiAgICAgICAgICBnZW5lcmF0b3Iud2l0aGluQmxvY2soKCkgPT4ge1xuICAgICAgICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBpZiAoJHtmcmFnQ2xhc3N9LnBvc3NpYmxlVHlwZXMuY29udGFpbnModGhpcy5yYXcuX190eXBlbmFtZS5hc0luc3RhbmNlT2ZbU3RyaW5nXSkpIFNvbWUoaW1wbGljaXRseVttZS5zaGFkYWouc2xpbmt5LmNvcmUuUmVhZGVyWyR7ZnJhZ0NsYXNzfV1dLnJlYWQodGhpcy5yYXcpKSBlbHNlIE5vbmVgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChmcmFnbWVudFNwcmVhZHMpIHtcbiAgICAgICAgZnJhZ21lbnRTcHJlYWRzLmZvckVhY2gocyA9PiB7XG4gICAgICAgICAgY29uc3QgZnJhZ21lbnQgPSBnZW5lcmF0b3IuY29udGV4dC5mcmFnbWVudHNbc107XG4gICAgICAgICAgY29uc3QgYWx3YXlzRGVmaW5lZCA9IGlzVHlwZVByb3BlclN1cGVyVHlwZU9mKGdlbmVyYXRvci5jb250ZXh0LnNjaGVtYSwgZnJhZ21lbnQudHlwZUNvbmRpdGlvbiwgcGFyZW50VHlwZSk7XG4gICAgICAgICAgaWYgKCFhbHdheXNEZWZpbmVkKSB7XG4gICAgICAgICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYGRlZiBhcyR7c31gKTtcbiAgICAgICAgICAgIGdlbmVyYXRvci5wcmludChgOiBPcHRpb25bJHtzfV0gPWApO1xuICAgICAgICAgICAgZ2VuZXJhdG9yLndpdGhpbkJsb2NrKCgpID0+IHtcbiAgICAgICAgICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGBpZiAoJHtzfS5wb3NzaWJsZVR5cGVzLmNvbnRhaW5zKHRoaXMucmF3Ll9fdHlwZW5hbWUuYXNJbnN0YW5jZU9mW1N0cmluZ10pKSBTb21lKGltcGxpY2l0bHlbbWUuc2hhZGFqLnNsaW5reS5jb3JlLlJlYWRlclske3N9XV0ucmVhZCh0aGlzLnJhdykpIGVsc2UgTm9uZWApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gYWRkIHR5cGVzIGFuZCBpbXBsaWNpdCBjb252ZXJzaW9uc1xuICAgIGlmIChpbmxpbmVGcmFnbWVudHMgJiYgaW5saW5lRnJhZ21lbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgIGlubGluZUZyYWdtZW50cy5mb3JFYWNoKChpbmxpbmVGcmFnbWVudCkgPT4ge1xuICAgICAgICBjYXNlQ2xhc3NEZWNsYXJhdGlvbkZvclNlbGVjdGlvblNldChcbiAgICAgICAgICBnZW5lcmF0b3IsXG4gICAgICAgICAge1xuICAgICAgICAgICAgY2FzZUNsYXNzTmFtZTogY2FzZUNsYXNzTmFtZUZvcklubGluZUZyYWdtZW50KGlubGluZUZyYWdtZW50KSxcbiAgICAgICAgICAgIHBhcmVudFR5cGU6IGlubGluZUZyYWdtZW50LnR5cGVDb25kaXRpb24sXG4gICAgICAgICAgICBmaWVsZHM6IGlubGluZUZyYWdtZW50LmZpZWxkcyxcbiAgICAgICAgICAgIGlubGluZUZyYWdtZW50czogaW5saW5lRnJhZ21lbnQuaW5saW5lRnJhZ21lbnRzLFxuICAgICAgICAgICAgZnJhZ21lbnRTcHJlYWRzOiBpbmxpbmVGcmFnbWVudC5mcmFnbWVudFNwcmVhZHMsXG4gICAgICAgICAgICB2aWV3YWJsZUFzOiB7XG4gICAgICAgICAgICAgIGNhc2VDbGFzc05hbWUsXG4gICAgICAgICAgICAgIHByb3BlcnRpZXMsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9iamVjdERlY2xhcmF0aW9uKGdlbmVyYXRvciwgeyBvYmplY3ROYW1lOiBjYXNlQ2xhc3NOYW1lIH0sICgpID0+IHtcbiAgICBpZiAocG9zc2libGVUeXBlcykge1xuICAgICAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoJ3ZhbCBwb3NzaWJsZVR5cGVzID0gc2NhbGEuY29sbGVjdGlvbi5TZXQoJyk7XG4gICAgICBnZW5lcmF0b3IucHJpbnQoam9pbihwb3NzaWJsZVR5cGVzLm1hcCh0eXBlID0+IGBcIiR7U3RyaW5nKHR5cGUpfVwiYCksICcsICcpKTtcbiAgICAgIGdlbmVyYXRvci5wcmludCgnKScpO1xuICAgIH1cblxuICAgIGlmICh2aWV3YWJsZUFzKSB7XG4gICAgICBnZW5lcmF0b3IucHJpbnRPbk5ld2xpbmUoYGltcGxpY2l0IGRlZiB0byR7dmlld2FibGVBcy5jYXNlQ2xhc3NOYW1lfShhOiAke2Nhc2VDbGFzc05hbWV9KTogJHt2aWV3YWJsZUFzLmNhc2VDbGFzc05hbWV9ID0gJHt2aWV3YWJsZUFzLmNhc2VDbGFzc05hbWV9KCR7dmlld2FibGVBcy5wcm9wZXJ0aWVzLm1hcChwID0+IFwiYS5cIiArIHAucmVzcG9uc2VOYW1lKS5qb2luKCcsICcpfSlgKTtcbiAgICB9XG5cbiAgICBpZiAoZnJhZ21lbnRTcHJlYWRzKSB7XG4gICAgICBmcmFnbWVudFNwcmVhZHMuZm9yRWFjaChzID0+IHtcbiAgICAgICAgY29uc3QgZnJhZ21lbnQgPSBnZW5lcmF0b3IuY29udGV4dC5mcmFnbWVudHNbc107XG4gICAgICAgIGNvbnN0IGFsd2F5c0RlZmluZWQgPSBpc1R5cGVQcm9wZXJTdXBlclR5cGVPZihnZW5lcmF0b3IuY29udGV4dC5zY2hlbWEsIGZyYWdtZW50LnR5cGVDb25kaXRpb24sIHBhcmVudFR5cGUpO1xuICAgICAgICBpZiAoYWx3YXlzRGVmaW5lZCkge1xuICAgICAgICAgIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgaW1wbGljaXQgZGVmIHRvJHtzfShhOiAke2Nhc2VDbGFzc05hbWV9KTogJHtzfSA9ICR7c30oJHsoZnJhZ21lbnQuZmllbGRzIHx8IFtdKS5tYXAocCA9PiBcImEuXCIgKyBwLnJlc3BvbnNlTmFtZSkuam9pbignLCAnKX0pYCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYgKG9iamVjdENsb3N1cmUpIHtcbiAgICAgIG9iamVjdENsb3N1cmUoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGZpZWxkcy5maWx0ZXIoZmllbGQgPT4gaXNDb21wb3NpdGVUeXBlKGdldE5hbWVkVHlwZShmaWVsZC50eXBlKSkpLmZvckVhY2goZmllbGQgPT4ge1xuICAgIGNhc2VDbGFzc0RlY2xhcmF0aW9uRm9yU2VsZWN0aW9uU2V0KFxuICAgICAgZ2VuZXJhdG9yLFxuICAgICAge1xuICAgICAgICBjYXNlQ2xhc3NOYW1lOiBjYXNlQ2xhc3NOYW1lRm9yUHJvcGVydHlOYW1lKGZpZWxkLnJlc3BvbnNlTmFtZSksXG4gICAgICAgIHBhcmVudFR5cGU6IGdldE5hbWVkVHlwZShmaWVsZC50eXBlKSxcbiAgICAgICAgZmllbGRzOiBmaWVsZC5maWVsZHMsXG4gICAgICAgIGlubGluZUZyYWdtZW50czogZmllbGQuaW5saW5lRnJhZ21lbnRzLFxuICAgICAgICBmcmFnbWVudFNwcmVhZHM6IGZpZWxkLmZyYWdtZW50U3ByZWFkc1xuICAgICAgfVxuICAgICk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBvcGVyYXRpb25JZGVudGlmaWVyKGdlbmVyYXRvciwgIHsgb3BlcmF0aW9uTmFtZSwgc291cmNlV2l0aEZyYWdtZW50cywgb3BlcmF0aW9uSWQgfSkge1xuICBpZiAoIWdlbmVyYXRvci5jb250ZXh0LmdlbmVyYXRlT3BlcmF0aW9uSWRzKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICBnZW5lcmF0b3IucHJpbnROZXdsaW5lSWZOZWVkZWQoKTtcbiAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGB2YWwgb3BlcmF0aW9uSWRlbnRpZmllcjogU3RyaW5nID0gXCIke29wZXJhdGlvbklkfVwiYCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0eXBlRGVjbGFyYXRpb25Gb3JHcmFwaFFMVHlwZShnZW5lcmF0b3IsIHR5cGUpIHtcbiAgaWYgKHR5cGUgaW5zdGFuY2VvZiBHcmFwaFFMRW51bVR5cGUpIHtcbiAgICBlbnVtZXJhdGlvbkRlY2xhcmF0aW9uKGdlbmVyYXRvciwgdHlwZSk7XG4gIH0gZWxzZSBpZiAodHlwZSBpbnN0YW5jZW9mIEdyYXBoUUxJbnB1dE9iamVjdFR5cGUpIHtcbiAgICBjYXNlQ2xhc3NEZWNsYXJhdGlvbkZvcklucHV0T2JqZWN0VHlwZShnZW5lcmF0b3IsIHR5cGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGVudW1lcmF0aW9uRGVjbGFyYXRpb24oZ2VuZXJhdG9yLCB0eXBlKSB7XG4gIGNvbnN0IHsgbmFtZSwgZGVzY3JpcHRpb24gfSA9IHR5cGU7XG4gIGNvbnN0IHZhbHVlcyA9IHR5cGUuZ2V0VmFsdWVzKCk7XG5cbiAgZ2VuZXJhdG9yLnByaW50TmV3bGluZUlmTmVlZGVkKCk7XG4gIGNvbW1lbnQoZ2VuZXJhdG9yLCBkZXNjcmlwdGlvbik7XG4gIGdlbmVyYXRvci5wcmludE9uTmV3bGluZShgb2JqZWN0ICR7bmFtZX1gKTtcbiAgZ2VuZXJhdG9yLndpdGhpbkJsb2NrKCgpID0+IHtcbiAgICB2YWx1ZXMuZm9yRWFjaCh2YWx1ZSA9PiB7XG4gICAgICBjb21tZW50KGdlbmVyYXRvciwgdmFsdWUuZGVzY3JpcHRpb24pO1xuICAgICAgZ2VuZXJhdG9yLnByaW50T25OZXdsaW5lKGB2YWwgJHtlc2NhcGVJZGVudGlmaWVySWZOZWVkZWQoZW51bUNhc2VOYW1lKHZhbHVlLm5hbWUpKX0gPSBcIiR7dmFsdWUudmFsdWV9XCJgKTtcbiAgICB9KTtcbiAgfSk7XG4gIGdlbmVyYXRvci5wcmludE5ld2xpbmUoKTtcbn1cblxuZnVuY3Rpb24gY2FzZUNsYXNzRGVjbGFyYXRpb25Gb3JJbnB1dE9iamVjdFR5cGUoZ2VuZXJhdG9yLCB0eXBlKSB7XG4gIGNvbnN0IHsgbmFtZTogY2FzZUNsYXNzTmFtZSwgZGVzY3JpcHRpb24gfSA9IHR5cGU7XG4gIGNvbnN0IGZpZWxkcyA9IE9iamVjdC52YWx1ZXModHlwZS5nZXRGaWVsZHMoKSk7XG4gIGNvbnN0IHByb3BlcnRpZXMgPSBmaWVsZHMubWFwKGZpZWxkID0+IHByb3BlcnR5RnJvbUZpZWxkKGdlbmVyYXRvci5jb250ZXh0LCBmaWVsZCkpO1xuXG4gIGNhc2VDbGFzc0RlY2xhcmF0aW9uKGdlbmVyYXRvciwgeyBjYXNlQ2xhc3NOYW1lLCBkZXNjcmlwdGlvbiwgcGFyYW1zOiBwcm9wZXJ0aWVzLm1hcChwID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogcC5wcm9wZXJ0eU5hbWUsXG4gICAgICB0eXBlOiBwLnR5cGVOYW1lXG4gICAgfTtcbiAgfSl9LCAoKSA9PiB7fSk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9